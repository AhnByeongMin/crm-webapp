<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚´ ì˜ˆì•½ ê´€ë¦¬</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }

        /* í•„í„° ì˜ì—­ */
        .filter-section { margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 4px; display: flex; align-items: center; gap: 20px; }
        .filter-section label { display: flex; align-items: center; gap: 8px; cursor: pointer; }

        /* ë²„íŠ¼ */
        .btn-primary { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .btn-primary:hover { background: #0056b3; }
        .btn-success { padding: 6px 12px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .btn-success:hover { background: #218838; }
        .btn-danger { padding: 6px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .btn-danger:hover { background: #c82333; }
        .btn-secondary { padding: 6px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .btn-secondary:hover { background: #5a6268; }

        /* ì˜ˆì•½ ì¹´ë“œ */
        .reminders-grid { display: grid; gap: 15px; margin-top: 20px; }
        .reminder-card { background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px; transition: all 0.3s; position: relative; }
        .reminder-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateY(-2px); }
        .reminder-card.completed { opacity: 0.6; background: #f8f9fa; }
        .reminder-card.today { border-left: 4px solid #dc3545; background: #fff5f5; }
        .reminder-card.upcoming { border-left: 4px solid #ffc107; background: #fffbf0; }
        .reminder-card.past { border-left: 4px solid #6c757d; }

        .reminder-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; }
        .reminder-title { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 8px; }
        .reminder-datetime { display: flex; align-items: center; gap: 8px; color: #666; font-size: 14px; margin-bottom: 8px; }
        .reminder-content { color: #666; line-height: 1.5; margin-bottom: 15px; }
        .reminder-actions { display: flex; gap: 8px; }

        .badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .badge-today { background: #dc3545; color: white; }
        .badge-upcoming { background: #ffc107; color: #000; }
        .badge-past { background: #6c757d; color: white; }
        .badge-completed { background: #28a745; color: white; }

        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .empty-state-icon { font-size: 64px; margin-bottom: 20px; }

        /* ëª¨ë‹¬ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-box { background: white; border-radius: 8px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
        .modal-title { font-size: 20px; font-weight: bold; margin-bottom: 20px; color: #333; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-group input, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }

        /* í† ìŠ¤íŠ¸ */
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; max-width: 350px; }
        .toast { background: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); transform: translateX(400px); animation: slideIn 0.3s forwards; border-left: 4px solid #667eea; }
        .toast.slide-out { animation: slideOut 0.3s forwards; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(400px); opacity: 0; } }

        /* ì•Œë¦¼ ë°°ë„ˆ */
        .alert-banner { padding: 15px; border-radius: 4px; margin-bottom: 20px; display: flex; align-items: center; gap: 12px; }
        .alert-banner.info { background: #d1ecf1; border-left: 4px solid #0c5460; color: #0c5460; }
        .alert-banner.warning { background: #fff3cd; border-left: 4px solid #856404; color: #856404; }
        .alert-banner.danger { background: #f8d7da; border-left: 4px solid #721c24; color: #721c24; }

        /* ë„ì›€ë§ ë²„íŠ¼ */
        .help-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            z-index: 9997;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .help-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
        }
        .help-button:active {
            transform: scale(0.95);
        }

        /* ë„ì›€ë§ ëª¨ë‹¬ */
        .help-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10001;
            align-items: center;
            justify-content: center;
        }
        .help-modal.active {
            display: flex;
        }
        .help-modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            animation: slideUpModal 0.3s ease-out;
        }
        @keyframes slideUpModal {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .help-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }
        .help-modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .help-modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #999;
            cursor: pointer;
            transition: color 0.2s;
        }
        .help-modal-close:hover {
            color: #333;
        }
        .help-section {
            margin-bottom: 25px;
        }
        .help-section-title {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .help-content {
            color: #555;
            line-height: 1.8;
            font-size: 15px;
        }
        .help-content ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        .help-content li {
            margin: 8px 0;
        }
        .help-content strong {
            color: #333;
            font-weight: 600;
        }
        .help-tip {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 12px 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        .help-tip strong {
            color: #667eea;
        }
    </style>
    <script src="/static/js/banner.js" defer></script>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>

    <div class="container">
        {% include 'includes/header.html' %}

        <div class="filter-section">
            <button class="btn-primary" onclick="openAddModal()">+ ìƒˆ ì˜ˆì•½ ì¶”ê°€</button>
            <label>
                <input type="checkbox" id="showCompleted" onchange="loadReminders()">
                <span>ì™„ë£Œëœ í•­ëª© ë³´ê¸°</span>
            </label>
            <div style="display: flex; gap: 10px; align-items: center; margin-left: auto;">
                <input type="date" id="filterStartDate" onchange="loadReminders()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <span>~</span>
                <input type="date" id="filterEndDate" onchange="loadReminders()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <input type="text" id="searchKeyword" placeholder="ê²€ìƒ‰..." onkeyup="loadReminders()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 200px;">
                <div id="statsInfo" style="color: #666; font-size: 14px; white-space: nowrap;"></div>
            </div>
        </div>

        <div id="alertBanners"></div>

        <div id="remindersContainer">
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ“…</div>
                <p>ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤</p>
            </div>
        </div>
    </div>

    <!-- ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
    <div class="modal-overlay" id="reminderModal">
        <div class="modal-box">
            <div class="modal-title" id="modalTitle">ìƒˆ ì˜ˆì•½ ì¶”ê°€</div>
            <div id="privacyWarning" style="display: none; background: #fff3cd; border: 1px solid #ffc107; padding: 12px; border-radius: 4px; margin-bottom: 15px;">
                <strong style="color: #856404;">âš ï¸ ê°œì¸ì •ë³´ ë³´í˜¸ ì•ˆë‚´</strong>
                <p style="color: #856404; margin: 8px 0 0 0; font-size: 13px;">ì „í™”ë²ˆí˜¸ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ê°œì¸ì •ë³´ ë³´í˜¸ë¥¼ ìœ„í•´ ì „í™”ë²ˆí˜¸ ëŒ€ì‹  <strong>ìƒë‹´ë²ˆí˜¸, ê³ ê°ë²ˆí˜¸, ë˜ëŠ” ì´ë¦„</strong>ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.</p>
            </div>
            <div class="form-group">
                <label>ì œëª© *</label>
                <input type="text" id="reminderTitle" placeholder="ì˜ˆ: CO2511082391109 ìƒë‹´, CU12215795 í™ê¸¸ë™" oninput="checkPrivacy()">
                <small style="color: #666; font-size: 12px;">ê¶Œì¥: ìƒë‹´ë²ˆí˜¸(COë¡œ ì‹œì‘), ê³ ê°ë²ˆí˜¸(CUë¡œ ì‹œì‘), ì´ë¦„ ë“±</small>
            </div>
            <div class="form-group">
                <label>ë‚´ìš©</label>
                <textarea id="reminderContent" placeholder="ì˜ˆì•½ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒì‚¬í•­)" oninput="checkPrivacy()"></textarea>
            </div>
            <div class="form-group">
                <label>ë‚ ì§œ *</label>
                <input type="date" id="reminderDate">
            </div>
            <div class="form-group">
                <label>ì‹œê°„ *</label>
                <input type="time" id="reminderTime">
            </div>
            <div class="modal-buttons">
                <button class="btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="btn-primary" id="saveBtn" onclick="saveReminder()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <script>
        let currentEditingId = null;
        let notificationPermission = false;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
        document.addEventListener('DOMContentLoaded', () => {
            requestNotificationPermission();
            loadReminders();
            startNotificationChecker();
        });

        // ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
        async function requestNotificationPermission() {
            if ('Notification' in window) {
                const permission = await Notification.requestPermission();
                notificationPermission = permission === 'granted';
            }
        }

        // ìƒë‹´ì£¼ë¬¸ë²ˆí˜¸ ì˜ˆì™¸ íŒ¨í„´ (ì˜ˆ: CO2511111669339)
        function isExceptionOrderNumber(text) {
            const orderPattern = /[A-Za-z]{2}\d{8,}/; 
            return orderPattern.test(text);
        }


        // ì „í™”ë²ˆí˜¸ íŒ¨í„´ ê°ì§€ (010-1234-5678, 01012345678, 010 1234 5678 ë“±)
        function detectPhoneNumber(text) {

                // 1) ìƒë‹´ì£¼ë¬¸ë²ˆí˜¸ ì˜ˆì™¸ ë¨¼ì € ì²´í¬
            if (isExceptionOrderNumber(text)) {
                return false;
            }

            const patterns = [
                /01[016789]-?\d{3,4}-?\d{4}/g,  // 010-1234-5678 ë˜ëŠ” 01012345678
                /01[016789]\s?\d{3,4}\s?\d{4}/g, // 010 1234 5678
                /\d{3}-\d{3,4}-\d{4}/g,           // ì¼ë°˜ ì „í™”ë²ˆí˜¸
                /\d{10,11}/g                      // ì—°ì†ëœ 10-11ìë¦¬ ìˆ«ì
            ];

            for (let pattern of patterns) {
                if (pattern.test(text)) {
                    return true;
                }
            }
            return false;
        }

        // ê°œì¸ì •ë³´ ì²´í¬
        function checkPrivacy() {
            const title = document.getElementById('reminderTitle').value;
            const content = document.getElementById('reminderContent').value;
            const warning = document.getElementById('privacyWarning');
            const saveBtn = document.getElementById('saveBtn');

            const hasPhoneNumber = detectPhoneNumber(title) || detectPhoneNumber(content);

            if (hasPhoneNumber) {
                warning.style.display = 'block';
                saveBtn.disabled = true;
                saveBtn.style.opacity = '0.5';
                saveBtn.style.cursor = 'not-allowed';
            } else {
                warning.style.display = 'none';
                saveBtn.disabled = false;
                saveBtn.style.opacity = '1';
                saveBtn.style.cursor = 'pointer';
            }
        }

        // ì˜ˆì•½ ëª©ë¡ ë¡œë“œ
        async function loadReminders() {
            const showCompleted = document.getElementById('showCompleted').checked;
            const response = await fetch(`/api/reminders?show_completed=${showCompleted}`);
            let reminders = await response.json();

            // ë‚ ì§œ í•„í„°ë§
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            const keyword = document.getElementById('searchKeyword').value.toLowerCase();

            if (startDate) {
                reminders = reminders.filter(r => r.scheduled_date >= startDate);
            }
            if (endDate) {
                reminders = reminders.filter(r => r.scheduled_date <= endDate);
            }
            if (keyword) {
                reminders = reminders.filter(r =>
                    r.title.toLowerCase().includes(keyword) ||
                    (r.content && r.content.toLowerCase().includes(keyword))
                );
            }

            renderReminders(reminders);
            updateStats(reminders);
            updateAlertBanners(reminders);
        }

        // ì˜ˆì•½ ëª©ë¡ ë Œë”ë§
        function renderReminders(reminders) {
            const container = document.getElementById('remindersContainer');

            if (reminders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“…</div>
                        <p>ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤</p>
                    </div>
                `;
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            const now = new Date();

            // ë¶„ë¥˜: ë‹¹ì¼, ë‹¤ê°€ì˜¤ëŠ” ì˜ˆì•½, ì§€ë‚œ ì˜ˆì•½
            const todayReminders = [];
            const upcomingReminders = [];
            const pastReminders = [];

            reminders.forEach(r => {
                const reminderDate = r.scheduled_date;
                const reminderDateTime = new Date(`${r.scheduled_date}T${r.scheduled_time}`);

                if (reminderDate === today) {
                    todayReminders.push(r);
                } else if (reminderDateTime > now) {
                    upcomingReminders.push(r);
                } else {
                    pastReminders.push(r);
                }
            });

            let html = '<div class="reminders-grid">';

            // ë‹¹ì¼ ì˜ˆì•½ (í•­ìƒ ìµœìƒë‹¨)
            if (todayReminders.length > 0) {
                todayReminders.forEach(r => {
                    html += renderReminderCard(r, 'today');
                });
            }

            // ë‹¤ê°€ì˜¤ëŠ” ì˜ˆì•½
            upcomingReminders.forEach(r => {
                html += renderReminderCard(r, 'upcoming');
            });

            // ì§€ë‚œ ì˜ˆì•½
            pastReminders.forEach(r => {
                html += renderReminderCard(r, 'past');
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // ì˜ˆì•½ ì¹´ë“œ ë Œë”ë§
        function renderReminderCard(reminder, type) {
            const completed = reminder.is_completed === 1;
            const completedClass = completed ? 'completed' : '';

            let badge = '';
            if (type === 'today') badge = '<span class="badge badge-today">ğŸ”´ ì˜¤ëŠ˜</span>';
            else if (type === 'upcoming') badge = '<span class="badge badge-upcoming">â° ì˜ˆì •</span>';
            else if (type === 'past') badge = '<span class="badge badge-past">ğŸ“‹ ì§€ë‚¨</span>';

            if (completed) badge = '<span class="badge badge-completed">âœ… ì™„ë£Œ</span>';

            return `
                <div class="reminder-card ${type} ${completedClass}">
                    <div class="reminder-header">
                        <div>
                            <div class="reminder-title">${escapeHtml(reminder.title)}</div>
                            <div class="reminder-datetime">
                                ğŸ“… ${reminder.scheduled_date} ${reminder.scheduled_time}
                                ${badge}
                            </div>
                        </div>
                    </div>
                    ${reminder.content ? `<div class="reminder-content">${escapeHtml(reminder.content)}</div>` : ''}
                    <div class="reminder-actions">
                        <button class="btn-success" onclick="toggleComplete(${reminder.id})">
                            ${completed ? 'ë¯¸ì™„ë£Œë¡œ ë³€ê²½' : 'ì™„ë£Œ ì²˜ë¦¬'}
                        </button>
                        <button class="btn-secondary" onclick="openEditModal(${reminder.id})">ìˆ˜ì •</button>
                        <button class="btn-danger" onclick="deleteReminder(${reminder.id})">ì‚­ì œ</button>
                    </div>
                </div>
            `;
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats(reminders) {
            const total = reminders.length;
            const completed = reminders.filter(r => r.is_completed === 1).length;
            const pending = total - completed;

            document.getElementById('statsInfo').innerHTML = `
                ì „ì²´ ${total}ê±´ | ë¯¸ì™„ë£Œ ${pending}ê±´ | ì™„ë£Œ ${completed}ê±´
            `;
        }

        // ì•Œë¦¼ ë°°ë„ˆ ì—…ë°ì´íŠ¸
        function updateAlertBanners(reminders) {
            const container = document.getElementById('alertBanners');
            const today = new Date().toISOString().split('T')[0];
            const now = new Date();

            const todayReminders = reminders.filter(r => r.scheduled_date === today && r.is_completed === 0);
            const pastReminders = reminders.filter(r => {
                const reminderDateTime = new Date(`${r.scheduled_date}T${r.scheduled_time}`);
                return reminderDateTime < now && r.is_completed === 0 && r.scheduled_date !== today;
            });

            let html = '';

            if (todayReminders.length > 0) {
                html += `
                    <div class="alert-banner danger">
                        <strong>ğŸ”´ ì˜¤ëŠ˜ ì˜ˆì•½ ${todayReminders.length}ê±´</strong>ì´ ìˆìŠµë‹ˆë‹¤!
                    </div>
                `;
            }

            if (pastReminders.length > 0) {
                html += `
                    <div class="alert-banner warning">
                        <strong>âš ï¸ ì§€ë‚œ ì˜ˆì•½ ${pastReminders.length}ê±´</strong>ì´ ë¯¸ì™„ë£Œ ìƒíƒœì…ë‹ˆë‹¤.
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // 30ë¶„ ì „ ì•Œë¦¼ ì²´í¬ (1ë¶„ë§ˆë‹¤)
        function startNotificationChecker() {
            setInterval(async () => {
                const response = await fetch('/api/reminders/notifications');
                const reminders = await response.json();

                const now = new Date();

                reminders.forEach(r => {
                    const reminderDateTime = new Date(`${r.scheduled_date}T${r.scheduled_time}`);
                    const diff = (reminderDateTime - now) / (1000 * 60); // ë¶„ ë‹¨ìœ„

                    // 30ë¶„ ì „ ~ 25ë¶„ ì „ ì‚¬ì´ì— ì•Œë¦¼
                    if (diff <= 30 && diff >= 25) {
                        showNotification(r);
                        // ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ í‘œì‹œ
                        fetch(`/api/reminders/${r.id}/notify`, { method: 'POST' });
                    }
                });
            }, 60000); // 1ë¶„ë§ˆë‹¤ ì²´í¬
        }

        // ë¸Œë¼ìš°ì € ì•Œë¦¼ í‘œì‹œ
        function showNotification(reminder) {
            const title = `ğŸ”” ${reminder.title}`;
            const body = `${reminder.scheduled_time}ì— ì˜ˆì •ëœ ì¼ì •ì´ 30ë¶„ í›„ ì‹œì‘ë©ë‹ˆë‹¤.`;

            if (notificationPermission) {
                new Notification(title, { body, icon: '/static/icon-192.png' });
            }

            showToast(title, body);
        }

        // ëª¨ë‹¬ ì—´ê¸° (ì¶”ê°€)
        function openAddModal() {
            currentEditingId = null;
            document.getElementById('modalTitle').textContent = 'ìƒˆ ì˜ˆì•½ ì¶”ê°€';
            document.getElementById('reminderTitle').value = '';
            document.getElementById('reminderContent').value = '';
            document.getElementById('reminderDate').value = '';
            document.getElementById('reminderTime').value = '';

            // ê²½ê³  ìˆ¨ê¹€ ë° ë²„íŠ¼ í™œì„±í™”
            document.getElementById('privacyWarning').style.display = 'none';
            document.getElementById('saveBtn').disabled = false;
            document.getElementById('saveBtn').style.opacity = '1';
            document.getElementById('saveBtn').style.cursor = 'pointer';

            document.getElementById('reminderModal').classList.add('active');
        }

        // ëª¨ë‹¬ ì—´ê¸° (ìˆ˜ì •)
        async function openEditModal(id) {
            const response = await fetch(`/api/reminders?show_completed=true`);
            const reminders = await response.json();
            const reminder = reminders.find(r => r.id === id);

            if (!reminder) return;

            currentEditingId = id;
            document.getElementById('modalTitle').textContent = 'ì˜ˆì•½ ìˆ˜ì •';
            document.getElementById('reminderTitle').value = reminder.title;
            document.getElementById('reminderContent').value = reminder.content || '';
            document.getElementById('reminderDate').value = reminder.scheduled_date;
            document.getElementById('reminderTime').value = reminder.scheduled_time;

            // ê°œì¸ì •ë³´ ì²´í¬
            checkPrivacy();

            document.getElementById('reminderModal').classList.add('active');
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal() {
            document.getElementById('reminderModal').classList.remove('active');

            // ê²½ê³  ì´ˆê¸°í™”
            document.getElementById('privacyWarning').style.display = 'none';
            document.getElementById('saveBtn').disabled = false;
            document.getElementById('saveBtn').style.opacity = '1';
            document.getElementById('saveBtn').style.cursor = 'pointer';
        }

        // ì˜ˆì•½ ì €ì¥
        async function saveReminder() {
            const title = document.getElementById('reminderTitle').value.trim();
            const content = document.getElementById('reminderContent').value.trim();
            const date = document.getElementById('reminderDate').value;
            const time = document.getElementById('reminderTime').value;

            if (!title || !date || !time) {
                alert('ì œëª©, ë‚ ì§œ, ì‹œê°„ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.');
                return;
            }

            // ìµœì¢… ê°œì¸ì •ë³´ ê²€ì¦
            if (detectPhoneNumber(title) || detectPhoneNumber(content)) {
                alert('ê°œì¸ì •ë³´ ë³´í˜¸ë¥¼ ìœ„í•´ ì „í™”ë²ˆí˜¸ë¥¼ í¬í•¨í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n\nìƒë‹´ì£¼ë¬¸ë²ˆí˜¸, ê³ ê°ë²ˆí˜¸, ë˜ëŠ” ì´ë¦„ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
                return;
            }

            const data = {
                title,
                content,
                scheduled_date: date,
                scheduled_time: time
            };

            let response;
            if (currentEditingId) {
                response = await fetch(`/api/reminders/${currentEditingId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } else {
                response = await fetch('/api/reminders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            }

            if (response.ok) {
                showToast('ì„±ê³µ', currentEditingId ? 'ì˜ˆì•½ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì˜ˆì•½ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeModal();
                loadReminders();
            } else {
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì™„ë£Œ ìƒíƒœ í† ê¸€
        async function toggleComplete(id) {
            const response = await fetch(`/api/reminders/${id}/complete`, { method: 'PATCH' });
            if (response.ok) {
                showToast('ì„±ê³µ', 'ì™„ë£Œ ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadReminders();
            }
        }

        // ì˜ˆì•½ ì‚­ì œ
        async function deleteReminder(id) {
            if (!confirm('ì´ ì˜ˆì•½ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            const response = await fetch(`/api/reminders/${id}`, { method: 'DELETE' });
            if (response.ok) {
                showToast('ì„±ê³µ', 'ì˜ˆì•½ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadReminders();
            }
        }

        // í† ìŠ¤íŠ¸ ì•Œë¦¼
        function showToast(title, message) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <div style="flex: 1;">
                    <div style="font-weight: bold; margin-bottom: 4px;">${escapeHtml(title)}</div>
                    <div style="font-size: 13px; color: #666;">${escapeHtml(message)}</div>
                </div>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('slide-out');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // HTML ì´ìŠ¤ì¼€ì´í”„
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ë„ì›€ë§ ëª¨ë‹¬ ì œì–´
        function openHelpModal() {
            document.getElementById('helpModal').classList.add('active');
        }

        function closeHelpModal() {
            document.getElementById('helpModal').classList.remove('active');
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.addEventListener('DOMContentLoaded', () => {
            const helpModal = document.getElementById('helpModal');
            if (helpModal) {
                helpModal.addEventListener('click', (e) => {
                    if (e.target === helpModal) {
                        closeHelpModal();
                    }
                });
            }
        });

    </script>

    <!-- ë„ì›€ë§ ë²„íŠ¼ -->
    <button class="help-button" onclick="openHelpModal()" title="ì‚¬ìš©ë²• ë„ì›€ë§">
        â“
    </button>

    <!-- ë„ì›€ë§ ëª¨ë‹¬ -->
    <div class="help-modal" id="helpModal">
        <div class="help-modal-content">
            <div class="help-modal-header">
                <div class="help-modal-title">
                    ğŸ“– ë‚´ ì˜ˆì•½ ê´€ë¦¬ ì‚¬ìš©ë²•
                </div>
                <button class="help-modal-close" onclick="closeHelpModal()">&times;</button>
            </div>

            <div class="help-section">
                <div class="help-section-title">ğŸ“… ì˜ˆì•½ ì¶”ê°€í•˜ê¸°</div>
                <div class="help-content">
                    <ul>
                        <li><strong>"+ ìƒˆ ì˜ˆì•½ ì¶”ê°€"</strong> ë²„íŠ¼ì„ í´ë¦­í•©ë‹ˆë‹¤</li>
                        <li><strong>ì œëª©</strong>: ìƒë‹´í˜¸(CO), ê³ ê°ë²ˆí˜¸(CU), ì´ë¦„ ë“±ì„ ì…ë ¥</li>
                        <li><strong>ë‚´ìš©</strong>: ì˜ˆì•½ ìƒì„¸ ë‚´ìš© (ì„ íƒì‚¬í•­)</li>
                        <li><strong>ë‚ ì§œ/ì‹œê°„</strong>: ì˜ˆì•½ ì¼ì‹œë¥¼ ì„¤ì •í•©ë‹ˆë‹¤</li>
                        <li><strong>ê°œì¸ì •ë³´ ë³´í˜¸</strong>: ì „í™”ë²ˆí˜¸ ì…ë ¥ ì‹œ ì €ì¥ì´ ì°¨ë‹¨ë©ë‹ˆë‹¤</li>
                    </ul>
                </div>
            </div>

            <div class="help-section">
                <div class="help-section-title">ğŸ” ì˜ˆì•½ ê²€ìƒ‰ ë° í•„í„°</div>
                <div class="help-content">
                    <ul>
                        <li><strong>ë‚ ì§œ ë²”ìœ„</strong>: ì‹œì‘ì¼~ì¢…ë£Œì¼ë¡œ ê¸°ê°„ í•„í„°ë§</li>
                        <li><strong>ê²€ìƒ‰ì°½</strong>: ì œëª©ì´ë‚˜ ë‚´ìš©ìœ¼ë¡œ ê²€ìƒ‰</li>
                        <li><strong>ì™„ë£Œëœ í•­ëª© ë³´ê¸°</strong>: ì²´í¬í•˜ë©´ ì™„ë£Œëœ ì˜ˆì•½ë„ í‘œì‹œ</li>
                        <li><strong>í†µê³„</strong>: ì „ì²´/ì™„ë£Œ/ë¯¸ì™„ë£Œ ì˜ˆì•½ ê°œìˆ˜ í™•ì¸</li>
                    </ul>
                </div>
            </div>

            <div class="help-section">
                <div class="help-section-title">ğŸ·ï¸ ì˜ˆì•½ ìƒíƒœ í‘œì‹œ</div>
                <div class="help-content">
                    <ul>
                        <li><strong style="color: #dc3545;">ë¹¨ê°„ìƒ‰ í…Œë‘ë¦¬ (ì˜¤ëŠ˜)</strong>: ì˜¤ëŠ˜ ì˜ˆì•½ëœ í•­ëª©</li>
                        <li><strong style="color: #ffc107;">ë…¸ë€ìƒ‰ í…Œë‘ë¦¬ (ì˜ˆì •)</strong>: ë¯¸ë˜ ì˜ˆì•½</li>
                        <li><strong style="color: #6c757d;">íšŒìƒ‰ í…Œë‘ë¦¬ (ì§€ë‚œ)</strong>: ì§€ë‚œ ì˜ˆì•½</li>
                        <li><strong style="color: #28a745;">ì´ˆë¡ìƒ‰ ë°°ì§€</strong>: ì™„ë£Œëœ ì˜ˆì•½</li>
                    </ul>
                </div>
            </div>

            <div class="help-section">
                <div class="help-section-title">ğŸ”” ì•Œë¦¼ ê¸°ëŠ¥</div>
                <div class="help-content">
                    <ul>
                        <li><strong>ë‹¹ì¼ ì˜ˆì•½ ì•Œë¦¼</strong>: ì˜¤ëŠ˜ ì˜ˆì•½ì´ ìˆìœ¼ë©´ ìƒë‹¨ ë°°ë„ˆ í‘œì‹œ</li>
                        <li><strong>ì„ë°• ì•Œë¦¼</strong>: 1ì‹œê°„ ì´ë‚´ ì˜ˆì•½ì€ ë³„ë„ ë°°ë„ˆ í‘œì‹œ</li>
                        <li><strong>ì§€ë‚œ ì˜ˆì•½ ì•Œë¦¼</strong>: ë¯¸ì™„ë£Œëœ ì§€ë‚œ ì˜ˆì•½ í™•ì¸</li>
                    </ul>
                </div>
            </div>

            <div class="help-tip">
                <strong>ğŸ’¡ ê°œì¸ì •ë³´ ë³´í˜¸:</strong> ì „í™”ë²ˆí˜¸ ëŒ€ì‹  ìƒë‹´ë²ˆí˜¸(CO), ê³ ê°ë²ˆí˜¸(CU), ë˜ëŠ” ì´ë¦„ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”. ì „í™”ë²ˆí˜¸ê°€ ê°ì§€ë˜ë©´ ì €ì¥ì´ ì°¨ë‹¨ë©ë‹ˆë‹¤.
            </div>
        </div>
    </div>

    {% include 'includes/today_reminders.html' %}
</body>
</html>
