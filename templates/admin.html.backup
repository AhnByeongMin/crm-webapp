<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì í˜ì´ì§€</title>

    <!-- PWA ë©”íƒ€ íƒœê·¸ -->
    <meta name="description" content="ê¸´ê¸‰ ìƒí™©ì„ ìœ„í•œ ì—…ë¬´ í• ë‹¹ ë° ì±„íŒ… ì‹œìŠ¤í…œ">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ì—…ë¬´ê´€ë¦¬">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icon-192.png">
    <link rel="apple-touch-icon" href="/static/icon-192.png">

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { margin-bottom: 30px; color: #333; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        textarea { min-height: 80px; resize: vertical; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-right: 10px; }
        button:hover { background: #0056b3; }
        button.delete { background: #dc3545; }
        button.delete:hover { background: #c82333; }
        button.edit { background: #28a745; }
        button.edit:hover { background: #218838; }
        table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f8f9fa; font-weight: bold; color: #333; }
        tr:hover { background: #f8f9fa; }
        .actions { white-space: nowrap; }
        #addForm { background: #f8f9fa; padding: 20px; border-radius: 4px; margin-bottom: 30px; }

        /* í† ìŠ¤íŠ¸ ì•Œë¦¼ */
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; max-width: 350px; }
        .toast { background: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer; transform: translateX(400px); animation: slideIn 0.3s forwards; border-left: 4px solid #667eea; display: flex; align-items: center; gap: 12px; }
        .toast:hover { box-shadow: 0 6px 16px rgba(0,0,0,0.4); transform: translateY(-2px); }
        .toast.slide-out { animation: slideOut 0.3s forwards; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(400px); opacity: 0; } }
        .toast-icon { font-size: 24px; flex-shrink: 0; }
        .toast-content { flex: 1; min-width: 0; }
        .toast-title { font-weight: bold; color: #333; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .toast-message { font-size: 13px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .toast-close { background: none; border: none; font-size: 20px; color: #999; cursor: pointer; padding: 0; width: 24px; height: 24px; flex-shrink: 0; }
        .toast-close:hover { color: #333; }

        /* PWA ì„¤ì¹˜ ë²„íŠ¼ */
        .install-btn { padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; display: none; font-size: 14px; }
        .install-btn:hover { background: #5568d3; }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-box { background: white; border-radius: 8px; padding: 30px; max-width: 400px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3); animation: modalSlideIn 0.3s; }
        @keyframes modalSlideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-title { font-size: 20px; font-weight: bold; margin-bottom: 15px; color: #333; }
        .modal-message { margin-bottom: 20px; color: #666; line-height: 1.5; }
        .modal-input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; margin-bottom: 20px; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; }
        .modal-btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold; }
        .modal-btn-primary { background: #007bff; color: white; }
        .modal-btn-primary:hover { background: #0056b3; }
        .modal-btn-secondary { background: #6c757d; color: white; }
        .modal-btn-secondary:hover { background: #5a6268; }
        .modal-btn-danger { background: #dc3545; color: white; }
        .modal-btn-danger:hover { background: #c82333; }
    </style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <h1 style="margin-bottom: 5px;">ê´€ë¦¬ì í˜ì´ì§€</h1>
                <p style="color: #667eea; font-weight: bold; font-size: 16px;">{{ username }}</p>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <a href="/admin" style="padding: 8px 16px; background: #667eea; color: white; text-decoration: none; border-radius: 4px;">í• ì¼ê´€ë¦¬</a>
                <a href="/promotions" style="padding: 8px 16px; background: #667eea; color: white; text-decoration: none; border-radius: 4px;">í”„ë¡œëª¨ì…˜ê²Œì‹œíŒ</a>
                <a href="/chats" style="padding: 8px 16px; background: #667eea; color: white; text-decoration: none; border-radius: 4px;">ì±„íŒ…</a>
                <a href="/" style="padding: 8px 16px; background: #6c757d; color: white; text-decoration: none; border-radius: 4px;">í™ˆìœ¼ë¡œ</a>
                <a href="/logout" style="padding: 8px 16px; background: #dc3545; color: white; text-decoration: none; border-radius: 4px;">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
        </div>

        <!-- íƒ­ ë©”ë‰´ -->
        <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0;">
            <button class="tab-button active" onclick="switchTab('register')" id="tab-register" style="padding: 15px 30px; border: none; background: none; font-size: 16px; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; color: #667eea;">
                âœï¸ í• ì¼ ë“±ë¡
            </button>
            <button class="tab-button" onclick="switchTab('manage')" id="tab-manage" style="padding: 15px 30px; border: none; background: none; font-size: 16px; font-weight: 600; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.3s; color: #666;">
                ğŸ“‹ í• ì¼ ê´€ë¦¬
            </button>
        </div>

        <style>
            .tab-button:hover {
                background: #f5f5f5;
                color: #667eea !important;
            }
            .tab-button.active {
                color: #667eea !important;
                border-bottom-color: #667eea !important;
            }
            .tab-content {
                display: none;
                animation: fadeIn 0.3s;
            }
            .tab-content.active {
                display: block;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(10px); }
                to { opacity: 1; transform: translateY(0); }
            }
        </style>

        <!-- íƒ­ 1: í• ì¼ ë“±ë¡ -->
        <div id="content-register" class="tab-content active">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px;">
                <!-- ë‹¨ì¼ í•­ëª© ì¶”ê°€ -->
                <div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #667eea;">
                    <div style="display: flex; align-items: center; margin-bottom: 20px;">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2" style="margin-right: 10px;">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="12" y1="18" x2="12" y2="12"></line>
                            <line x1="9" y1="15" x2="15" y2="15"></line>
                        </svg>
                        <h2 style="margin: 0; color: #333; font-size: 22px; font-weight: 600;">ìƒˆ í• ì¼ ì¶”ê°€</h2>
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">ëŒ€ìƒì ì´ë¦„ (ì„ íƒì‚¬í•­)</label>
                        <input type="text" id="assignedTo" placeholder="ì´ë¦„ ì…ë ¥ ë˜ëŠ” ê³µë€ (ë¯¸ë°°ì •)" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; transition: all 0.3s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#ddd'">
                        <small style="color: #999; font-size: 12px;">ê³µë€ìœ¼ë¡œ ë‘ë©´ ë¯¸ë°°ì • ìƒíƒœë¡œ ë“±ë¡ë©ë‹ˆë‹¤</small>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">ì œëª©</label>
                        <input type="text" id="title" placeholder="ì œëª© ì…ë ¥" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; transition: all 0.3s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#ddd'">
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">ë‚´ìš©</label>
                        <textarea id="content" placeholder="ë‚´ìš© ì…ë ¥" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; min-height: 120px; transition: all 0.3s; resize: vertical;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#ddd'"></textarea>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button onclick="addItem()" style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 14px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 15px; transition: all 0.3s; box-shadow: 0 2px 5px rgba(102,126,234,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 10px rgba(102,126,234,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 5px rgba(102,126,234,0.3)'">
                            â• ì¶”ê°€
                        </button>
                        <button onclick="clearForm()" style="flex: 0.5; background: #6c757d; color: white; border: none; padding: 14px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 15px; transition: all 0.3s;" onmouseover="this.style.background='#5a6268'" onmouseout="this.style.background='#6c757d'">
                            ğŸ”„ ì´ˆê¸°í™”
                        </button>
                    </div>
                </div>

                <!-- ì¼ê´„ ë“±ë¡ ì„¹ì…˜ -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                    <h2 style="margin: 0 0 20px 0; color: white; font-size: 22px; font-weight: 600;">ğŸ“¤ ì—‘ì…€ ì¼ê´„ ë“±ë¡</h2>
                    <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="margin-bottom: 15px;">
                    <div id="dropZone" style="border: 2px dashed #ddd; border-radius: 8px; padding: 30px; text-align: center; background: #fafafa; cursor: pointer; transition: all 0.3s; margin-bottom: 15px;"
                         ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)" onclick="document.getElementById('excelFile').click()">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#4caf50" stroke-width="2" style="margin: 0 auto 10px;">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="12" y1="18" x2="12" y2="12"></line>
                            <line x1="9" y1="15" x2="15" y2="15"></line>
                        </svg>
                        <p style="margin: 0 0 5px 0; color: #4caf50; font-weight: 600; font-size: 16px;">íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</p>
                        <p style="margin: 0; color: #999; font-size: 13px;">ì§€ì› í˜•ì‹: .xlsx, .xls</p>
                        <p id="selectedFileName" style="margin: 10px 0 0 0; color: #666; font-size: 14px; font-weight: 500;"></p>
                    </div>
                    <input type="file" id="excelFile" accept=".xlsx,.xls" style="display: none;" onchange="handleFileSelect(event)">
                    <div style="display: flex; gap: 10px;">
                        <button onclick="uploadExcel()" style="flex: 1; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; border: none; padding: 12px; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 5px rgba(76,175,80,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 10px rgba(76,175,80,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 5px rgba(76,175,80,0.3)'">
                            ğŸ“¤ ì—…ë¡œë“œ
                        </button>
                        <a href="/download/template/tasks" style="flex: 1; background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; text-decoration: none; padding: 12px; border-radius: 6px; font-weight: 600; text-align: center; transition: all 0.3s; box-shadow: 0 2px 5px rgba(33,150,243,0.3); display: flex; align-items: center; justify-content: center;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 10px rgba(33,150,243,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 5px rgba(33,150,243,0.3)'">
                            ğŸ“¥ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ
                        </a>
                    </div>
                    <p style="margin: 12px 0 0 0; padding: 10px; background: #fff3cd; border-radius: 6px; font-size: 13px; color: #856404; line-height: 1.5;">
                        ğŸ’¡ <strong>í˜•ì‹:</strong> ëŒ€ìƒ | ì œëª© | ë‚´ìš©<br>
                        â€¢ ëŒ€ìƒì´ DBì— ìˆìœ¼ë©´ ìë™ ë°°ì •<br>
                        â€¢ ëŒ€ìƒì´ ë¹„ì–´ìˆê±°ë‚˜ ì—†ìœ¼ë©´ ë¯¸ë°°ì •
                    </p>
                </div>

                <!-- ì¼ê´„ ë°°ì • ì„¹ì…˜ -->
                <div style="flex: 1; min-width: 300px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="display: flex; align-items: center; margin-bottom: 12px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ff9800" stroke-width="2" style="margin-right: 8px;">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <h3 style="margin: 0; color: #333; font-size: 18px; font-weight: 600;">ì„ íƒ í•­ëª© ì¼ê´„ ë°°ì •</h3>
                    </div>
                    <div style="background: #fff8f0; padding: 20px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ff9800;">
                        <p style="margin: 0 0 10px 0; color: #666; font-size: 14px;">ì²´í¬ë°•ìŠ¤ë¡œ í•­ëª©ì„ ì„ íƒí•œ í›„<br>ì¼ê´„ ë°°ì • ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>
                        <div style="display: flex; gap: 8px; color: #999; font-size: 13px; align-items: center;">
                            <span style="background: #fff; padding: 4px 8px; border-radius: 4px; font-weight: 600; color: #ff9800;">âœ“</span>
                            <span>ëœë¤ ë˜ëŠ” ìˆœì°¨ ë°°ì • ê°€ëŠ¥</span>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button onclick="openBulkAssignModal()" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; border: none; padding: 14px; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 5px rgba(255,152,0,0.3); font-size: 15px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 10px rgba(255,152,0,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 5px rgba(255,152,0,0.3)'">
                            ğŸ‘¥ ì¼ê´„ ë°°ì •
                        </button>
                        <button onclick="selectAllUnassigned()" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); color: white; border: none; padding: 14px; border-radius: 6px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 5px rgba(156,39,176,0.3); font-size: 15px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 10px rgba(156,39,176,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 5px rgba(156,39,176,0.3)'">
                            ğŸ“‹ ë¯¸ë°°ì • ì „ì²´ ì„ íƒ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <style>
            #dropZone.dragover {
                background: #e8f5e9 !important;
                border-color: #4caf50 !important;
                transform: scale(1.02);
            }
        </style>

        <div style="margin-bottom: 20px;">
            <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                <h2 style="margin: 0;">ì „ì²´ í•­ëª© ëª©ë¡</h2>
                <select id="assignmentFilter" onchange="loadItems()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="all">ì „ì²´</option>
                    <option value="assigned">ë°°ì •ë¨</option>
                    <option value="unassigned">ë¯¸ë°°ì •</option>
                </select>
                <select id="statusFilter" onchange="loadItems()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="all">ëª¨ë“  ìƒíƒœ</option>
                    <option value="ëŒ€ê¸°ì¤‘">ëŒ€ê¸°ì¤‘</option>
                    <option value="ì§„í–‰ì¤‘">ì§„í–‰ì¤‘</option>
                    <option value="ì™„ë£Œ">ì™„ë£Œ</option>
                </select>
                <div style="flex: 1; max-width: 400px; position: relative;">
                    <input type="text" id="searchInput" placeholder="ğŸ” ì œëª©, ë‚´ìš©, ë‹´ë‹¹ìë¡œ ê²€ìƒ‰..."
                           onkeyup="searchItems()"
                           style="width: 100%; padding: 10px 40px 10px 15px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; transition: all 0.3s;"
                           onfocus="this.style.borderColor='#667eea'"
                           onblur="this.style.borderColor='#ddd'">
                    <button onclick="document.getElementById('searchInput').value=''; searchItems();"
                            style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #999; cursor: pointer; padding: 5px 10px; font-size: 18px;"
                            title="ê²€ìƒ‰ ì´ˆê¸°í™”">âœ•</button>
                </div>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="openBulkAssignModal()" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white; border: none; padding: 10px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 4px rgba(255,152,0,0.3);">
                    ğŸ‘¥ ì„ íƒ í•­ëª© ë°°ì •
                </button>
                <button onclick="bulkUnassign()" style="background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%); color: white; border: none; padding: 10px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 4px rgba(156,39,176,0.3);">
                    â†©ï¸ ì„ íƒ í•­ëª© ë°°ì • í•´ì œ
                </button>
                <button onclick="bulkDelete()" style="background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; border: none; padding: 10px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 4px rgba(244,67,54,0.3);">
                    ğŸ—‘ï¸ ì„ íƒ í•­ëª© ì‚­ì œ
                </button>
                <button onclick="selectAllUnassigned()" style="background: linear-gradient(135deg, #607d8b 0%, #455a64 100%); color: white; border: none; padding: 10px 16px; border-radius: 6px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 4px rgba(96,125,139,0.3);">
                    ğŸ“‹ ë¯¸ë°°ì • ì „ì²´ ì„ íƒ
                </button>
            </div>
        </div>
        <table id="itemsTable">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                    <th>ID</th>
                    <th>ìƒíƒœ</th>
                    <th>ëŒ€ìƒì</th>
                    <th>ì œëª©</th>
                    <th>ë‚´ìš©</th>
                    <th>ì‘ì—…</th>
                </tr>
            </thead>
            <tbody id="itemsList"></tbody>
        </table>
    </div>

    <!-- ëª¨ë‹¬ -->
    <div id="modalOverlay" class="modal-overlay">
        <div class="modal-box">
            <div id="modalTitle" class="modal-title"></div>
            <div id="modalMessage" class="modal-message"></div>
            <input type="text" id="modalInput" class="modal-input" style="display: none;">
            <div id="modalContent" style="display: none;"></div>
            <div id="modalButtons" class="modal-buttons"></div>
        </div>
    </div>

    <script>
        const socket = io();
        const currentUsername = '{{ username }}';
        let editingId = null;
        let unreadCount = 0;
        let originalTitle = 'ê´€ë¦¬ì í˜ì´ì§€';
        let titleBlinkInterval = null;

        // ëª¨ë‹¬ í•¨ìˆ˜
        function showModal(title, message, buttons) {
            const overlay = document.getElementById('modalOverlay');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalInput = document.getElementById('modalInput');
            const modalButtons = document.getElementById('modalButtons');

            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalInput.style.display = 'none';
            modalInput.value = '';

            modalButtons.innerHTML = buttons.map(btn => {
                const className = btn.type === 'primary' ? 'modal-btn-primary' :
                                 btn.type === 'danger' ? 'modal-btn-danger' :
                                 'modal-btn-secondary';
                return `<button class="modal-btn ${className}" onclick="${btn.onclick}">${btn.text}</button>`;
            }).join('');

            overlay.classList.add('active');
        }

        function showPromptModal(title, message, callback) {
            const overlay = document.getElementById('modalOverlay');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalInput = document.getElementById('modalInput');
            const modalButtons = document.getElementById('modalButtons');

            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalInput.style.display = 'block';
            modalInput.value = '';
            modalInput.focus();

            modalButtons.innerHTML = `
                <button class="modal-btn modal-btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="modal-btn modal-btn-primary" onclick="confirmPrompt()">í™•ì¸</button>
            `;

            window.promptCallback = callback;
            overlay.classList.add('active');

            // Enter í‚¤ë¡œ í™•ì¸
            modalInput.onkeypress = (e) => {
                if (e.key === 'Enter') confirmPrompt();
            };
        }

        function confirmPrompt() {
            const value = document.getElementById('modalInput').value.trim();
            closeModal();
            if (window.promptCallback) {
                window.promptCallback(value);
            }
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }

        // ëª¨ë‹¬ ë°°ê²½ í´ë¦­ì‹œ ë‹«ê¸°
        document.getElementById('modalOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'modalOverlay') {
                closeModal();
            }
        });

        function loadItems() {
            fetch('/api/items')
                .then(res => res.json())
                .then(data => {
                    const tbody = document.getElementById('itemsList');

                    // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì €ì¥
                    const checkedIds = new Set(
                        Array.from(document.querySelectorAll('.task-checkbox:checked'))
                            .map(cb => parseInt(cb.value))
                    );

                    tbody.innerHTML = '';

                    // í•„í„° ì ìš©
                    const assignmentFilter = document.getElementById('assignmentFilter').value;
                    const statusFilter = document.getElementById('statusFilter').value;

                    let filteredData = data;

                    if (assignmentFilter === 'assigned') {
                        filteredData = filteredData.filter(item => item.assigned_to);
                    } else if (assignmentFilter === 'unassigned') {
                        filteredData = filteredData.filter(item => !item.assigned_to);
                    }

                    if (statusFilter !== 'all') {
                        filteredData = filteredData.filter(item => item.status === statusFilter);
                    }

                    filteredData.forEach(item => {
                        const tr = document.createElement('tr');

                        // ìƒíƒœ ë°°ì§€ ìƒ‰ìƒ
                        let statusColor = '#6c757d';
                        if (item.status === 'ì§„í–‰ì¤‘') statusColor = '#ffc107';
                        if (item.status === 'ì™„ë£Œ') statusColor = '#28a745';

                        tr.innerHTML = `
                            <td><input type="checkbox" class="task-checkbox" value="${item.id}"></td>
                            <td>${item.id}</td>
                            <td><span style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${item.status || 'ëŒ€ê¸°ì¤‘'}</span></td>
                            <td>${item.assigned_to || '<span style="color: #999;">ë¯¸ë°°ì •</span>'}</td>
                            <td>${item.title || ''}</td>
                            <td>${item.content || ''}</td>
                            <td class="actions">
                                ${!item.assigned_to ? `<button onclick="assignItem(${item.id})" style="background: #17a2b8;">ë°°ì •</button>` : `<button onclick="unassignItem(${item.id})" style="background: #ffc107;">íšŒìˆ˜</button>`}
                                <button class="edit" onclick="editItem(${item.id})">ìˆ˜ì •</button>
                                <button class="delete" onclick="deleteItem(${item.id})">ì‚­ì œ</button>
                            </td>
                        `;
                        tbody.appendChild(tr);

                        // ì²´í¬ë°•ìŠ¤ ìƒíƒœ ë³µì›
                        if (checkedIds.has(item.id)) {
                            const checkbox = tr.querySelector('.task-checkbox');
                            checkbox.checked = true;
                        }
                    });

                    // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
                    updateSelectAllState();
                });
        }

        // ì „ì²´ ì„ íƒ/í•´ì œ
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.task-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
        }

        // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateSelectAllState() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.task-checkbox');
            const checkedCheckboxes = document.querySelectorAll('.task-checkbox:checked');

            if (checkboxes.length === 0) {
                selectAll.checked = false;
                selectAll.indeterminate = false;
            } else if (checkedCheckboxes.length === checkboxes.length) {
                selectAll.checked = true;
                selectAll.indeterminate = false;
            } else if (checkedCheckboxes.length > 0) {
                selectAll.checked = false;
                selectAll.indeterminate = true;
            } else {
                selectAll.checked = false;
                selectAll.indeterminate = false;
            }
        }

        // ê²€ìƒ‰ ê¸°ëŠ¥
        let allItemsData = [];  // ì „ì²´ ë°ì´í„° ì €ì¥

        function searchItems() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const tableBody = document.querySelector('#itemsTable tbody');
            const rows = tableBody.querySelectorAll('tr');

            let visibleCount = 0;
            rows.forEach(row => {
                const title = row.cells[3]?.textContent.toLowerCase() || '';
                const content = row.cells[4]?.textContent.toLowerCase() || '';
                const assignedTo = row.cells[5]?.textContent.toLowerCase() || '';

                if (title.includes(searchText) || content.includes(searchText) || assignedTo.includes(searchText)) {
                    row.style.display = '';
                    visibleCount++;
                } else {
                    row.style.display = 'none';
                }
            });

            // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
            if (searchText && visibleCount === 0) {
                if (!document.getElementById('noResultsRow')) {
                    const noResultsRow = tableBody.insertRow(0);
                    noResultsRow.id = 'noResultsRow';
                    noResultsRow.innerHTML = '<td colspan="8" style="text-align: center; padding: 40px; color: #999;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td>';
                }
            } else {
                const noResultsRow = document.getElementById('noResultsRow');
                if (noResultsRow) {
                    noResultsRow.remove();
                }
            }
        }

        // ë¯¸ë°°ì • í•­ëª© ì „ì²´ ì„ íƒ
        function selectAllUnassigned() {
            fetch('/api/items')
                .then(res => res.json())
                .then(data => {
                    const unassignedIds = data.filter(item => !item.assigned_to).map(item => item.id);
                    document.querySelectorAll('.task-checkbox').forEach(cb => {
                        cb.checked = unassignedIds.includes(parseInt(cb.value));
                    });
                    updateSelectAllState();
                    showModal('ì™„ë£Œ', `${unassignedIds.length}ê°œì˜ ë¯¸ë°°ì • í•­ëª©ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.`, [
                        { text: 'í™•ì¸', type: 'primary', onclick: 'closeModal()' }
                    ]);
                });
        }

        // ì¼ê´„ ë°°ì • í•´ì œ (ë¯¸ë°°ì •ìœ¼ë¡œ ë³€ê²½)
        function bulkUnassign() {
            const selected = Array.from(document.querySelectorAll('.task-checkbox:checked')).map(cb => parseInt(cb.value));

            if (selected.length === 0) {
                showModal('ì˜¤ë¥˜', 'ë°°ì • í•´ì œí•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.', [
                    { text: 'í™•ì¸', type: 'primary', onclick: 'closeModal()' }
                ]);
                return;
            }

            showModal('í™•ì¸', `ì„ íƒí•œ ${selected.length}ê°œ í•­ëª©ì˜ ë°°ì •ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, [
                { text: 'ì·¨ì†Œ', type: 'secondary', onclick: 'closeModal()' },
                { text: 'í™•ì¸', type: 'primary', onclick: 'closeModal(); proceedBulkUnassign(' + JSON.stringify(selected) + ')' }
            ]);
        }

        function proceedBulkUnassign(taskIds) {
            const promises = taskIds.map(id =>
                fetch('/api/items/' + id + '/unassign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
            );

            Promise.all(promises)
                .then(responses => Promise.all(responses.map(r => r.json())))
                .then(results => {
                    const successCount = results.filter(r => r.success).length;
                    showModal('ì™„ë£Œ', `${successCount}ê°œ í•­ëª©ì˜ ë°°ì •ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, [
                        { text: 'í™•ì¸', type: 'primary', onclick: 'closeModal(); loadItems();' }
                    ]);
                })
                .catch(err => {
                    showModal('ì˜¤ë¥˜', 'ë°°ì • í•´ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message, [
                        { text: 'í™•ì¸', type: 'primary', onclick: 'closeModal()' }
                    ]);
                });
        }

        // ì¼ê´„ ì‚­ì œ
        function bulkDelete() {
            const selected = Array.from(document.querySelectorAll('.task-checkbox:checked')).map(cb => parseInt(cb.value));

            if (selected.length === 0) {
                showModal('ì˜¤ë¥˜', 'ì‚­ì œí•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.', [
                    { text: 'í™•ì¸', type: 'primary', onclick: 'closeModal()' }
                ]);
                return;
            }

            showModal('ê²½ê³ ', `ì„ íƒí•œ ${selected.length}ê°œ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br><span style="color: #f44336; font-weight: bold;">ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>`, [
                { text: 'ì·¨ì†Œ', type: 'secondary', onclick: 'closeModal()' },
                { text: 'ì‚­ì œ', type: 'danger', onclick: 'closeModal(); proceedBulkDelete(' + JSON.stringify(selected) + ')' }
            ]);
        }

        function proceedBulkDelete(taskIds) {
            const promises = taskIds.map(id =>
                fetch('/api/items/' + id, {
                    method: 'DELETE'
                })
            );

            Promise.all(promises)
                .then(responses => Promise.all(responses.map(r => r.json())))
                .then(results => {
                    const successCount = results.filter(r => r.success).length;
                    showModal('ì™„ë£Œ', `${successCount}ê°œ í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, [
                        { text: 'í™•ì¸', type: 'primary', onclick: 'closeModal(); loadItems();' }
                    ]);
                })
                .catch(err => {
                    showModal('ì˜¤ë¥˜', 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message, [
                        { text: 'í™•ì¸', type: 'primary', onclick: 'closeModal()' }
                    ]);
                });
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ í•¸ë“¤ëŸ¬
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropZone').classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropZone').classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            document.getElementById('dropZone').classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    document.getElementById('excelFile').files = files;
                    document.getElementById('selectedFileName').textContent = 'âœ“ ' + file.name;
                } else {
                    showModal('ì˜¤ë¥˜', 'ì—‘ì…€ íŒŒì¼(.xlsx, .xls)ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', [
                        { text: 'í™•ì¸', type: 'primary', onclick: 'closeModal()' }
                    ]);
                }
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('selectedFileName').textContent = 'âœ“ ' + file.name;
            }
        }

        // ì—‘ì…€ ì—…ë¡œë“œ
        function uploadExcel() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];

            if (!file) {
                showModal('ì˜¤ë¥˜', 'íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.', [
                    { text: 'í™•ì¸', type: 'primary', onclick: 'closeModal()' }
                ]);
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            fetch('/api/items/bulk-upload', {
                method: 'POST',
                body: formData
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showModal('ì™„ë£Œ', `${data.count}ê°œì˜ í• ì¼ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`, [
                        { text: 'í™•ì¸', type: 'primary', onclick: 'closeModal(); loadItems();' }
                    ]);
                    fileInput.value = '';
                    document.getElementById('selectedFileName').textContent = '';
                } else {
                    showModal('ì˜¤ë¥˜', data.error || 'ì—…ë¡œë“œ ì‹¤íŒ¨', [
                        { text: 'í™•ì¸', type: 'primary', onclick: 'closeModal()' }
                    ]);
                }
            })
            .catch(err => {
                showModal('ì˜¤ë¥˜', 'ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message, [
                    { text: 'í™•ì¸', type: 'primary', onclick: 'closeModal()' }
                ]);
            });
        }

        // ì¼ê´„ ë°°ì • ëª¨ë‹¬ ì—´ê¸°
        function openBulkAssignModal() {
            const selected = Array.from(document.querySelectorAll('.task-checkbox:checked')).map(cb => parseInt(cb.value));

            if (selected.length === 0) {
                showModal('ì˜¤ë¥˜', 'ë°°ì •í•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”.', [
                    { text: 'í™•ì¸', type: 'primary', onclick: 'closeModal()' }
                ]);
                return;
            }

            // íŒ€ ëª©ë¡ê³¼ ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ
            Promise.all([
                fetch('/api/teams').then(res => res.json()),
                fetch('/api/users/by-team?team=ì „ì²´').then(res => res.json())
            ])
                .then(([teams, users]) => {
                    if (users.length === 0) {
                        showModal('ì˜¤ë¥˜', 'ë°°ì • ê°€ëŠ¥í•œ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.', [
                            { text: 'í™•ì¸', type: 'primary', onclick: 'closeModal()' }
                        ]);
                        return;
                    }

                    window.allUsersData = users; // ì „ì²´ ì‚¬ìš©ì ë°ì´í„° ì €ì¥
                    window.teamsData = teams; // íŒ€ ë°ì´í„° ì €ì¥

                    showBulkAssignModal(selected, teams, users);
                });
        }

        // ì¼ê´„ ë°°ì • ëª¨ë‹¬ í‘œì‹œ
        function showBulkAssignModal(selected, teams, users) {
            const overlay = document.getElementById('modalOverlay');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalInput = document.getElementById('modalInput');
            const modalContent = document.getElementById('modalContent');
            const modalButtons = document.getElementById('modalButtons');

            modalTitle.textContent = 'ì¼ê´„ ë°°ì •';
            modalMessage.textContent = `${selected.length}ê°œ í•­ëª©ì„ ë°°ì •í•©ë‹ˆë‹¤.`;
            modalInput.style.display = 'none';

            // ì‚¬ìš©ì ì„ íƒ UI
            modalContent.style.display = 'block';
            modalContent.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">íŒ€ ì„ íƒ:</label>
                    <select id="teamFilter" onchange="onTeamChange(${JSON.stringify(selected)})" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px;">
                        <option value="ì „ì²´">ì „ì²´</option>
                        ${teams.map(team => `<option value="${team}">${team}</option>`).join('')}
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">ë°°ì • ë°©ì‹:</label>
                    <select id="assignMode" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="random">ëœë¤ ë°°ì • (ê° í• ì¼ì„ ë¬´ì‘ìœ„ ì‚¬ìš©ìì—ê²Œ)</option>
                        <option value="sequential">ìˆœì°¨ ë°°ì • (ì„ íƒí•œ ì‚¬ìš©ì ìˆœì„œëŒ€ë¡œ ëŒì•„ê°€ë©°)</option>
                    </select>
                </div>
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                        <label style="font-weight: bold;">ë°°ì •í•  ì‚¬ìš©ì (ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥):</label>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="selectAllUsers()" style="padding: 4px 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ì „ì²´ ì„ íƒ</button>
                            <button onclick="deselectAllUsers()" style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">ì„ íƒ í•´ì œ</button>
                        </div>
                    </div>
                    <input type="text" id="userSearchInput" placeholder="ì‚¬ìš©ì ì´ë¦„ ê²€ìƒ‰..." onkeyup="filterUsers()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 10px; font-size: 14px;">
                    <div id="userListContainer" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 0; background: white;">
                        ${users.map((user, index) => `
                            <label class="user-item" style="display: flex; align-items: center; padding: 12px 15px; cursor: pointer; border-bottom: ${index < users.length - 1 ? '1px solid #f0f0f0' : 'none'}; transition: background 0.2s;">
                                <input type="checkbox" class="user-checkbox" value="${user}" onchange="updateSelectedCount()" style="margin: 0; width: 18px; height: 18px; cursor: pointer; flex-shrink: 0;">
                                <span style="margin-left: 12px; font-size: 14px; color: #333;">${user}</span>
                            </label>
                        `).join('')}
                    </div>
                    <style>
                        .user-item:hover {
                            background: #f8f9fa !important;
                        }
                        .user-checkbox:checked + span {
                            font-weight: bold;
                            color: #007bff;
                        }
                    </style>
                    <div style="margin-top: 5px; font-size: 12px; color: #666;">
                        ì„ íƒë¨: <span id="selectedCount">0</span> / ${users.length}ëª…
                    </div>
                </div>
            `;

            modalButtons.innerHTML = `
                <button class="modal-btn modal-btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="modal-btn modal-btn-primary" onclick="confirmBulkAssign(${JSON.stringify(selected)})">ë°°ì •</button>
            `;

            overlay.classList.add('active');
        }

        // íŒ€ ì„ íƒ ë³€ê²½ ì‹œ ì‚¬ìš©ì ëª©ë¡ ì—…ë°ì´íŠ¸
        function onTeamChange(selected) {
            const team = document.getElementById('teamFilter').value;

            fetch(`/api/users/by-team?team=${encodeURIComponent(team)}`)
                .then(res => res.json())
                .then(users => {
                    if (users.length === 0) {
                        showModal('ì˜¤ë¥˜', 'í•´ë‹¹ íŒ€ì— ë°°ì • ê°€ëŠ¥í•œ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.', [
                            { text: 'í™•ì¸', type: 'primary', onclick: 'closeModal()' }
                        ]);
                        return;
                    }

                    // ì‚¬ìš©ì ëª©ë¡ ì—…ë°ì´íŠ¸
                    const userListContainer = document.getElementById('userListContainer');
                    userListContainer.innerHTML = users.map((user, index) => `
                        <label class="user-item" style="display: flex; align-items: center; padding: 12px 15px; cursor: pointer; border-bottom: ${index < users.length - 1 ? '1px solid #f0f0f0' : 'none'}; transition: background 0.2s;">
                            <input type="checkbox" class="user-checkbox" value="${user}" onchange="updateSelectedCount()" style="margin: 0; width: 18px; height: 18px; cursor: pointer; flex-shrink: 0;">
                            <span style="margin-left: 12px; font-size: 14px; color: #333;">${user}</span>
                        </label>
                    `).join('');

                    // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
                    const selectedCountElement = document.getElementById('selectedCount');
                    if (selectedCountElement) {
                        selectedCountElement.textContent = '0';
                        selectedCountElement.parentElement.innerHTML = `ì„ íƒë¨: <span id="selectedCount">0</span> / ${users.length}ëª…`;
                    }
                })
                .catch(err => {
                    console.error('íŒ€ë³„ ì‚¬ìš©ì ì¡°íšŒ ì‹¤íŒ¨:', err);
                });
        }

        // ì‚¬ìš©ì ê²€ìƒ‰ í•„í„°
        function filterUsers() {
            const searchInput = document.getElementById('userSearchInput');
            const filter = searchInput.value.toLowerCase();
            const userItems = document.querySelectorAll('.user-item');

            userItems.forEach(item => {
                const username = item.textContent.trim().toLowerCase();
                if (username.includes(filter)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // ì„ íƒ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
        function updateSelectedCount() {
            const selectedCount = document.querySelectorAll('.user-checkbox:checked').length;
            const countElement = document.getElementById('selectedCount');
            if (countElement) {
                countElement.textContent = selectedCount;
            }
        }

        // ì‚¬ìš©ì ì „ì²´ ì„ íƒ (ê²€ìƒ‰ í•„í„° ì ìš©)
        function selectAllUsers() {
            document.querySelectorAll('.user-item').forEach(item => {
                if (item.style.display !== 'none') {
                    const checkbox = item.querySelector('.user-checkbox');
                    checkbox.checked = true;
                }
            });
            updateSelectedCount();
        }

        // ì‚¬ìš©ì ì„ íƒ í•´ì œ (ê²€ìƒ‰ í•„í„° ì ìš©)
        function deselectAllUsers() {
            document.querySelectorAll('.user-item').forEach(item => {
                if (item.style.display !== 'none') {
                    const checkbox = item.querySelector('.user-checkbox');
                    checkbox.checked = false;
                }
            });
            updateSelectedCount();
        }

        // ì¼ê´„ ë°°ì • í™•ì¸
        function confirmBulkAssign(taskIds) {
            const selectedUsers = Array.from(document.querySelectorAll('.user-checkbox:checked')).map(cb => cb.value);
            const mode = document.getElementById('assignMode').value;

            if (selectedUsers.length === 0) {
                showModal('ì˜¤ë¥˜', 'ë°°ì •í•  ì‚¬ìš©ìë¥¼ ì„ íƒí•˜ì„¸ìš”.', [
                    { text: 'í™•ì¸', type: 'primary', onclick: 'closeModal()' }
                ]);
                return;
            }

            // í• ì¼ ìˆ˜ê°€ ì‚¬ìš©ì ìˆ˜ë³´ë‹¤ ì ìœ¼ë©´ ê²½ê³ 
            if (taskIds.length < selectedUsers.length) {
                window.tempBulkAssignData = { taskIds, selectedUsers, mode };
                showModal('ë°°ì • ìˆ˜ëŸ‰ ë¶€ì¡±',
                    `ë°°ì •í•  í• ì¼(${taskIds.length}ê°œ)ì´ ì„ íƒí•œ ì‚¬ìš©ì(${selectedUsers.length}ëª…)ë³´ë‹¤ ì ìŠµë‹ˆë‹¤.\n` +
                    `ì¼ë¶€ ì‚¬ìš©ìëŠ” í• ì¼ì„ ë°›ì§€ ëª»í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nê³„ì† ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, [
                    { text: 'ì·¨ì†Œ', type: 'secondary', onclick: 'closeModal(); openBulkAssignModal();' },
                    { text: 'ê³„ì†', type: 'primary', onclick: 'closeModal(); proceedBulkAssign(window.tempBulkAssignData.taskIds, window.tempBulkAssignData.selectedUsers, window.tempBulkAssignData.mode);' }
                ]);
                return;
            }

            // ë‚˜ë¨¸ì§€ê°€ ë°œìƒí•˜ëŠ” ê²½ìš°: ë‚˜ë¨¸ì§€ëŠ” ë°°ì •í•˜ì§€ ì•Šê³  ë”± ë–¨ì–´ì§€ê²Œ (ìˆœì°¨ ë° ëœë¤ ëª¨ë“œ ê³µí†µ)
            const remainder = taskIds.length % selectedUsers.length;
            if (remainder > 0) {
                const assignableCount = taskIds.length - remainder;
                const perUser = Math.floor(taskIds.length / selectedUsers.length);
                window.tempBulkAssignData = { taskIds: taskIds.slice(0, assignableCount), selectedUsers, mode };
                showModal('ë‚˜ë¨¸ì§€ í• ì¼ ì²˜ë¦¬',
                    `í• ì¼ ${taskIds.length}ê°œë¥¼ ${selectedUsers.length}ëª…ì—ê²Œ ë°°ì •í•˜ë©´ ${remainder}ê°œê°€ ë‚¨ìŠµë‹ˆë‹¤.\n` +
                    `${assignableCount}ê°œë§Œ ë°°ì •(1ì¸ë‹¹ ${perUser}ê±´)í•˜ê³  ë‚˜ë¨¸ì§€ ${remainder}ê°œëŠ” ë¯¸ë°°ì • ìƒíƒœë¡œ ë‘ì‹œê² ìŠµë‹ˆê¹Œ?`, [
                    { text: 'ì·¨ì†Œ', type: 'secondary', onclick: 'closeModal(); openBulkAssignModal();' },
                    { text: 'í™•ì¸', type: 'primary', onclick: 'closeModal(); proceedBulkAssign(window.tempBulkAssignData.taskIds, window.tempBulkAssignData.selectedUsers, window.tempBulkAssignData.mode);' }
                ]);
                return;
            }

            closeModal();
            proceedBulkAssign(taskIds, selectedUsers, mode);
        }

        // ì‹¤ì œ ë°°ì • ì‹¤í–‰
        function proceedBulkAssign(taskIds, selectedUsers, mode) {

            fetch('/api/items/bulk-assign', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    task_ids: taskIds,
                    mode: mode,
                    users: selectedUsers
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // ë°°ì • ê²°ê³¼ ê³„ì‚°
                    const tasksPerUser = Math.floor(taskIds.length / selectedUsers.length);
                    const modeText = mode === 'random' ? 'ëœë¤ ë°°ì •' : 'ìˆœì°¨ ë°°ì •';

                    let resultMessage = `âœ… ${modeText} ì™„ë£Œ\n\n`;
                    resultMessage += `ğŸ“‹ ì´ ${data.count}ê°œ í• ì¼ì´ ${selectedUsers.length}ëª…ì—ê²Œ ë°°ì •ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n`;

                    if (mode === 'sequential') {
                        resultMessage += `ğŸ‘¥ ë°°ì • ë‚´ì—­:\n`;
                        selectedUsers.forEach((user, index) => {
                            const count = index < (taskIds.length % selectedUsers.length) ? tasksPerUser + 1 : tasksPerUser;
                            resultMessage += `   â€¢ ${user}: ${count}ê±´\n`;
                        });
                    } else {
                        resultMessage += `ğŸ‘¥ ê° ì‚¬ìš©ìê°€ ë¬´ì‘ìœ„ë¡œ í• ì¼ì„ ë°›ì•˜ìŠµë‹ˆë‹¤.\n`;
                        resultMessage += `   (í‰ê·  ì•½ ${tasksPerUser}ê±´)`;
                    }

                    showModal('ë°°ì • ì™„ë£Œ', resultMessage, [
                        { text: 'í™•ì¸', type: 'primary', onclick: 'closeModal(); loadItems();' }
                    ]);
                    document.getElementById('selectAll').checked = false;
                } else {
                    showModal('ì˜¤ë¥˜', data.error || 'ë°°ì • ì‹¤íŒ¨', [
                        { text: 'í™•ì¸', type: 'primary', onclick: 'closeModal()' }
                    ]);
                }
            })
            .catch(err => {
                showModal('ì˜¤ë¥˜', 'ë°°ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message, [
                    { text: 'í™•ì¸', type: 'primary', onclick: 'closeModal()' }
                ]);
            });
        }

        function addItem() {
            const assignedTo = document.getElementById('assignedTo').value.trim();
            const title = document.getElementById('title').value.trim();
            const content = document.getElementById('content').value.trim();

            if (!title) {
                showModal('ì…ë ¥ ì˜¤ë¥˜', 'ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.', [
                    { text: 'í™•ì¸', type: 'primary', onclick: 'closeModal()' }
                ]);
                return;
            }

            // assigned_toê°€ ê³µë€ì´ë©´ nullë¡œ (ë¯¸ë°°ì •)
            const item = {
                assigned_to: assignedTo || null,
                title,
                content,
                status: 'ëŒ€ê¸°ì¤‘'
            };

            if (editingId) {
                fetch(`/api/items/${editingId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(item)
                })
                .then(res => res.json())
                .then(() => {
                    editingId = null;
                    clearForm();
                    loadItems();
                    showModal('ì™„ë£Œ', 'ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', [
                        { text: 'í™•ì¸', type: 'primary', onclick: 'closeModal()' }
                    ]);
                });
            } else {
                fetch('/api/items', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(item)
                })
                .then(res => res.json())
                .then(() => {
                    clearForm();
                    loadItems();
                    showModal('ì™„ë£Œ', 'ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', [
                        { text: 'í™•ì¸', type: 'primary', onclick: 'closeModal()' }
                    ]);
                });
            }
        }

        function editItem(id) {
            fetch('/api/items')
                .then(res => res.json())
                .then(data => {
                    const item = data.find(i => i.id === id);
                    if (item) {
                        document.getElementById('assignedTo').value = item.assigned_to || '';
                        document.getElementById('title').value = item.title || '';
                        document.getElementById('content').value = item.content || '';
                        editingId = id;
                        window.scrollTo(0, 0);
                    }
                });
        }

        function deleteItem(id) {
            showModal('ì‚­ì œ í™•ì¸', 'ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', [
                { text: 'ì·¨ì†Œ', type: 'secondary', onclick: 'closeModal()' },
                { text: 'ì‚­ì œ', type: 'danger', onclick: `confirmDelete(${id})` }
            ]);
        }

        function confirmDelete(id) {
            closeModal();
            fetch(`/api/items/${id}`, { method: 'DELETE' })
                .then(() => {
                    loadItems();
                    showModal('ì™„ë£Œ', 'ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', [
                        { text: 'í™•ì¸', type: 'primary', onclick: 'closeModal()' }
                    ]);
                });
        }

        function clearForm() {
            document.getElementById('assignedTo').value = '';
            document.getElementById('title').value = '';
            document.getElementById('content').value = '';
            editingId = null;
        }

        function assignItem(id) {
            showPromptModal('í• ì¼ ë°°ì •', 'ë°°ì •í•  ì‚¬ìš©ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', (username) => {
                if (!username) return;

                fetch(`/api/items/${id}/assign`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ assigned_to: username })
                })
                .then(res => res.json())
                .then(() => {
                    loadItems();
                    showModal('ì™„ë£Œ', 'ë°°ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', [
                        { text: 'í™•ì¸', type: 'primary', onclick: 'closeModal()' }
                    ]);
                });
            });
        }

        function unassignItem(id) {
            showModal('íšŒìˆ˜ í™•ì¸', 'ì´ í• ì¼ì„ íšŒìˆ˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', [
                { text: 'ì·¨ì†Œ', type: 'secondary', onclick: 'closeModal()' },
                { text: 'íšŒìˆ˜', type: 'primary', onclick: `confirmUnassign(${id})` }
            ]);
        }

        function confirmUnassign(id) {
            closeModal();
            fetch(`/api/items/${id}/assign`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ assigned_to: null })
            })
            .then(res => res.json())
            .then(() => {
                loadItems();
                showModal('ì™„ë£Œ', 'íšŒìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.', [
                    { text: 'í™•ì¸', type: 'primary', onclick: 'closeModal()' }
                ]);
            });
        }

        // ì‚¬ìš©ìë³„ roomì— join (ì „ì—­ ì•Œë¦¼ ë°›ê¸° ìœ„í•¨)
        socket.emit('join_user_room', { username: currentUsername });

        // í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ
        function showToast(chatId, title, message, sender) {
            console.log('í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ:', chatId, title, message);
            const toastContainer = document.getElementById('toastContainer');

            const toast = document.createElement('div');
            toast.className = 'toast';

            // HTML ì´ìŠ¤ì¼€ì´í”„
            const escapeHtml = (text) => {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };

            toast.innerHTML = `
                <div class="toast-icon">ğŸ’¬</div>
                <div class="toast-content">
                    <div class="toast-title">${escapeHtml(title)}</div>
                    <div class="toast-message">${escapeHtml(sender)}: ${escapeHtml(message)}</div>
                </div>
                <button class="toast-close">Ã—</button>
            `;

            // X ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            const closeBtn = toast.querySelector('.toast-close');
            closeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                closeToastElement(toast);
            });

            // í† ìŠ¤íŠ¸ í´ë¦­ì‹œ ì±„íŒ…ë°©ìœ¼ë¡œ ì´ë™
            toast.addEventListener('click', () => {
                location.href = `/chat/${chatId}`;
            });

            toastContainer.appendChild(toast);
            console.log('í† ìŠ¤íŠ¸ ì¶”ê°€ë¨:', toast);

            // 5ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                closeToastElement(toast);
            }, 5000);
        }

        function closeToastElement(toast) {
            if (!toast || !toast.classList) return;
            toast.classList.add('slide-out');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 300);
        }

        // ì „ì—­ ìƒˆ ë©”ì‹œì§€ ì•Œë¦¼ ìˆ˜ì‹ 
        socket.on('global_new_message', (data) => {
            console.log('ì „ì—­ ìƒˆ ë©”ì‹œì§€ ìˆ˜ì‹ :', data);

            // 1:1 ì±„íŒ…ì¸ ê²½ìš° ìƒëŒ€ë°© ì´ë¦„, ê·¸ë£¹ ì±„íŒ…ì¸ ê²½ìš° ì±„íŒ…ë°© ì œëª© í‘œì‹œ
            let displayTitle = data.chat_title;
            if (data.is_one_to_one) {
                const otherUser = data.participants.find(p => p !== currentUsername);
                displayTitle = otherUser || data.chat_title;
            }

            // í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ
            showToast(data.chat_id, displayTitle, data.message, data.sender);

            // íƒ­ì´ í¬ì»¤ìŠ¤ë˜ì–´ ìˆì§€ ì•Šìœ¼ë©´ ì œëª© ê¹œë¹¡ì„
            if (!document.hasFocus()) {
                unreadCount++;
                startTitleBlink();
            }
        });

        window.addEventListener('focus', () => {
            unreadCount = 0;
            stopTitleBlink();
            document.title = originalTitle;
        });

        function startTitleBlink() {
            if (titleBlinkInterval) return;
            let isOriginal = true;
            titleBlinkInterval = setInterval(() => {
                document.title = isOriginal ? `ğŸ”´ (${unreadCount}) ìƒˆ ë©”ì‹œì§€` : originalTitle;
                isOriginal = !isOriginal;
            }, 1000);
        }

        function stopTitleBlink() {
            if (titleBlinkInterval) {
                clearInterval(titleBlinkInterval);
                titleBlinkInterval = null;
            }
        }

        loadItems();
        setInterval(loadItems, 5000);

        // PWA ì„¤ì¹˜ í”„ë¡¬í”„íŠ¸
        let deferredPrompt;
        const installBtn = document.getElementById('installBtn');

        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('PWA ì„¤ì¹˜ ê°€ëŠ¥!');
            e.preventDefault();
            deferredPrompt = e;
            if (installBtn) installBtn.style.display = 'block';
        });

        if (installBtn) {
            installBtn.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`ì‚¬ìš©ì ì„ íƒ: ${outcome}`);
                    deferredPrompt = null;
                    installBtn.style.display = 'none';
                } else {
                    // beforeinstallpromptê°€ ì—†ëŠ” ê²½ìš° (HTTP í™˜ê²½)
                    alert('ì´ ì•±ì„ ì„¤ì¹˜í•˜ë ¤ë©´:\n\n1. Chrome ì£¼ì†Œì°½ ì˜¤ë¥¸ìª½ ë©”ë‰´(â‹®) í´ë¦­\n2. "ì•± ì„¤ì¹˜" ë˜ëŠ” "ë°”ë¡œê°€ê¸° ë§Œë“¤ê¸°" ì„ íƒ\n\në˜ëŠ” ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ë°”ë¡œê°€ê¸°ë¥¼ ë§Œë“¤ì–´ì£¼ì„¸ìš”.');
                }
            });

            window.addEventListener('appinstalled', () => {
                console.log('PWA ì„¤ì¹˜ ì™„ë£Œ!');
                installBtn.style.display = 'none';
                deferredPrompt = null;
            });

            // HTTP í™˜ê²½ì—ì„œë„ ì„¤ì¹˜ ë²„íŠ¼ í‘œì‹œ (3ì´ˆ í›„)
            setTimeout(() => {
                if (!deferredPrompt) {
                    installBtn.style.display = 'block';
                    console.log('HTTP í™˜ê²½: ìˆ˜ë™ ì„¤ì¹˜ ë²„íŠ¼ í‘œì‹œ');
                }
            }, 3000);
        }

        // PWA ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/service-worker.js')
                .then(registration => {
                    console.log('Service Worker ë“±ë¡ ì„±ê³µ:', registration.scope);
                })
                .catch(error => {
                    console.log('Service Worker ë“±ë¡ ì‹¤íŒ¨:', error);
                });
        }
    </script>
</body>
</html>
