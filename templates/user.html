<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚´ í• ë‹¹ ëª©ë¡</title>
    <!-- PWA ë©”íƒ€ íƒœê·¸ -->
    <meta name="description" content="ìŠ¤ë§ˆíŠ¸í•œ ê³ ê° ê´€ë¦¬ì™€ íŒ€ í˜‘ì—…ì„ ìœ„í•œ CRM ì‹œìŠ¤í…œ">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="í•˜ë£¨CRM">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icon-192.png">
    <link rel="apple-touch-icon" href="/static/icon-192.png">

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .items { display: grid; gap: 20px; }
        .item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }
        .item h3 { color: #333; margin-bottom: 10px; }
        .item-content { color: #666; line-height: 1.6; white-space: pre-wrap; margin-bottom: 15px; }
        .item-status { display: flex; align-items: center; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
        .status-badge { padding: 6px 12px; border-radius: 4px; font-size: 13px; font-weight: bold; color: white; }
        .status-ëŒ€ê¸°ì¤‘ { background: #6c757d; }
        .status-ì§„í–‰ì¤‘ { background: #ffc107; color: #333; }
        .status-ì™„ë£Œ { background: #28a745; }
        .status-button { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; background: #667eea; color: white; }
        .status-button:hover { background: #5568d3; }
        .empty {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 8px;
            color: #999;
        }
        .empty-icon { font-size: 48px; margin-bottom: 20px; }

        /* í† ìŠ¤íŠ¸ ì•Œë¦¼ */
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px; max-width: 350px; }
        .toast { background: white; padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); cursor: pointer; transform: translateX(400px); animation: slideIn 0.3s forwards; border-left: 4px solid #667eea; display: flex; align-items: center; gap: 12px; }
        .toast:hover { box-shadow: 0 6px 16px rgba(0,0,0,0.4); transform: translateY(-2px); }
        .toast.slide-out { animation: slideOut 0.3s forwards; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(400px); opacity: 0; } }
        .toast-icon { font-size: 24px; flex-shrink: 0; }
        .toast-content { flex: 1; min-width: 0; }
        .toast-title { font-weight: bold; color: #333; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .toast-message { font-size: 13px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .toast-close { background: none; border: none; font-size: 20px; color: #999; cursor: pointer; padding: 0; width: 24px; height: 24px; flex-shrink: 0; }
        .toast-close:hover { color: #333; }

        /* ë‹¹ì¼ ì˜ˆì•½ ë°°ë„ˆ */
        #reminderBanner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 9998;
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            padding: 12px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: none;
            animation: slideDown 0.3s ease-out;
        }
        #reminderBanner.show { display: flex; align-items: center; justify-content: space-between; }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
        body.has-banner { padding-top: 60px; }
        #reminderBanner .banner-content { flex: 1; display: flex; align-items: center; gap: 12px; font-weight: bold; }
        #reminderBanner .banner-icon { font-size: 20px; }
        #reminderBanner .banner-close { background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 14px; margin-left: 10px; }
        #reminderBanner .banner-close:hover { background: rgba(255,255,255,0.3); }
        #reminderBanner .banner-link { background: white; color: #dc3545; padding: 6px 16px; border-radius: 4px; text-decoration: none; font-weight: bold; margin-left: 10px; }
        #reminderBanner .banner-link:hover { background: #f8f9fa; }

        /* ë„ì›€ë§ ì„¹ì…˜ (í• ì¼ í˜ì´ì§€ ì „ìš©) */
        .help-section {
            margin-bottom: 25px;
        }
        .help-section-title {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
    </style>
</head>
<body>
    <div id="reminderBanner">
        <div class="banner-content">
            <span class="banner-icon">ğŸ”´</span>
            <span id="bannerText">ì˜¤ëŠ˜ ì˜ˆì•½ì´ ìˆìŠµë‹ˆë‹¤!</span>
        </div>
        <a href="/reminders" class="banner-link">ì˜ˆì•½ í™•ì¸</a>
        <button class="banner-close" onclick="closeBanner()">ë‹«ê¸°</button>
    </div>
    <div class="toast-container" id="toastContainer"></div>
    <div class="container">
        {% include 'includes/header.html' %}

        <!-- ê²€ìƒ‰ ë° í•„í„° ì˜ì—­ -->
        <div style="padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
            <!-- ê²€ìƒ‰ë°” -->
            <div style="margin-bottom: 15px;">
                <input type="text" id="searchInput" placeholder="ğŸ” ì œëª© ë˜ëŠ” ë‚´ìš© ê²€ìƒ‰..." onkeyup="applyFilters()" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; transition: border-color 0.3s;" onfocus="this.style.borderColor='#667eea'" onblur="this.style.borderColor='#ddd'">
            </div>

            <!-- í•„í„° ë° ì •ë ¬ -->
            <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
                <div style="flex: 1; min-width: 150px;">
                    <label style="margin-right: 8px; font-weight: bold; color: #333; font-size: 14px;">ìƒíƒœ:</label>
                    <select id="statusFilter" onchange="applyFilters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        <option value="all">ì „ì²´</option>
                        <option value="ëŒ€ê¸°ì¤‘">ëŒ€ê¸°ì¤‘</option>
                        <option value="ì§„í–‰ì¤‘">ì§„í–‰ì¤‘</option>
                        <option value="ì™„ë£Œ">ì™„ë£Œ</option>
                    </select>
                </div>

                <div style="flex: 1; min-width: 150px;">
                    <label style="margin-right: 8px; font-weight: bold; color: #333; font-size: 14px;">ì •ë ¬:</label>
                    <select id="sortOrder" onchange="applyFilters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                        <option value="newest">ìµœì‹ ìˆœ</option>
                        <option value="oldest">ì˜¤ë˜ëœ ìˆœ</option>
                        <option value="status">ìƒíƒœë³„</option>
                    </select>
                </div>

                <div style="flex: 1; min-width: 150px;">
                    <label style="display: flex; align-items: center; cursor: pointer; font-size: 14px;">
                        <input type="checkbox" id="hideCompleted" onchange="applyFilters()" style="margin-right: 6px; width: 16px; height: 16px; cursor: pointer;">
                        <span style="color: #333; font-weight: bold;">ì™„ë£Œ í•­ëª© ìˆ¨ê¸°ê¸°</span>
                    </label>
                </div>

                <div style="flex: 1; min-width: 150px; text-align: right;">
                    <span id="itemCount" style="font-weight: bold; color: #667eea; font-size: 15px;">ì „ì²´ 0ê±´</span>
                </div>
            </div>
        </div>

        <div id="itemsContainer"></div>
    </div>

    <script>
        // XSS ë°©ì§€ë¥¼ ìœ„í•œ HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
        function escapeHtml(text) {
            if (text === null || text === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        const socket = io();
        const currentUsername = '{{ username }}';
        let previousItemCount = 0;
        let notificationPermission = false;
        let unreadCount = 0;
        let originalTitle = 'ë‚´ í• ë‹¹ ëª©ë¡';
        let titleBlinkInterval = null;
        let allItemsData = [];  // ì „ì²´ ë°ì´í„° ì €ì¥

        // ë‹¹ì¼ + ì§€ë‚œ ì˜ˆì•½ ë°°ë„ˆ ì²´í¬
        async function checkTodayReminders() {
            try {
                const response = await fetch('/api/reminders/banner-check');
                const data = await response.json();

                if (data.has_reminders) {
                    const banner = document.getElementById('reminderBanner');
                    const bannerText = document.getElementById('bannerText');

                    // ë°°ë„ˆ ë©”ì‹œì§€ êµ¬ì„±
                    let message = '';
                    if (data.overdue_count > 0 && data.today_count > 0) {
                        message = `âš ï¸ ì§€ë‚œ ì˜ˆì•½ ${data.overdue_count}ê±´, ì˜¤ëŠ˜ ì˜ˆì•½ ${data.today_count}ê±´ì´ ìˆìŠµë‹ˆë‹¤!`;
                    } else if (data.overdue_count > 0) {
                        message = `âš ï¸ ì§€ë‚œ ì˜ˆì•½ ${data.overdue_count}ê±´ì´ ìˆìŠµë‹ˆë‹¤!`;
                    } else {
                        message = `ì˜¤ëŠ˜ ì˜ˆì•½ ${data.today_count}ê±´ì´ ìˆìŠµë‹ˆë‹¤!`;
                    }

                    bannerText.textContent = message;
                    banner.classList.add('show');
                    document.body.classList.add('has-banner');
                }
            } catch (error) {
                console.log('ì˜ˆì•½ ì²´í¬ ì‹¤íŒ¨:', error);
            }
        }

        function closeBanner() {
            const banner = document.getElementById('reminderBanner');
            banner.classList.remove('show');
            document.body.classList.remove('has-banner');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë‹¹ì¼ ì˜ˆì•½ ì²´í¬
        checkTodayReminders();

        // ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ (ì¦‰ì‹œ ì‹¤í–‰)
        if ('Notification' in window) {
            console.log('Notification API ì§€ì›ë¨. í˜„ì¬ ê¶Œí•œ:', Notification.permission);

            if (Notification.permission === 'default') {
                console.log('ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ ì¤‘...');
                Notification.requestPermission().then(permission => {
                    console.log('ì•Œë¦¼ ê¶Œí•œ ê²°ê³¼:', permission);
                    notificationPermission = permission === 'granted';
                    if (notificationPermission) {
                        // í…ŒìŠ¤íŠ¸ ì•Œë¦¼
                        new Notification('ì•Œë¦¼ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤!', {
                            body: 'ìƒˆë¡œìš´ í•­ëª©ê³¼ ë©”ì‹œì§€ë¥¼ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.',
                            icon: '/favicon.ico'
                        });
                    }
                });
            } else if (Notification.permission === 'granted') {
                notificationPermission = true;
                console.log('ì•Œë¦¼ ê¶Œí•œì´ ì´ë¯¸ í—ˆìš©ë¨');
            } else {
                console.log('ì•Œë¦¼ ê¶Œí•œì´ ì°¨ë‹¨ë¨');
            }
        } else {
            console.log('ì´ ë¸Œë¼ìš°ì €ëŠ” Notification APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
        }

        function showNotification(title, body, url) {
            if (!notificationPermission) return;

            const notification = new Notification(title, {
                body: body,
                icon: '/favicon.ico',
                badge: '/favicon.ico',
                tag: 'crm-notification',
                requireInteraction: false
            });

            notification.onclick = function() {
                window.focus();
                if (url) {
                    window.location.href = url;
                }
                notification.close();
            };
        }

        function loadItems() {
            fetch('/api/items')
                .then(res => res.json())
                .then(data => {
                    // ìƒˆ í•­ëª© ì•Œë¦¼
                    if (previousItemCount > 0 && data.length > previousItemCount) {
                        const newItemsCount = data.length - previousItemCount;
                        showNotification(
                            'ìƒˆë¡œìš´ í•­ëª©ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤',
                            `${newItemsCount}ê°œì˜ ìƒˆ í•­ëª©ì´ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤.`,
                            '/'
                        );
                    }
                    previousItemCount = data.length;

                    allItemsData = data;  // ì „ì²´ ë°ì´í„° ì €ì¥
                    applyFilters();  // í•„í„° ì ìš©
                });
        }

        // í•„í„° ë° ê²€ìƒ‰ ì ìš©
        function applyFilters() {
            const searchText = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const sortOrder = document.getElementById('sortOrder').value;
            const hideCompleted = document.getElementById('hideCompleted').checked;
            const container = document.getElementById('itemsContainer');

            // í•„í„° ì ìš©
            let filteredData = allItemsData;

            // ê²€ìƒ‰ í•„í„°
            if (searchText) {
                filteredData = filteredData.filter(item => {
                    const title = (item.title || '').toLowerCase();
                    const content = (item.content || '').toLowerCase();
                    return title.includes(searchText) || content.includes(searchText);
                });
            }

            // ìƒíƒœ í•„í„°
            if (statusFilter !== 'all') {
                filteredData = filteredData.filter(item => (item.status || 'ëŒ€ê¸°ì¤‘') === statusFilter);
            }

            // ì™„ë£Œ í•­ëª© ìˆ¨ê¸°ê¸°
            if (hideCompleted) {
                filteredData = filteredData.filter(item => (item.status || 'ëŒ€ê¸°ì¤‘') !== 'ì™„ë£Œ');
            }

            // ì •ë ¬
            filteredData = [...filteredData];  // ë³µì‚¬ë³¸ ìƒì„±
            if (sortOrder === 'newest') {
                filteredData.reverse();
            } else if (sortOrder === 'status') {
                const statusOrder = { 'ëŒ€ê¸°ì¤‘': 1, 'ì§„í–‰ì¤‘': 2, 'ì™„ë£Œ': 3 };
                filteredData.sort((a, b) => {
                    const statusA = statusOrder[a.status || 'ëŒ€ê¸°ì¤‘'] || 0;
                    const statusB = statusOrder[b.status || 'ëŒ€ê¸°ì¤‘'] || 0;
                    return statusA - statusB;
                });
            }

            // ê°œìˆ˜ ì—…ë°ì´íŠ¸
            const totalCount = allItemsData.length;
            const filteredCount = filteredData.length;
            const waitingCount = filteredData.filter(item => (item.status || 'ëŒ€ê¸°ì¤‘') === 'ëŒ€ê¸°ì¤‘').length;
            const progressCount = filteredData.filter(item => item.status === 'ì§„í–‰ì¤‘').length;
            const completedCount = filteredData.filter(item => item.status === 'ì™„ë£Œ').length;

            document.getElementById('itemCount').innerHTML = `
                <span style="color: #667eea;">ì§„í–‰ì¤‘ ${progressCount}ê±´</span> /
                <span style="color: #999;">ì „ì²´ ${filteredCount}ê±´</span>
                ${filteredCount !== totalCount ? ` (ì´ ${totalCount}ê±´ ì¤‘)` : ''}
            `;

            // ë Œë”ë§
            if (filteredData.length === 0) {
                container.innerHTML = `
                    <div class="empty">
                        <div class="empty-icon">ğŸ“­</div>
                        <p>ì¡°ê±´ì— ë§ëŠ” í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '<div class="items">' +
                filteredData.map(item => {
                    const status = item.status || 'ëŒ€ê¸°ì¤‘';
                    let nextStatus = '';
                    let nextStatusLabel = '';

                    if (status === 'ëŒ€ê¸°ì¤‘') {
                        nextStatus = 'ì§„í–‰ì¤‘';
                        nextStatusLabel = 'ì§„í–‰ì¤‘ìœ¼ë¡œ ë³€ê²½';
                    } else if (status === 'ì§„í–‰ì¤‘') {
                        nextStatus = 'ì™„ë£Œ';
                        nextStatusLabel = 'ì™„ë£Œë¡œ ë³€ê²½';
                    }

                    return `
                        <div class="item">
                            <h3>${escapeHtml(item.title || 'ì œëª© ì—†ìŒ')}</h3>
                            <div class="item-content">${escapeHtml(item.content || '')}</div>
                            <div class="item-status">
                                <span class="status-badge status-${escapeHtml(status)}">${escapeHtml(status)}</span>
                                ${nextStatus ? `<button class="status-button" onclick="changeStatus(${item.id}, '${nextStatus}')">${nextStatusLabel}</button>` : '<span style="color: #28a745; font-weight: bold;">âœ“ ì™„ë£Œë¨</span>'}
                            </div>
                        </div>
                    `;
                }).join('') +
                '</div>';
        }

        // ë²”ìš© í† ìŠ¤íŠ¸ í•¨ìˆ˜
        function showSimpleToast(title, message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast';

            const icons = {
                'success': 'âœ…',
                'error': 'âŒ',
                'warning': 'âš ï¸',
                'info': 'â„¹ï¸'
            };
            const icon = icons[type] || icons['info'];

            toast.innerHTML = `
                <div class="toast-icon">${icon}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('slide-out');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function changeStatus(id, newStatus) {
            fetch(`/api/items/${id}/status`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            })
            .then(res => res.json())
            .then(() => {
                showSimpleToast('ì„±ê³µ', `ìƒíƒœê°€ "${newStatus}"(ìœ¼)ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                loadItems();
            })
            .catch(err => {
                showSimpleToast('ì˜¤ë¥˜', 'ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            });
        }

        // ì‚¬ìš©ìë³„ roomì— join (ì „ì—­ ì•Œë¦¼ ë°›ê¸° ìœ„í•¨)
        socket.emit('join_user_room', { username: currentUsername });

        // í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ
        function showToast(chatId, title, message, sender) {
            console.log('í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ:', chatId, title, message);
            const toastContainer = document.getElementById('toastContainer');

            const toast = document.createElement('div');
            toast.className = 'toast';

            // HTML ì´ìŠ¤ì¼€ì´í”„
            const escapeHtml = (text) => {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            };

            toast.innerHTML = `
                <div class="toast-icon">ğŸ’¬</div>
                <div class="toast-content">
                    <div class="toast-title">${escapeHtml(title)}</div>
                    <div class="toast-message">${escapeHtml(sender)}: ${escapeHtml(message)}</div>
                </div>
                <button class="toast-close">Ã—</button>
            `;

            // X ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            const closeBtn = toast.querySelector('.toast-close');
            closeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                closeToastElement(toast);
            });

            // í† ìŠ¤íŠ¸ í´ë¦­ì‹œ ì±„íŒ…ë°©ìœ¼ë¡œ ì´ë™
            toast.addEventListener('click', () => {
                location.href = `/chat/${chatId}`;
            });

            toastContainer.appendChild(toast);
            console.log('í† ìŠ¤íŠ¸ ì¶”ê°€ë¨:', toast);

            // 5ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                closeToastElement(toast);
            }, 5000);
        }

        function closeToastElement(toast) {
            if (!toast || !toast.classList) return;
            toast.classList.add('slide-out');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 300);
        }

        // ì „ì—­ ìƒˆ ë©”ì‹œì§€ ì•Œë¦¼ ìˆ˜ì‹ 
        socket.on('global_new_message', (data) => {
            console.log('ì „ì—­ ìƒˆ ë©”ì‹œì§€ ìˆ˜ì‹ :', data);

            // 1:1 ì±„íŒ…ì¸ ê²½ìš° ìƒëŒ€ë°© ì´ë¦„, ê·¸ë£¹ ì±„íŒ…ì¸ ê²½ìš° ì±„íŒ…ë°© ì œëª© í‘œì‹œ
            let displayTitle = data.chat_title;
            if (data.is_one_to_one) {
                const otherUser = data.participants.find(p => p !== currentUsername);
                displayTitle = otherUser || data.chat_title;
            }

            // í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ
            showToast(data.chat_id, displayTitle, data.message, data.sender);

            // íƒ­ì´ í¬ì»¤ìŠ¤ë˜ì–´ ìˆì§€ ì•Šìœ¼ë©´ ì œëª© ê¹œë¹¡ì„
            if (!document.hasFocus()) {
                unreadCount++;
                console.log('ì½ì§€ ì•Šì€ ë©”ì‹œì§€:', unreadCount);
                startTitleBlink();
            }
        });

        // í˜ì´ì§€ í¬ì»¤ìŠ¤ì‹œ ë¦¬ì…‹
        window.addEventListener('focus', () => {
            unreadCount = 0;
            stopTitleBlink();
            document.title = originalTitle;
        });

        function startTitleBlink() {
            if (titleBlinkInterval) return;

            console.log('ì œëª© ê¹œë¹¡ì„ ì‹œì‘:', unreadCount);
            let isOriginal = true;
            titleBlinkInterval = setInterval(() => {
                document.title = isOriginal ? `ğŸ”´ (${unreadCount}) ìƒˆ ë©”ì‹œì§€` : originalTitle;
                isOriginal = !isOriginal;
            }, 1000);
        }

        function stopTitleBlink() {
            if (titleBlinkInterval) {
                clearInterval(titleBlinkInterval);
                titleBlinkInterval = null;
            }
        }

        // ì´ˆê¸° ë¡œë“œ (ì•Œë¦¼ ì—†ì´)
        fetch('/api/items')
            .then(res => res.json())
            .then(data => {
                previousItemCount = data.length;
                loadItems();
            });

        setInterval(loadItems, 5000);  // 5ì´ˆë¡œ ë³€ê²½ (ì„œë²„ ë¶€í•˜ ê°ì†Œ)

        // ë„ì›€ë§ ëª¨ë‹¬ ì œì–´
        function openHelpModal() {
            document.getElementById('helpModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeHelpModal() {
            document.getElementById('helpModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.addEventListener('DOMContentLoaded', () => {
            const helpModal = document.getElementById('helpModal');
            if (helpModal) {
                helpModal.addEventListener('click', (e) => {
                    if (e.target === helpModal) {
                        closeHelpModal();
                    }
                });
            }
        });
</script>

    <!-- Service Worker ë“±ë¡ (ë¡œê·¸ì¸ í›„ì—ë„ ìœ ì§€ë˜ë„ë¡) -->
    <script src="/static/js/sw-register.js"></script>
    <script src="/static/js/sw-auto-update.js"></script>
    <script src="/static/js/push-notifications.js" defer></script>

    <!-- ë„ì›€ë§ ë²„íŠ¼ -->
    <button class="help-button" onclick="openHelpModal()" title="ì‚¬ìš©ë²• ë„ì›€ë§">
        â“
    </button>

    <!-- ë„ì›€ë§ ëª¨ë‹¬ -->
    <div class="help-modal" id="helpModal">
        <div class="help-modal-content">
            <div class="help-modal-header">
                <div class="help-modal-title">
                    ğŸ“– ë‚´ í• ë‹¹ ëª©ë¡ ì‚¬ìš©ë²•
                </div>
                <button class="help-modal-close" onclick="closeHelpModal()">&times;</button>
            </div>

            <div class="help-modal-body">
            <div class="help-section">
                <div class="help-section-title">ğŸ“‹ í• ì¼ í™•ì¸í•˜ê¸°</div>
                <div class="help-content">
                    <ul>
                        <li>ë‚˜ì—ê²Œ ë°°ì •ëœ í• ì¼ë§Œ í‘œì‹œë©ë‹ˆë‹¤</li>
                        <li>ê° í• ì¼ ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ <strong>ìƒì„¸ ì •ë³´</strong>ë¥¼ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
                        <li><strong>ìš°ì„ ìˆœìœ„</strong>ì— ë”°ë¼ ìƒ‰ìƒì´ ë‹¤ë¥´ê²Œ í‘œì‹œë©ë‹ˆë‹¤</li>
                    </ul>
                </div>
            </div>

            <div class="help-section">
                <div class="help-section-title">âœ… í• ì¼ ì™„ë£Œ ì²˜ë¦¬</div>
                <div class="help-content">
                    <ul>
                        <li>í• ì¼ ì¹´ë“œì˜ <strong>"ì™„ë£Œë¡œ ë³€ê²½"</strong> ë²„íŠ¼ì„ í´ë¦­í•©ë‹ˆë‹¤</li>
                        <li>ì™„ë£Œëœ í• ì¼ì€ íšŒìƒ‰ìœ¼ë¡œ í‘œì‹œë˜ë©° ì¤„ í‘œì‹œë©ë‹ˆë‹¤</li>
                        <li>ê´€ë¦¬ìì—ê²Œ ì™„ë£Œ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤</li>
                    </ul>
                </div>
            </div>

            <div class="help-section">
                <div class="help-section-title">ğŸ¨ ìš°ì„ ìˆœìœ„ ìƒ‰ìƒ</div>
                <div class="help-content">
                    <ul>
                        <li><strong style="color: #dc3545;">ë¹¨ê°„ìƒ‰</strong>: ë†’ìŒ - ê¸´ê¸‰í•œ í• ì¼</li>
                        <li><strong style="color: #ffc107;">ë…¸ë€ìƒ‰</strong>: ì¤‘ê°„ - ì¤‘ìš”í•œ í• ì¼</li>
                        <li><strong style="color: #28a745;">ì´ˆë¡ìƒ‰</strong>: ë‚®ìŒ - ì—¬ìœ ìˆëŠ” í• ì¼</li>
                    </ul>
                </div>
            </div>

            <div class="help-section">
                <div class="help-section-title">ğŸ’¬ ì‹¤ì‹œê°„ ì•Œë¦¼</div>
                <div class="help-content">
                    <ul>
                        <li>ìƒˆë¡œìš´ í• ì¼ì´ ë°°ì •ë˜ë©´ <strong>ì‹¤ì‹œê°„ ì•Œë¦¼</strong>ì´ í‘œì‹œë©ë‹ˆë‹¤</li>
                        <li>ìš°ì¸¡ í•˜ë‹¨ì˜ í† ìŠ¤íŠ¸ ì•Œë¦¼ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
                        <li>ì±„íŒ… ë©”ì‹œì§€ë„ ì‹¤ì‹œê°„ìœ¼ë¡œ ì•Œë¦¼ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
                    </ul>
                </div>
            </div>

            <div class="help-section">
                <div class="help-section-title">ğŸ¨ í—¤ë” í™”ë©´ ì„¤ì •</div>
                <div class="help-content">
                    <ul>
                        <li><strong>ë‹¤í¬ëª¨ë“œ í† ê¸€</strong>: í—¤ë” ìš°ì¸¡ì˜ â˜€ï¸/ğŸŒ™ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ë¼ì´íŠ¸/ë‹¤í¬ ëª¨ë“œ ì „í™˜</li>
                        <li><strong>ê¸€ì í¬ê¸° ì¡°ì ˆ</strong>: í—¤ë”ì˜ [ê°€][ê°€][ê°€] ë²„íŠ¼ìœ¼ë¡œ ì‘ê²Œ/ë³´í†µ/í¬ê²Œ ì¡°ì ˆ</li>
                        <li>ì„¤ì •ì€ ë¸Œë¼ìš°ì €ì— ìë™ ì €ì¥ë˜ì–´ ë‹¤ìŒ ì ‘ì† ì‹œì—ë„ ìœ ì§€ë©ë‹ˆë‹¤</li>
                    </ul>
                </div>
            </div>

            <div class="help-tip">
                <strong>ğŸ’¡ Tip:</strong> ë§ˆê°ì¼ì´ ê°€ê¹Œìš´ í• ì¼ë¶€í„° ì²˜ë¦¬í•˜ì„¸ìš”! ì™„ë£Œëœ í• ì¼ì€ ìë™ìœ¼ë¡œ ê´€ë¦¬ìì—ê²Œ ë³´ê³ ë˜ë¯€ë¡œ ë”°ë¡œ ì—°ë½í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.
            </div>
            </div><!-- help-modal-body ë -->
        </div>
    </div>

    {% include 'includes/today_reminders.html' %}
</body>
</html>
