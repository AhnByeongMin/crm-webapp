{% include 'includes/alert_modal.html' %}

<style>
/* ì¼ê´„ë“±ë¡ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
.bulk-upload-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10002; align-items: center; justify-content: center; }
.bulk-upload-modal.show { display: flex; }
.bulk-upload-modal-content { background: white; border-radius: 12px; max-width: 90%; width: 1200px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
.bulk-modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 30px; border-bottom: 2px solid #667eea; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px 12px 0 0; }
.bulk-modal-title { font-size: 24px; font-weight: bold; color: white; }
.bulk-modal-body { padding: 30px; overflow-y: auto; flex: 1; }

/* íƒ­ ìŠ¤íƒ€ì¼ */
.bulk-tab { transition: all 0.3s ease; }
.bulk-tab:hover { opacity: 0.8; }
.upload-section { margin-bottom: 30px; }
.upload-section-title { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 15px; }
.upload-area { border: 2px dashed #667eea; border-radius: 8px; padding: 30px; text-align: center; background: #f8f9fa; transition: all 0.3s; cursor: pointer; }
.upload-area:hover { background: #e9ecef; border-color: #5568d3; }
.upload-area.dragover { background: #d4edda; border-color: #28a745; }
.upload-icon { font-size: 48px; margin-bottom: 15px; }
.upload-text { font-size: 16px; color: #666; margin-bottom: 10px; }
.upload-input { display: none; }
.preview-section { display: none; }
.preview-section.active { display: block; }
.preview-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
.preview-table th { background: #667eea; color: white; padding: 12px 8px; text-align: left; font-weight: bold; position: sticky; top: 0; z-index: 1; }
.preview-table td { padding: 10px 8px; border: 1px solid #ddd; }
.preview-table tr:nth-child(even) { background: #f8f9fa; }
.preview-table tr:hover { background: #e9ecef; }
.preview-table input, .preview-table textarea { width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; }
.preview-table textarea { min-height: 60px; resize: vertical; }
.btn-success { background: #28a745; color: white; }
.btn-success:hover { background: #218838; }
.btn-remove-row { padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
.btn-remove-row:hover { background: #c82333; }
.preview-info { background: #d1ecf1; border-left: 4px solid #0c5460; padding: 12px 15px; margin-bottom: 15px; border-radius: 4px; }
.preview-info strong { color: #0c5460; }
</style>

<!-- ì¼ê´„ë“±ë¡ ëª¨ë‹¬ -->
<div class="bulk-upload-modal" id="bulkUploadModal">
    <div class="bulk-upload-modal-content">
        <div class="bulk-modal-header">
            <div class="bulk-modal-title">ğŸ“Š í”„ë¡œëª¨ì…˜ ì¼ê´„ë“±ë¡</div>
            <button class="close-btn" onclick="closeBulkUploadModal()">&times;</button>
        </div>
        <div class="bulk-modal-body">
            <!-- 1ë‹¨ê³„: ì–‘ì‹ ë‹¤ìš´ë¡œë“œ ë° ì—…ë¡œë“œ -->
            <!-- íƒ­ ì „í™˜ -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e9ecef;">
                <button class="bulk-tab active" id="excelTab" onclick="switchBulkTab('excel')" style="flex: 1; padding: 12px; border: none; background: none; cursor: pointer; font-weight: bold; color: #667eea; border-bottom: 3px solid #667eea;">
                    ğŸ“ ì—‘ì…€ ì—…ë¡œë“œ
                </button>
                <button class="bulk-tab" id="manualTab" onclick="switchBulkTab('manual')" style="flex: 1; padding: 12px; border: none; background: none; cursor: pointer; font-weight: bold; color: #999; border-bottom: 3px solid transparent;">
                    âœï¸ ì§ì ‘ ì…ë ¥
                </button>
            </div>

            <!-- ì—‘ì…€ ì—…ë¡œë“œ ì„¹ì…˜ -->
            <div class="upload-section" id="uploadSection">
                <div class="upload-section-title">1ë‹¨ê³„: ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</div>

                <!-- ë„ì›€ë§ ì•ˆë‚´ -->
                <div style="background: #f8f9fa; border-left: 4px solid #667eea; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                    <div style="font-weight: bold; color: #333; margin-bottom: 10px;">ğŸ“Œ ì‚¬ìš© ë°©ë²•</div>
                    <ol style="margin: 0; padding-left: 20px; color: #555; font-size: 13px; line-height: 1.8;">
                        <li><strong>ì–‘ì‹ ë‹¤ìš´ë¡œë“œ:</strong> ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì—‘ì…€ ì–‘ì‹ì„ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”</li>
                        <li><strong>ë°ì´í„° ì…ë ¥:</strong> ì–‘ì‹ì˜ 18í–‰ë¶€í„° ì‹¤ì œ ë°ì´í„°ë¥¼ ì…ë ¥í•˜ì„¸ìš” (17í–‰ì€ í—¤ë”)
                            <ul style="margin-top: 5px; padding-left: 20px;">
                                <li>ë…¸ë€ìƒ‰ í•„ë“œ(ëŒ€ë¶„ë¥˜, ìƒí’ˆëª…, ì±„ë„, í”„ë¡œëª¨ì…˜ëª…, ë‚´ìš©, ì‹œì‘ì¼)ëŠ” <strong>í•„ìˆ˜ ì…ë ¥</strong></li>
                                <li>íšŒìƒ‰ í•„ë“œëŠ” ì„ íƒ ì…ë ¥</li>
                                <li>5-6í–‰ì˜ ì˜ˆì‹œ ë°ì´í„°ëŠ” ì°¸ê³ ìš©ì´ë©° ìë™ìœ¼ë¡œ ë¬´ì‹œë©ë‹ˆë‹¤</li>
                            </ul>
                        </li>
                        <li><strong>íŒŒì¼ ì—…ë¡œë“œ:</strong> ì‘ì„±í•œ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ë¯¸ë¦¬ë³´ê¸° ë° ìˆ˜ì •</li>
                        <li><strong>ì¼ê´„ ë“±ë¡:</strong> ìµœì¢… í™•ì¸ í›„ ì¼ê´„ ë“±ë¡ ë²„íŠ¼ í´ë¦­</li>
                    </ol>
                </div>

                <div style="margin-bottom: 15px;">
                    <button class="btn btn-secondary" onclick="downloadTemplate()">ğŸ“¥ ì–‘ì‹ ë‹¤ìš´ë¡œë“œ</button>
                    <span style="margin-left: 10px; color: #666; font-size: 14px;">â€» ì œê³µëœ ì–‘ì‹ì„ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ì‘ì„± í›„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”</span>
                </div>
                <div class="upload-area" id="uploadArea" onclick="document.getElementById('excelFile').click()">
                    <div class="upload-icon">ğŸ“„</div>
                    <div class="upload-text">ì—‘ì…€ íŒŒì¼ì„ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</div>
                    <small style="color: #999;">ì§€ì› í˜•ì‹: .xlsx, .xls</small>
                    <input type="file" id="excelFile" class="upload-input" accept=".xlsx,.xls" onchange="handleFileUpload(event)">
                </div>
            </div>

            <!-- ì§ì ‘ ì…ë ¥ ì„¹ì…˜ -->
            <div class="manual-section" id="manualSection" style="display: none;">
                <div class="upload-section-title">ì§ì ‘ ì…ë ¥ ëª¨ë“œ</div>

                <!-- ë„ì›€ë§ ì•ˆë‚´ -->
                <div style="background: #f0f8ff; border-left: 4px solid #667eea; padding: 15px; margin-bottom: 20px; border-radius: 4px;">
                    <div style="font-weight: bold; color: #333; margin-bottom: 10px;">âœï¸ ì§ì ‘ ì…ë ¥ ë°©ë²•</div>
                    <ul style="margin: 0; padding-left: 20px; color: #555; font-size: 13px; line-height: 1.8;">
                        <li><strong>í–‰ ì¶”ê°€:</strong> ì•„ë˜ "â• ìƒˆ í–‰ ì¶”ê°€" ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ë¹ˆ í–‰ì„ ì¶”ê°€í•˜ì„¸ìš”</li>
                        <li><strong>ë°ì´í„° ì…ë ¥:</strong> ê° í•„ë“œì— ì§ì ‘ ë°ì´í„°ë¥¼ ì…ë ¥í•˜ì„¸ìš”
                            <ul style="margin-top: 5px; padding-left: 20px;">
                                <li>í•„ìˆ˜ í•­ëª©: ëŒ€ë¶„ë¥˜, ìƒí’ˆëª…, ì±„ë„, í”„ë¡œëª¨ì…˜ëª…, ë‚´ìš©, ì‹œì‘ì¼</li>
                                <li>ì„ íƒ í•­ëª©: ê¸ˆì•¡í• ì¸, íšŒì°¨ë©´ì œ, ì¤‘ë³µì—¬ë¶€, í”„ë¡œëª¨ì…˜ì½”ë“œ, ì¢…ë£Œì¼</li>
                            </ul>
                        </li>
                        <li><strong>í–‰ ì‚­ì œ:</strong> ê° í–‰ì˜ ì‚­ì œ ë²„íŠ¼ìœ¼ë¡œ ë¶ˆí•„ìš”í•œ í–‰ì„ ì œê±°í•˜ì„¸ìš”</li>
                        <li><strong>ì¼ê´„ ë“±ë¡:</strong> ì…ë ¥ ì™„ë£Œ í›„ í•˜ë‹¨ì˜ "âœ… ì¼ê´„ ë“±ë¡" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</li>
                    </ul>
                </div>

                <div style="margin-bottom: 15px;">
                    <button class="btn btn-primary" onclick="addNewRow()">â• ìƒˆ í–‰ ì¶”ê°€</button>
                    <button class="btn btn-secondary" onclick="addMultipleRows()" style="margin-left: 10px;">â• 5í–‰ ì¶”ê°€</button>
                    <span style="margin-left: 15px; color: #666; font-size: 14px;">â€» í•„ìš”í•œ ë§Œí¼ í–‰ì„ ì¶”ê°€í•˜ì—¬ ì…ë ¥í•˜ì„¸ìš”</span>
                </div>
            </div>

            <!-- 2ë‹¨ê³„: ë¯¸ë¦¬ë³´ê¸° ë° ìˆ˜ì • -->
            <div class="preview-section" id="previewSection">
                <div class="upload-section-title">2ë‹¨ê³„: ë¯¸ë¦¬ë³´ê¸° ë° ìˆ˜ì •</div>
                <div class="preview-info" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div>
                        <strong>ğŸ“Œ ì•Œë¦¼:</strong> <span id="previewCount">0</span>ê°œì˜ í”„ë¡œëª¨ì…˜ì´ ë“±ë¡ ì˜ˆì •ì…ë‹ˆë‹¤. ì•„ë˜ í…Œì´ë¸”ì—ì„œ ë‚´ìš©ì„ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-sm btn-secondary" onclick="addNewRow()" style="padding: 6px 12px; font-size: 13px;">â• í–‰ ì¶”ê°€</button>
                        <button class="btn btn-sm btn-secondary" onclick="addMultipleRows()" style="padding: 6px 12px; font-size: 13px;">â• 5í–‰ ì¶”ê°€</button>
                    </div>
                </div>
                <div style="overflow-x: auto; max-height: 400px;">
                    <table class="preview-table" id="previewTable">
                        <thead>
                            <tr>
                                <th style="width: 40px;">#</th>
                                <th style="width: 100px;">ëŒ€ë¶„ë¥˜</th>
                                <th style="width: 150px;">ìƒí’ˆëª… *</th>
                                <th style="width: 100px;">ì±„ë„ *</th>
                                <th style="width: 150px;">í”„ë¡œëª¨ì…˜ëª… *</th>
                                <th style="width: 100px;">ê¸ˆì•¡í• ì¸</th>
                                <th style="width: 100px;">íšŒì°¨ë©´ì œ</th>
                                <th style="width: 120px;">ì¤‘ë³µì—¬ë¶€</th>
                                <th style="width: 120px;">í”„ë¡œëª¨ì…˜ì½”ë“œ</th>
                                <th style="width: 200px;">í”„ë¡œëª¨ì…˜ë‚´ìš© *</th>
                                <th style="width: 100px;">ì‹œì‘ì¼ *</th>
                                <th style="width: 100px;">ì¢…ë£Œì¼</th>
                                <th style="width: 60px;">ì‚­ì œ</th>
                            </tr>
                        </thead>
                        <tbody id="previewTableBody">
                            <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="form-actions" style="padding: 20px 30px; border-top: 1px solid #ddd;">
            <button class="btn btn-secondary" onclick="closeBulkUploadModal()">ì·¨ì†Œ</button>
            <button class="btn btn-success" id="bulkSaveBtn" style="display: none;" onclick="saveBulkPromotions()">âœ… ì¼ê´„ ë“±ë¡</button>
        </div>
    </div>
</div>

<script>
let bulkPromotionsData = [];
let currentBulkMode = 'excel'; // 'excel' ë˜ëŠ” 'manual'

// ì¼ê´„ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°
function openBulkUploadModal() {
    document.getElementById('bulkUploadModal').classList.add('show');
    resetBulkModal();
}

// ì¼ê´„ë“±ë¡ ëª¨ë‹¬ ë‹«ê¸°
function closeBulkUploadModal() {
    document.getElementById('bulkUploadModal').classList.remove('show');
    resetBulkModal();
}

// ëª¨ë‹¬ ì´ˆê¸°í™”
function resetBulkModal() {
    document.getElementById('excelFile').value = '';
    document.getElementById('uploadSection').style.display = 'block';
    document.getElementById('manualSection').style.display = 'none';
    document.getElementById('previewSection').classList.remove('active');
    document.getElementById('bulkSaveBtn').style.display = 'none';
    bulkPromotionsData = [];
    currentBulkMode = 'excel';

    // íƒ­ ì´ˆê¸°í™”
    document.getElementById('excelTab').classList.add('active');
    document.getElementById('excelTab').style.color = '#667eea';
    document.getElementById('excelTab').style.borderBottomColor = '#667eea';
    document.getElementById('manualTab').classList.remove('active');
    document.getElementById('manualTab').style.color = '#999';
    document.getElementById('manualTab').style.borderBottomColor = 'transparent';
}

// íƒ­ ì „í™˜
function switchBulkTab(mode) {
    currentBulkMode = mode;

    const excelTab = document.getElementById('excelTab');
    const manualTab = document.getElementById('manualTab');
    const uploadSection = document.getElementById('uploadSection');
    const manualSection = document.getElementById('manualSection');
    const previewSection = document.getElementById('previewSection');

    if (mode === 'excel') {
        // ì—‘ì…€ íƒ­ í™œì„±í™”
        excelTab.classList.add('active');
        excelTab.style.color = '#667eea';
        excelTab.style.borderBottomColor = '#667eea';
        manualTab.classList.remove('active');
        manualTab.style.color = '#999';
        manualTab.style.borderBottomColor = 'transparent';

        uploadSection.style.display = 'block';
        manualSection.style.display = 'none';

        // ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë¯¸ë¦¬ë³´ê¸° ìœ ì§€
        if (bulkPromotionsData.length > 0) {
            previewSection.classList.add('active');
            document.getElementById('bulkSaveBtn').style.display = 'inline-block';
        }
    } else {
        // ì§ì ‘ ì…ë ¥ íƒ­ í™œì„±í™”
        manualTab.classList.add('active');
        manualTab.style.color = '#667eea';
        manualTab.style.borderBottomColor = '#667eea';
        excelTab.classList.remove('active');
        excelTab.style.color = '#999';
        excelTab.style.borderBottomColor = 'transparent';

        uploadSection.style.display = 'none';
        manualSection.style.display = 'block';

        // ì§ì ‘ ì…ë ¥ ëª¨ë“œì—ì„œëŠ” í•­ìƒ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
        previewSection.classList.add('active');
        document.getElementById('bulkSaveBtn').style.display = 'inline-block';

        // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¹ˆ í–‰ 1ê°œ ì¶”ê°€
        if (bulkPromotionsData.length === 0) {
            addNewRow();
        }
    }
}

// ìƒˆ í–‰ ì¶”ê°€
function addNewRow() {
    const newPromo = {
        category: '',
        product_name: '',
        channel: '',
        promotion_name: '',
        discount_amount: '',
        session_exemption: '',
        subscription_types: [],
        promotion_code: '',
        content: '',
        start_date: '',
        end_date: ''
    };

    bulkPromotionsData.push(newPromo);
    renderPreviewTable();

    // ë¯¸ë¦¬ë³´ê¸° ì„¹ì…˜ í‘œì‹œ
    document.getElementById('previewSection').classList.add('active');
    document.getElementById('bulkSaveBtn').style.display = 'inline-block';

    // ë§ˆì§€ë§‰ í–‰ìœ¼ë¡œ ìŠ¤í¬ë¡¤
    setTimeout(() => {
        const tbody = document.getElementById('previewTableBody');
        const lastRow = tbody.lastElementChild;
        if (lastRow) {
            lastRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }, 100);
}

// ì—¬ëŸ¬ í–‰ ì¶”ê°€
function addMultipleRows() {
    for (let i = 0; i < 5; i++) {
        const newPromo = {
            category: '',
            product_name: '',
            channel: '',
            promotion_name: '',
            discount_amount: '',
            session_exemption: '',
            subscription_types: [],
            promotion_code: '',
            content: '',
            start_date: '',
            end_date: ''
        };
        bulkPromotionsData.push(newPromo);
    }

    renderPreviewTable();

    // ë¯¸ë¦¬ë³´ê¸° ì„¹ì…˜ í‘œì‹œ
    document.getElementById('previewSection').classList.add('active');
    document.getElementById('bulkSaveBtn').style.display = 'inline-block';
}

// ì–‘ì‹ ë‹¤ìš´ë¡œë“œ (Fetch + Blobìœ¼ë¡œ Mixed Content ê²½ê³  ë°©ì§€)
async function downloadTemplate() {
    try {
        const response = await fetch('/api/promotions/template');
        if (!response.ok) throw new Error('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨');

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'í”„ë¡œëª¨ì…˜_ì¼ê´„ë“±ë¡_ì–‘ì‹.xlsx';
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
    } catch (error) {
        showAlert('ì–‘ì‹ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
    }
}

// ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸
const uploadArea = document.getElementById('uploadArea');
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});
uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});
uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        document.getElementById('excelFile').files = files;
        handleFileUpload({ target: { files } });
    }
});

// íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
async function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
        showSimpleToast('ì˜¤ë¥˜', 'ì—‘ì…€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error');
        return;
    }

    // FormData ìƒì„±
    const formData = new FormData();
    formData.append('file', file);

    try {
        const response = await fetch('/api/promotions/bulk-upload', {
            method: 'POST',
            body: formData
        });

        const result = await response.json();

        if (response.ok) {
            bulkPromotionsData = result.data;
            renderPreviewTable();
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('previewSection').classList.add('active');
            document.getElementById('bulkSaveBtn').style.display = 'inline-block';
            showSimpleToast('ì„±ê³µ', `${result.count}ê°œì˜ í”„ë¡œëª¨ì…˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤`, 'success');
        } else {
            showSimpleToast('ì˜¤ë¥˜', result.error || 'íŒŒì¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        }
    } catch (error) {
        console.error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
        showSimpleToast('ì˜¤ë¥˜', 'íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    }
}

// ë¯¸ë¦¬ë³´ê¸° í…Œì´ë¸” ë Œë”ë§
function renderPreviewTable() {
    const tbody = document.getElementById('previewTableBody');
    document.getElementById('previewCount').textContent = bulkPromotionsData.length;

    tbody.innerHTML = bulkPromotionsData.map((promo, index) => `
        <tr data-index="${index}">
            <td>${index + 1}</td>
            <td><input type="text" value="${promo.category || ''}" onchange="updateBulkData(${index}, 'category', this.value)"></td>
            <td><input type="text" value="${promo.product_name}" onchange="updateBulkData(${index}, 'product_name', this.value)" required></td>
            <td><input type="text" value="${promo.channel}" onchange="updateBulkData(${index}, 'channel', this.value)" required></td>
            <td><input type="text" value="${promo.promotion_name}" onchange="updateBulkData(${index}, 'promotion_name', this.value)" required></td>
            <td><input type="text" value="${promo.discount_amount || ''}" onchange="updateBulkData(${index}, 'discount_amount', this.value)"></td>
            <td><input type="text" value="${promo.session_exemption || ''}" onchange="updateBulkData(${index}, 'session_exemption', this.value)"></td>
            <td><input type="text" value="${(promo.subscription_types || []).join(',')}" onchange="updateBulkData(${index}, 'subscription_types', this.value.split(',').map(t => t.trim()).filter(t => t))"></td>
            <td><input type="text" value="${promo.promotion_code || ''}" onchange="updateBulkData(${index}, 'promotion_code', this.value)"></td>
            <td><textarea onchange="updateBulkData(${index}, 'content', this.value)" required>${promo.content}</textarea></td>
            <td><input type="date" value="${promo.start_date}" onchange="updateBulkData(${index}, 'start_date', this.value)" required></td>
            <td><input type="text" value="${promo.end_date}" onchange="updateBulkData(${index}, 'end_date', this.value)"></td>
            <td><button class="btn-remove-row" onclick="removeBulkRow(${index})">ì‚­ì œ</button></td>
        </tr>
    `).join('');
}

// ë°ì´í„° ì—…ë°ì´íŠ¸
function updateBulkData(index, field, value) {
    if (bulkPromotionsData[index]) {
        bulkPromotionsData[index][field] = value;
    }
}

// í–‰ ì‚­ì œ
function removeBulkRow(index) {
    if (confirm('ì´ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        bulkPromotionsData.splice(index, 1);
        renderPreviewTable();

        if (bulkPromotionsData.length === 0) {
            resetBulkModal();
        }
    }
}

// ì¼ê´„ ì €ì¥
async function saveBulkPromotions() {
    // í•„ìˆ˜ í•„ë“œ ê²€ì¦
    const errors = [];
    bulkPromotionsData.forEach((promo, index) => {
        if (!promo.product_name || !promo.channel || !promo.promotion_name || !promo.content || !promo.start_date) {
            errors.push(`í–‰ ${index + 1}: í•„ìˆ˜ í•­ëª©ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤`);
        }
    });

    if (errors.length > 0) {
        showSimpleToast('ì˜¤ë¥˜', errors.join('\n'), 'error');
        return;
    }

    if (!confirm(`${bulkPromotionsData.length}ê°œì˜ í”„ë¡œëª¨ì…˜ì„ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }

    try {
        const response = await fetch('/api/promotions/bulk-save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ promotions: bulkPromotionsData })
        });

        const result = await response.json();

        if (response.ok) {
            showSimpleToast('ì„±ê³µ', result.message || 'í”„ë¡œëª¨ì…˜ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            closeBulkUploadModal();
            loadPromotions();
            loadFilters();
        } else {
            showSimpleToast('ì˜¤ë¥˜', result.error || 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
        }
    } catch (error) {
        console.error('ì €ì¥ ì‹¤íŒ¨:', error);
        showSimpleToast('ì˜¤ë¥˜', 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤', 'error');
    }
}

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.addEventListener('DOMContentLoaded', () => {
    const bulkModal = document.getElementById('bulkUploadModal');
    if (bulkModal) {
        bulkModal.addEventListener('click', (e) => {
            if (e.target === bulkModal) {
                closeBulkUploadModal();
            }
        });
    }
});
</script>
