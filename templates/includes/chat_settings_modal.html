<style>
/* ì±„íŒ…ë°© ì„¤ì • ëª¨ë‹¬ */
.chat-settings-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 10003;
    align-items: center;
    justify-content: center;
}
.chat-settings-modal.show {
    display: flex;
}
.chat-settings-content {
    background: white;
    border-radius: 12px;
    max-width: 500px;
    width: 95%;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}
.chat-settings-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    border-bottom: 2px solid #667eea;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px 12px 0 0;
}
.chat-settings-title {
    font-size: 20px;
    font-weight: bold;
    color: white;
}
.chat-settings-close {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}
.chat-settings-close:hover {
    background: rgba(255,255,255,0.3);
}
.chat-settings-body {
    padding: 20px;
    overflow-y: auto;
    flex: 1;
}
.setting-section {
    margin-bottom: 25px;
}
.setting-section-title {
    font-size: 14px;
    font-weight: bold;
    color: #667eea;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.setting-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 15px;
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 8px;
}
.setting-row:last-child {
    margin-bottom: 0;
}
.setting-label {
    font-weight: 600;
    color: #333;
}
.setting-value {
    color: #666;
    font-size: 14px;
}
.setting-input {
    flex: 1;
    margin-left: 15px;
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
}
.setting-input:focus {
    border-color: #667eea;
    outline: none;
}

/* í† ê¸€ ìŠ¤ìœ„ì¹˜ */
.toggle-switch {
    position: relative;
    width: 50px;
    height: 26px;
}
.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}
.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .3s;
    border-radius: 26px;
}
.toggle-slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: .3s;
    border-radius: 50%;
}
input:checked + .toggle-slider {
    background-color: #667eea;
}
input:checked + .toggle-slider:before {
    transform: translateX(24px);
}

/* ì°¸ì—¬ì ëª©ë¡ */
.participant-list {
    max-height: 250px;
    overflow-y: auto;
}
.participant-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 12px;
    background: #f8f9fa;
    border-radius: 8px;
    margin-bottom: 6px;
}
.participant-item:last-child {
    margin-bottom: 0;
}
.participant-info {
    display: flex;
    align-items: center;
    gap: 10px;
}
.participant-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #667eea;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
}
.participant-name {
    font-weight: 600;
    color: #333;
}
.participant-role {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: 10px;
    margin-left: 8px;
}
.role-owner {
    background: #ffd700;
    color: #333;
}
.role-admin {
    background: #667eea;
    color: white;
}
.role-member {
    background: #e9ecef;
    color: #666;
}
.participant-actions {
    display: flex;
    gap: 5px;
}
.participant-actions button {
    padding: 5px 10px;
    font-size: 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}
.btn-admin {
    background: #667eea;
    color: white;
}
.btn-admin:hover {
    background: #5568d3;
}
.btn-remove-admin {
    background: #6c757d;
    color: white;
}
.btn-kick {
    background: #dc3545;
    color: white;
}
.btn-kick:hover {
    background: #c82333;
}

/* ë©¤ë²„ ì¶”ê°€ */
.add-member-section {
    display: flex;
    gap: 10px;
    margin-top: 10px;
}
.add-member-section input {
    flex: 1;
    padding: 10px 15px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
}
.add-member-section input:focus {
    border-color: #667eea;
    outline: none;
}
.add-member-section button {
    padding: 10px 20px;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: bold;
    cursor: pointer;
}
.add-member-section button:hover {
    background: #218838;
}

/* ìœ„í—˜ ì˜ì—­ */
.danger-section {
    border: 2px solid #dc3545;
    border-radius: 8px;
    padding: 15px;
    background: #fff5f5;
}
.danger-section .setting-section-title {
    color: #dc3545;
}
.btn-leave {
    width: 100%;
    padding: 12px;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    font-weight: bold;
    cursor: pointer;
}
.btn-leave:hover {
    background: #c82333;
}

/* 1:1 ì±„íŒ… ì•ˆë‚´ */
.direct-chat-notice {
    padding: 20px;
    text-align: center;
    color: #666;
}
.direct-chat-notice p {
    margin-bottom: 10px;
}

/* ë‹¤í¬ëª¨ë“œ */
[data-theme="dark"] .chat-settings-content {
    background: #1e1e1e;
    color: #e0e0e0;
}
[data-theme="dark"] .setting-row,
[data-theme="dark"] .participant-item {
    background: #2a2a2a;
}
[data-theme="dark"] .setting-label,
[data-theme="dark"] .participant-name {
    color: #e0e0e0;
}
[data-theme="dark"] .setting-value {
    color: #aaa;
}
[data-theme="dark"] .setting-input,
[data-theme="dark"] .add-member-section input {
    background: #333;
    color: #e0e0e0;
    border-color: #555;
}
[data-theme="dark"] .danger-section {
    background: #3d2020;
}
[data-theme="dark"] .role-member {
    background: #444;
    color: #ccc;
}

/* ë°˜ì‘í˜• */
@media (max-width: 480px) {
    .chat-settings-content {
        width: 100%;
        max-height: 100vh;
        border-radius: 0;
    }
    .chat-settings-header {
        border-radius: 0;
    }
    .participant-actions {
        flex-direction: column;
    }
    .add-member-section {
        flex-direction: column;
    }
}
</style>

<!-- ì±„íŒ…ë°© ì„¤ì • ëª¨ë‹¬ -->
<div id="chatSettingsModal" class="chat-settings-modal">
    <div class="chat-settings-content">
        <div class="chat-settings-header">
            <span class="chat-settings-title">âš™ï¸ ì±„íŒ…ë°© ì„¤ì •</span>
            <button class="chat-settings-close" onclick="closeChatSettings()">&times;</button>
        </div>
        <div class="chat-settings-body" id="chatSettingsBody">
            <!-- ë™ì ìœ¼ë¡œ ë¡œë“œ -->
            <div style="text-align: center; padding: 40px; color: #999;">
                ë¡œë”© ì¤‘...
            </div>
        </div>
    </div>
</div>

<script>
// ì±„íŒ…ë°© ì„¤ì • ê´€ë ¨ í•¨ìˆ˜ë“¤
let chatSettingsData = null;

async function openChatSettings() {
    const modal = document.getElementById('chatSettingsModal');
    const body = document.getElementById('chatSettingsBody');
    modal.classList.add('show');

    body.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">ë¡œë”© ì¤‘...</div>';

    try {
        const response = await fetch(`/api/chats/${chatId}/settings`);
        if (!response.ok) {
            throw new Error('ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
        chatSettingsData = await response.json();
        renderChatSettings();
    } catch (error) {
        body.innerHTML = `<div style="text-align: center; padding: 40px; color: #dc3545;">${error.message}</div>`;
    }
}

function closeChatSettings() {
    document.getElementById('chatSettingsModal').classList.remove('show');
}

function renderChatSettings() {
    const body = document.getElementById('chatSettingsBody');
    const data = chatSettingsData;
    const isGroup = data.chat_type === 'group';
    const isOwner = data.my_role === 'owner';
    const isAdmin = data.my_role === 'admin';
    const canManage = isOwner || isAdmin;

    let html = '';

    // ê¸°ë³¸ ì •ë³´
    html += `
        <div class="setting-section">
            <div class="setting-section-title">ğŸ“‹ ì±„íŒ…ë°© ì •ë³´</div>
            <div class="setting-row">
                <span class="setting-label">ìœ í˜•</span>
                <span class="setting-value">${isGroup ? 'ê·¸ë£¹ ì±„íŒ…' : '1:1 ì±„íŒ…'}</span>
            </div>
    `;

    if (isGroup && canManage) {
        // ì œëª© ë³€ê²½ ê°€ëŠ¥
        html += `
            <div class="setting-row">
                <span class="setting-label">ì œëª©</span>
                <input type="text" class="setting-input" id="chatTitleInput"
                       value="${escapeHtml(data.title)}" maxlength="100">
                <button onclick="updateChatTitle()" style="margin-left: 10px; padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">ë³€ê²½</button>
            </div>
        `;
    } else {
        html += `
            <div class="setting-row">
                <span class="setting-label">ì œëª©</span>
                <span class="setting-value">${escapeHtml(data.title)}</span>
            </div>
        `;
    }

    html += `
            <div class="setting-row">
                <span class="setting-label">ì°¸ì—¬ì</span>
                <span class="setting-value">${data.participant_count}ëª…</span>
            </div>
        </div>
    `;

    // ì•Œë¦¼ ì„¤ì •
    html += `
        <div class="setting-section">
            <div class="setting-section-title">ğŸ”” ì•Œë¦¼ ì„¤ì •</div>
            <div class="setting-row">
                <span class="setting-label">ì•Œë¦¼ ë„ê¸°</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="muteToggle" ${data.muted ? 'checked' : ''} onchange="toggleMute()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
    `;

    // ì°¸ì—¬ì ëª©ë¡ (ê·¸ë£¹ì±„íŒ…ë§Œ)
    if (isGroup) {
        html += `
            <div class="setting-section">
                <div class="setting-section-title">ğŸ‘¥ ì°¸ì—¬ì ëª©ë¡</div>
                <div class="participant-list">
        `;

        for (const p of data.participants) {
            const initial = p.username.charAt(0).toUpperCase();
            const roleLabel = p.role === 'owner' ? 'ë°©ì¥' : (p.role === 'admin' ? 'ë¶€ë°©ì¥' : '');
            const roleClass = p.role === 'owner' ? 'role-owner' : (p.role === 'admin' ? 'role-admin' : 'role-member');
            const isMe = p.username === username;

            html += `
                <div class="participant-item">
                    <div class="participant-info">
                        <div class="participant-avatar">${initial}</div>
                        <span class="participant-name">${escapeHtml(p.username)}${isMe ? ' (ë‚˜)' : ''}</span>
                        ${roleLabel ? `<span class="participant-role ${roleClass}">${roleLabel}</span>` : ''}
                    </div>
                    <div class="participant-actions">
            `;

            // ë°©ì¥ë§Œ ê¶Œí•œ ë³€ê²½ ê°€ëŠ¥
            if (isOwner && !isMe && p.role !== 'owner') {
                if (p.role === 'admin') {
                    html += `<button class="btn-remove-admin" onclick="setAdmin('${p.username}', false)">ë¶€ë°©ì¥ í•´ì œ</button>`;
                } else {
                    html += `<button class="btn-admin" onclick="setAdmin('${p.username}', true)">ë¶€ë°©ì¥ ì§€ì •</button>`;
                }
            }

            // owner/adminì´ ë‚´ë³´ë‚´ê¸° ê°€ëŠ¥ (ë³¸ì¸, ë°©ì¥ ì œì™¸)
            if (canManage && !isMe && p.role !== 'owner') {
                // adminì€ ë°©ì¥ë§Œ ë‚´ë³´ë‚¼ ìˆ˜ ìˆìŒ
                if (p.role !== 'admin' || isOwner) {
                    html += `<button class="btn-kick" onclick="kickMember('${p.username}')">ë‚´ë³´ë‚´ê¸°</button>`;
                }
            }

            html += `
                    </div>
                </div>
            `;
        }

        html += '</div>';

        // ë©¤ë²„ ì¶”ê°€ (owner/adminë§Œ)
        if (canManage) {
            html += `
                <div class="add-member-section">
                    <input type="text" id="addMemberInput" placeholder="ì¶”ê°€í•  ì‚¬ìš©ìëª… ì…ë ¥...">
                    <button onclick="addMember()">ì¶”ê°€</button>
                </div>
            `;
        }

        html += '</div>';

        // ë‚˜ê°€ê¸° (ê·¸ë£¹ì±„íŒ…ë§Œ)
        html += `
            <div class="setting-section danger-section">
                <div class="setting-section-title">âš ï¸ ìœ„í—˜ ì˜ì—­</div>
                <button class="btn-leave" onclick="leaveChat()">ì±„íŒ…ë°© ë‚˜ê°€ê¸°</button>
                <p style="font-size: 12px; color: #666; margin-top: 10px; text-align: center;">
                    ${isOwner ? 'ë°©ì¥ì´ ë‚˜ê°€ë©´ ë‹¤ìŒ ë¶€ë°©ì¥ ë˜ëŠ” ë©¤ë²„ì—ê²Œ ê¶Œí•œì´ ì´ì „ë©ë‹ˆë‹¤.' : 'ì±„íŒ…ë°©ì„ ë‚˜ê°€ë©´ ëŒ€í™” ë‚´ì—­ì„ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}
                </p>
            </div>
        `;
    } else {
        // 1:1 ì±„íŒ… ì•ˆë‚´
        html += `
            <div class="direct-chat-notice">
                <p>1:1 ì±„íŒ…ë°©ì…ë‹ˆë‹¤.</p>
                <p style="font-size: 13px;">ì œëª© ë³€ê²½, ë©¤ë²„ ê´€ë¦¬, ë‚˜ê°€ê¸° ë“±ì€<br>ê·¸ë£¹ ì±„íŒ…ë°©ì—ì„œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
            </div>
        `;
    }

    body.innerHTML = html;
}

async function updateChatTitle() {
    const input = document.getElementById('chatTitleInput');
    const newTitle = input.value.trim();

    if (!newTitle) {
        alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    try {
        const response = await fetch(`/api/chats/${chatId}/title`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title: newTitle })
        });
        const result = await response.json();

        if (result.success) {
            alert('ì±„íŒ…ë°© ì œëª©ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
            // í˜ì´ì§€ ì œëª© ì—…ë°ì´íŠ¸
            document.title = newTitle;
            chatSettingsData.title = newTitle;
        } else {
            alert(result.message);
        }
    } catch (error) {
        alert('ì œëª© ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

async function toggleMute() {
    try {
        const response = await fetch(`/api/chats/${chatId}/mute`, {
            method: 'POST'
        });
        const result = await response.json();

        if (result.success) {
            chatSettingsData.muted = result.muted;
        } else {
            // ì‹¤íŒ¨ ì‹œ í† ê¸€ ì›ë³µ
            document.getElementById('muteToggle').checked = !document.getElementById('muteToggle').checked;
            alert(result.message);
        }
    } catch (error) {
        document.getElementById('muteToggle').checked = !document.getElementById('muteToggle').checked;
        alert('ì•Œë¦¼ ì„¤ì • ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

async function addMember() {
    const input = document.getElementById('addMemberInput');
    const targetUsername = input.value.trim();

    if (!targetUsername) {
        alert('ì¶”ê°€í•  ì‚¬ìš©ìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    try {
        const response = await fetch(`/api/chats/${chatId}/participants`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: targetUsername })
        });
        const result = await response.json();

        alert(result.message);

        if (result.success) {
            input.value = '';
            openChatSettings(); // ìƒˆë¡œê³ ì¹¨
        }
    } catch (error) {
        alert('ë©¤ë²„ ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

async function kickMember(targetUsername) {
    if (!confirm(`${targetUsername}ë‹˜ì„ ì±„íŒ…ë°©ì—ì„œ ë‚´ë³´ë‚´ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }

    try {
        const response = await fetch(`/api/chats/${chatId}/participants/${encodeURIComponent(targetUsername)}`, {
            method: 'DELETE'
        });
        const result = await response.json();

        alert(result.message);

        if (result.success) {
            openChatSettings(); // ìƒˆë¡œê³ ì¹¨
        }
    } catch (error) {
        alert('ë©¤ë²„ ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

async function setAdmin(targetUsername, isAdmin) {
    const action = isAdmin ? 'ë¶€ë°©ì¥ìœ¼ë¡œ ì§€ì •' : 'ì¼ë°˜ ë©¤ë²„ë¡œ ë³€ê²½';
    if (!confirm(`${targetUsername}ë‹˜ì„ ${action}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }

    try {
        const response = await fetch(`/api/chats/${chatId}/admin/${encodeURIComponent(targetUsername)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ is_admin: isAdmin })
        });
        const result = await response.json();

        alert(result.message);

        if (result.success) {
            openChatSettings(); // ìƒˆë¡œê³ ì¹¨
        }
    } catch (error) {
        alert('ê¶Œí•œ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

async function leaveChat() {
    if (!confirm('ì •ë§ë¡œ ì´ ì±„íŒ…ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?\nëŒ€í™” ë‚´ì—­ì„ ë‹¤ì‹œ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
        return;
    }

    try {
        const response = await fetch(`/api/chats/${chatId}/leave`, {
            method: 'POST'
        });
        const result = await response.json();

        if (result.success) {
            alert('ì±„íŒ…ë°©ì„ ë‚˜ê°”ìŠµë‹ˆë‹¤.');
            window.location.href = '/chats';
        } else {
            alert(result.message);
        }
    } catch (error) {
        alert('ì±„íŒ…ë°© ë‚˜ê°€ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
document.getElementById('chatSettingsModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeChatSettings();
    }
});
</script>
