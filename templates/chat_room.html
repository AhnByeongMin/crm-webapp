<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ chat_title }}</title>
    <!-- PWA ë©”íƒ€ íƒœê·¸ -->
    <meta name="description" content="ìŠ¤ë§ˆíŠ¸í•œ ê³ ê° ê´€ë¦¬ì™€ íŒ€ í˜‘ì—…ì„ ìœ„í•œ CRM ì‹œìŠ¤í…œ">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="í•˜ë£¨CRM">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icon-192.png">
    <link rel="apple-touch-icon" href="/static/icon-192.png">

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <!-- Service Worker ë“±ë¡ì€ ê°€ì¥ ë¨¼ì € -->
    <script src="/static/js/sw-register.js"></script>
    <!-- ê·¸ ë‹¤ìŒ auto-updateì™€ push-notifications -->
    <script src="/static/js/sw-auto-update.js"></script>
    <script src="/static/js/push-notifications.js" defer></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: #f5f5f5;
        }
        .header {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 18px; color: #333; }
        .back-btn {
            padding: 8px 16px;
            background: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
        }
        .back-btn:hover { background: #5a6268; }
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            max-height: calc(100vh - 70px); /* ê³µí†µ í—¤ë” ë†’ì´ ì œì™¸ */
            overflow: hidden; /* ì»¨í…Œì´ë„ˆ ìì²´ëŠ” ë„˜ì¹˜ì§€ ì•Šê²Œ */
            position: relative; /* ì´ëª¨ì§€ í”¼ì»¤ ìœ„ì¹˜ ê¸°ì¤€ */
        }
        #messages {
            flex: 1;
            overflow-y: auto; /* ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
            overflow-x: hidden;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 0; /* flex itemì—ì„œ ìŠ¤í¬ë¡¤ì´ ì‘ë™í•˜ë„ë¡ */
        }
        .message {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 18px;
            word-wrap: break-word;
        }
        .message.own {
            align-self: flex-end;
            background: #667eea;
            color: white;
        }
        .message.other {
            align-self: flex-start;
            background: #e9ecef;
            color: #333;
        }
        .message-header {
            font-size: 12px;
            margin-bottom: 4px;
            opacity: 0.8;
        }
        .message-text {
            font-size: 14px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .message-text.emoji-only {
            font-size: 48px;
            line-height: 1;
            background: none !important;
        }
        .message.emoji-only-message {
            background: none !important;
            padding: 5px;
        }
        .message-time {
            font-size: 11px;
            margin-top: 4px;
            opacity: 0.7;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        /* ë©”ì‹œì§€ ë³µì‚¬ ë²„íŠ¼ */
        .message-copy-btn {
            opacity: 0;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            transition: opacity 0.2s;
            background: rgba(0,0,0,0.1);
        }
        .message:hover .message-copy-btn {
            opacity: 0.7;
        }
        .message-copy-btn:hover {
            opacity: 1 !important;
            background: rgba(0,0,0,0.2);
        }
        .message.own .message-copy-btn {
            background: rgba(255,255,255,0.2);
        }
        .message.own .message-copy-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        .read-count {
            font-size: 12px;
            color: #ff0000;
            font-weight: bold;
            background: #ffebee;
            padding: 2px 6px;
            border-radius: 10px;
            margin-right: 5px;
        }
        .system-message {
            align-self: center;
            font-size: 12px;
            color: #999;
            background: none;
            padding: 5px;
        }
        .date-separator {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            width: 100%;
        }
        .date-separator-line {
            flex: 1;
            height: 1px;
            background: #ddd;
        }
        .date-separator-text {
            padding: 6px 16px;
            background: #f0f0f0;
            color: #666;
            font-size: 12px;
            border-radius: 15px;
            white-space: nowrap;
        }
        .input-area {
            display: flex;
            padding: 15px;
            background: white;
            border-top: 1px solid #ddd;
            gap: 10px;
        }
        #messageInput {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 16px; /* iOS ì¤Œ ë°©ì§€ */
            outline: none;
            min-height: 44px;
            max-height: 120px;
            resize: none;
            overflow-y: auto;
            font-family: inherit;
            line-height: 1.4;
        }
        #messageInput:focus {
            border-color: #667eea;
        }
        #sendBtn {
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        #sendBtn:hover {
            background: #5568d3;
        }
        .typing-indicator {
            padding: 10px 20px;
            font-size: 13px;
            color: #666;
            font-style: italic;
            background: #f8f9fa;
            border-radius: 15px;
            align-self: flex-start;
            display: none;
        }
        .typing-indicator.show {
            display: block;
        }
        .typing-dots {
            display: inline-block;
        }
        .typing-dots span {
            animation: blink 1.4s infinite;
            animation-fill-mode: both;
        }
        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes blink {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }
        .notification-banner {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px 20px;
            display: none;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .connection-status {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #ff9800;
            color: white;
            padding: 8px 15px;
            text-align: center;
            font-size: 13px;
            z-index: 10000;
            display: none;
            animation: slideDown 0.3s ease-out;
        }
        .connection-status.show {
            display: block;
        }
        .connection-status.connected {
            background: #4caf50;
        }
        .connection-status .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .notification-banner.show {
            display: flex;
        }
        .notification-banner-text {
            flex: 1;
            color: #856404;
        }
        .notification-banner-text strong {
            display: block;
            margin-bottom: 5px;
        }
        .notification-banner-text small {
            font-size: 12px;
        }
        .notification-banner button {
            background: #ffc107;
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .notification-banner button:hover {
            background: #e0a800;
        }
        .close-banner {
            background: transparent !important;
            color: #856404 !important;
            font-size: 20px;
            padding: 0 8px !important;
        }
        #attachBtn {
            padding: 10px 16px;
            background: #f0f0f0;
            color: #555;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #attachBtn:hover {
            background: #e0e0e0;
            border-color: #667eea;
            color: #667eea;
        }
        #emojiBtn {
            padding: 10px 16px;
            background: #f0f0f0;
            color: #555;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #emojiBtn:hover {
            background: #e0e0e0;
            border-color: #667eea;
            color: #667eea;
        }
        .emoji-picker {
            position: absolute;
            bottom: 70px;
            left: 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 15px;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 320px;
            z-index: 1000;
        }
        .emoji-picker.show {
            display: block;
        }
        .emoji-picker-header {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
        .emoji-item {
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            text-align: center;
            transition: all 0.2s;
        }
        .emoji-item:hover {
            background: #f0f0f0;
            transform: scale(1.2);
        }
        .file-preview {
            padding: 10px 15px;
            background: #f8f9fa;
            border-top: 1px solid #ddd;
            display: none;
            gap: 10px;
            flex-wrap: wrap;
        }
        .file-preview.show {
            display: flex;
        }
        .file-preview-item {
            position: relative;
            padding: 8px 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }
        .file-preview-item img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
        }
        .file-preview-item .remove-file {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            line-height: 1;
        }
        .message-file {
            margin-top: 8px;
            padding: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            cursor: pointer;
        }
        .message-file img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            display: block;
        }
        .message-file.document {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .message-file.document:hover {
            background: rgba(255,255,255,0.3);
        }

        /* ì´ë¯¸ì§€ ëª¨ë‹¬ íŒì—… */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            animation: fadeIn 0.2s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .image-modal-content {
            position: relative;
            margin: auto;
            padding: 0;
            width: 90%;
            max-width: 1200px;
            height: 90%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .image-modal-content img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
        }
        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10001;
            transition: 0.3s;
        }
        .image-modal-close:hover,
        .image-modal-close:focus {
            color: #bbb;
        }
        .image-modal-filename {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #fff;
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
        }

        /* ë‹¹ì¼ ì˜ˆì•½ ë°°ë„ˆ */
        #reminderBanner { position: fixed; top: 0; left: 0; right: 0; z-index: 9998; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; padding: 12px 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); display: none; animation: slideDown 0.3s ease-out; }
        #reminderBanner.show { display: flex; }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
        #reminderBanner .banner-content { flex: 1; display: flex; align-items: center; gap: 12px; font-weight: bold; }
        #reminderBanner .banner-icon { font-size: 20px; }
        #reminderBanner .banner-close { background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 14px; margin-left: 10px; }
        #reminderBanner .banner-close:hover { background: rgba(255,255,255,0.3); }
        #reminderBanner .banner-link { background: white; color: #dc3545; padding: 6px 16px; border-radius: 4px; text-decoration: none; font-weight: bold; margin-left: 10px; }
        #reminderBanner .banner-link:hover { background: #f8f9fa; }
        body.has-banner #notificationBanner { margin-top: 50px; }
        body.has-banner .header { margin-top: 50px; }

        /* ë„ì›€ë§ ì„¹ì…˜ (ì±„íŒ…ë°© ì „ìš©) */
        .help-section {
            margin-bottom: 25px;
        }
        .help-section-title {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-badge {
            display: inline-block;
            background: #dc3545;
            color: white;
            font-size: 11px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
            min-width: 18px;
            text-align: center;
        }

        /* ê²€ìƒ‰ íŒ¨ë„ ìŠ¤íƒ€ì¼ */
        .search-panel {
            display: none;
            background: white;
            border-bottom: 1px solid #ddd;
            padding: 12px 15px;
            gap: 10px;
            flex-direction: column;
        }
        .search-panel.show {
            display: flex;
        }
        .search-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .search-input-wrap {
            flex: 1;
            position: relative;
        }
        .search-input-wrap input {
            width: 100%;
            padding: 10px 40px 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
        }
        .search-input-wrap input:focus {
            border-color: #667eea;
        }
        .search-input-wrap .clear-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 18px;
            padding: 5px;
        }
        .search-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }
        .search-btn:hover {
            background: #5568d3;
        }
        .date-btn {
            padding: 10px 15px;
            background: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
        }
        .date-btn:hover {
            background: #e0e0e0;
        }
        .search-results-info {
            font-size: 13px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .search-results-info .nav-btns {
            display: flex;
            gap: 5px;
        }
        .search-results-info .nav-btns button {
            padding: 5px 12px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
        }
        .search-results-info .nav-btns button:hover {
            background: #e0e0e0;
        }
        .search-results-info .nav-btns button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .close-search-btn {
            padding: 8px 12px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 13px;
        }

        /* ê²€ìƒ‰ ê²°ê³¼ í•˜ì´ë¼ì´íŠ¸ */
        .message.search-highlight {
            animation: highlightPulse 2s ease-out;
        }
        @keyframes highlightPulse {
            0%, 100% { box-shadow: none; }
            50% { box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.5); }
        }

        /* ë§¨ ì•„ë˜ë¡œ ì´ë™ ë²„íŠ¼ - í”Œë¡œíŒ… ë²„íŠ¼ ì™¼ìª½ì— ë°°ì¹˜ */
        .scroll-to-bottom-btn {
            position: fixed;
            bottom: 90px;
            right: 85px; /* í”Œë¡œíŒ… ë²„íŠ¼ ì™¼ìª½ìœ¼ë¡œ ì´ë™ */
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 18px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9996;
            transition: all 0.3s ease;
        }
        .scroll-to-bottom-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.5);
        }
        .scroll-to-bottom-btn:active {
            transform: scale(0.95);
        }
        .scroll-to-bottom-btn.show {
            display: flex;
        }
        .scroll-to-bottom-btn .new-msg-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4444;
            color: white;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 5px;
            border-radius: 10px;
            min-width: 16px;
            text-align: center;
        }

        /* ëª¨ë°”ì¼ì—ì„œ ìŠ¤í¬ë¡¤ ë²„íŠ¼ ìœ„ì¹˜ ì¡°ì • */
        @media (max-width: 768px) {
            .scroll-to-bottom-btn {
                bottom: 80px;
                right: 75px;
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            .scroll-to-bottom-btn .new-msg-badge {
                font-size: 9px;
                padding: 1px 4px;
                min-width: 14px;
            }
        }

        /* ì´ˆì†Œí˜• ëª¨ë°”ì¼ - ë²„íŠ¼ ì„¸ë¡œ ì •ë ¬ */
        @media (max-width: 400px) {
            .scroll-to-bottom-btn {
                bottom: 140px;
                right: 15px;
            }
        }
        .search-match {
            background: #ffeb3b;
            padding: 1px 2px;
            border-radius: 2px;
        }

        /* ë‚ ì§œ ì„ íƒ ëª¨ë‹¬ */
        .date-picker-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10002;
            align-items: center;
            justify-content: center;
        }
        .date-picker-modal.show {
            display: flex;
        }
        .date-picker-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 350px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        .date-picker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .date-picker-title {
            font-size: 18px;
            font-weight: bold;
        }
        .date-picker-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .calendar-nav button {
            padding: 8px 15px;
            background: #f0f0f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .calendar-nav button:hover {
            background: #e0e0e0;
        }
        .calendar-month {
            font-weight: bold;
            font-size: 16px;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }
        .calendar-day-header {
            font-size: 12px;
            color: #999;
            padding: 5px;
        }
        .calendar-day {
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
        }
        .calendar-day:hover {
            background: #f0f0f0;
        }
        .calendar-day.has-messages {
            background: #e8f0fe;
            color: #667eea;
            font-weight: bold;
        }
        .calendar-day.today {
            border: 2px solid #667eea;
        }
        .calendar-day.selected {
            background: #667eea;
            color: white;
        }
        .calendar-day.other-month {
            color: #ccc;
        }
        .calendar-day.no-messages {
            color: #ccc;
            cursor: not-allowed;
        }

        /* ===== ëª¨ë°”ì¼ ë°˜ì‘í˜• (768px ì´í•˜) ===== */
        @media (max-width: 768px) {
            /* ê²€ìƒ‰ íŒ¨ë„ ëª¨ë°”ì¼ ìµœì í™” */
            .search-panel {
                padding: 10px;
                gap: 8px;
            }
            .search-row {
                flex-wrap: wrap;
                gap: 8px;
            }
            .search-input-wrap {
                flex: 1 1 100%;
                order: 1;
            }
            .search-input-wrap input {
                padding: 12px 40px 12px 15px;
                font-size: 16px; /* iOS ì¤Œ ë°©ì§€ */
                min-height: 44px;
            }
            .search-btn {
                flex: 1;
                order: 2;
                min-height: 44px;
                font-size: 15px;
            }
            .date-btn {
                flex: 1;
                order: 3;
                min-height: 44px;
                font-size: 14px;
                padding: 10px 12px;
            }
            .close-search-btn {
                order: 4;
                min-height: 44px;
                padding: 10px 15px;
                font-size: 14px;
            }
            .search-results-info {
                flex-wrap: wrap;
                gap: 8px;
                justify-content: space-between;
            }
            .search-results-info .nav-btns {
                width: 100%;
                justify-content: center;
            }
            .search-results-info .nav-btns button {
                flex: 1;
                min-height: 40px;
                font-size: 14px;
            }

            /* ë©”ì‹œì§€ ì˜ì—­ */
            .message {
                max-width: 85%;
            }
            #messages {
                padding: 15px 10px;
            }

            /* ì…ë ¥ ì˜ì—­ ëª¨ë°”ì¼ ìµœì í™” */
            .input-area {
                padding: 10px;
                gap: 8px;
            }
            #messageInput {
                font-size: 16px; /* iOS ì¤Œ ë°©ì§€ */
                padding: 10px 14px;
                min-height: 44px;
            }
            #sendBtn {
                padding: 10px 18px;
                font-size: 14px;
                min-height: 44px;
            }
            #attachBtn, #emojiBtn {
                min-width: 44px;
                min-height: 44px;
            }

            /* ì±„íŒ… ì»¨í…Œì´ë„ˆ */
            .chat-container {
                max-height: calc(100vh - 60px);
            }

            /* ë‚ ì§œ ì„ íƒ ëª¨ë‹¬ */
            .date-picker-content {
                width: 95%;
                max-width: 350px;
            }
            .calendar-day {
                padding: 8px;
                font-size: 13px;
            }
        }

        /* ===== ì‘ì€ ëª¨ë°”ì¼ (480px ì´í•˜) ===== */
        @media (max-width: 480px) {
            .search-panel {
                padding: 8px;
            }
            .search-btn, .date-btn, .close-search-btn {
                padding: 10px 10px;
                font-size: 13px;
            }
            .date-btn {
                flex: 0 0 auto;
            }
            #sendBtn {
                padding: 10px 14px;
                font-size: 13px;
            }
            .message {
                max-width: 90%;
            }
        }
    </style>
    <script src="/static/js/banner.js" defer></script>
</head>
<body class="chat-room-page">
    <div id="connectionStatus" class="connection-status">
        <span class="spinner"></span>ì„œë²„ì— ì¬ì—°ê²° ì¤‘...
    </div>
    <div id="reminderBanner">
        <div class="banner-content">
            <span class="banner-icon">ğŸ”´</span>
            <span id="bannerText">ì˜¤ëŠ˜ ì˜ˆì•½ì´ ìˆìŠµë‹ˆë‹¤!</span>
        </div>
        <a href="/reminders" class="banner-link">ì˜ˆì•½ í™•ì¸</a>
        <button class="banner-close" onclick="closeReminderBanner()">ë‹«ê¸°</button>
    </div>
    <div id="notificationBanner" class="notification-banner">
        <div class="notification-banner-text">
            <strong>ğŸ’¡ ì•Œë¦¼ ì•ˆë‚´</strong>
            <small>HTTP í™˜ê²½ì—ì„œëŠ” ë¸Œë¼ìš°ì € í‘¸ì‹œ ì•Œë¦¼ì´ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ëŒ€ì‹  íƒ­ ì œëª© ê¹œë¹¡ì„ìœ¼ë¡œ ìƒˆ ë©”ì‹œì§€ë¥¼ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.</small>
        </div>
        <button class="close-banner" onclick="closeBanner()">Ã—</button>
    </div>

    {% include 'includes/header.html' %}

    <div class="chat-container">
        <!-- ê²€ìƒ‰ íŒ¨ë„ -->
        <div id="searchPanel" class="search-panel">
            <div class="search-row">
                <div class="search-input-wrap">
                    <input type="text" id="searchInput" placeholder="ë©”ì‹œì§€ ê²€ìƒ‰..." autocomplete="off">
                    <button class="clear-btn" onclick="clearSearch()" title="ì§€ìš°ê¸°">Ã—</button>
                </div>
                <button class="date-btn" onclick="openDatePicker()">ğŸ“… ë‚ ì§œ</button>
                <button class="search-btn" onclick="performSearch()">ê²€ìƒ‰</button>
                <button class="close-search-btn" onclick="closeSearchPanel()">ë‹«ê¸°</button>
            </div>
            <div id="searchResultsInfo" class="search-results-info" style="display: none;">
                <span id="searchResultsText">ê²€ìƒ‰ ê²°ê³¼: 0ê±´</span>
                <div class="nav-btns">
                    <button onclick="navigateSearchResult(-1)" id="prevResultBtn">â†‘ ì´ì „</button>
                    <button onclick="navigateSearchResult(1)" id="nextResultBtn">ë‹¤ìŒ â†“</button>
                </div>
            </div>
        </div>

        <div id="messages"></div>
        <div id="typingIndicator" class="typing-indicator">
            <span id="typingUser"></span>ë‹˜ì´ ì…ë ¥ ì¤‘<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>
        </div>
        <div class="input-area">
            <input type="file" id="fileInput" style="display: none;" multiple>
            <button id="attachBtn" title="íŒŒì¼ ì²¨ë¶€">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                </svg>
            </button>
            <button id="emojiBtn" title="ì´ëª¨ì§€">ğŸ˜Š</button>
            <textarea id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”... (Shift+Enter: ì¤„ë°”ê¿ˆ)" autocomplete="off" rows="1"></textarea>
            <button id="sendBtn">ì „ì†¡</button>
        </div>
        <div id="emojiPicker" class="emoji-picker">
            <div class="emoji-picker-header">ì´ëª¨ì§€ ì„ íƒ</div>
            <div class="emoji-grid" id="emojiGrid"></div>
        </div>
        <div id="filePreview" class="file-preview"></div>
    </div>

    <!-- ë§¨ ì•„ë˜ë¡œ ì´ë™ ë²„íŠ¼ -->
    <button class="scroll-to-bottom-btn" id="scrollToBottomBtn" onclick="scrollToBottomSmooth()" title="ë§¨ ì•„ë˜ë¡œ ì´ë™">
        â¬‡ï¸
        <span class="new-msg-badge" id="newMsgBadge" style="display: none;">0</span>
    </button>

    <!-- ë‚ ì§œ ì„ íƒ ëª¨ë‹¬ -->
    <div id="datePickerModal" class="date-picker-modal">
        <div class="date-picker-content">
            <div class="date-picker-header">
                <span class="date-picker-title">ğŸ“… ë‚ ì§œë¡œ ì´ë™</span>
                <button class="date-picker-close" onclick="closeDatePicker()">Ã—</button>
            </div>
            <div class="calendar-nav">
                <button onclick="changeMonth(-1)">â—€ ì´ì „</button>
                <span id="calendarMonth" class="calendar-month"></span>
                <button onclick="changeMonth(1)">ë‹¤ìŒ â–¶</button>
            </div>
            <div id="calendarGrid" class="calendar-grid"></div>
        </div>
    </div>

    <script>
        // Socket.IO ì´ˆê¸°í™” (ìë™ ì¬ì—°ê²° ì„¤ì •)
        const socket = io({
            reconnection: true,           // ìë™ ì¬ì—°ê²° í™œì„±í™”
            reconnectionDelay: 1000,      // ì¬ì—°ê²° ì‹œë„ ê°„ê²© (1ì´ˆ)
            reconnectionDelayMax: 5000,   // ìµœëŒ€ ì¬ì—°ê²° ê°„ê²© (5ì´ˆ)
            reconnectionAttempts: Infinity // ë¬´í•œ ì¬ì‹œë„
        });
        const chatId = '{{ chat_id }}';
        const username = '{{ username }}';

        // ì „ì—­ìœ¼ë¡œ í˜„ì¬ ì±„íŒ…ë°© ID ë…¸ì¶œ (ì•Œë¦¼ í•„í„°ë§ìš©)
        window.currentChatRoomId = chatId;
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const typingIndicator = document.getElementById('typingIndicator');
        const typingUser = document.getElementById('typingUser');
        let notificationPermission = false;
        let isPageVisible = true;
        let typingTimeout = null;
        let isTyping = false;
        let unreadCount = 0;
        let originalTitle = '{{ chat_title }}';
        let titleBlinkInterval = null;

        // ë‹¹ì¼ ì˜ˆì•½ ë°°ë„ˆ ì²´í¬
        async function checkTodayReminders() {
            try {
                const response = await fetch('/api/reminders?show_completed=false');
                const reminders = await response.json();

                const today = new Date().toISOString().split('T')[0];
                const todayReminders = reminders.filter(r => r.scheduled_date === today);

                if (todayReminders.length > 0) {
                    const banner = document.getElementById('reminderBanner');
                    const bannerText = document.getElementById('bannerText');
                    bannerText.textContent = `ì˜¤ëŠ˜ ì˜ˆì•½ ${todayReminders.length}ê±´ì´ ìˆìŠµë‹ˆë‹¤!`;
                    banner.classList.add('show');
                    document.body.classList.add('has-banner');
                }
            } catch (error) {
                console.log('ì˜ˆì•½ ì²´í¬ ì‹¤íŒ¨:', error);
            }
        }

        function closeReminderBanner() {
            const banner = document.getElementById('reminderBanner');
            banner.classList.remove('show');
            document.body.classList.remove('has-banner');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë‹¹ì¼ ì˜ˆì•½ ì²´í¬
        checkTodayReminders();

        // ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ (ëª…í™•í•œ ìš”ì²­)
        if ('Notification' in window) {
            console.log('í˜„ì¬ ì•Œë¦¼ ê¶Œí•œ ìƒíƒœ:', Notification.permission);

            if (Notification.permission === 'default') {
                // í˜ì´ì§€ ë¡œë“œ ì§í›„ ê¶Œí•œ ìš”ì²­
                setTimeout(() => {
                    Notification.requestPermission().then(permission => {
                        console.log('ì•Œë¦¼ ê¶Œí•œ ì‘ë‹µ:', permission);
                        notificationPermission = permission === 'granted';

                        if (notificationPermission) {
                            // í…ŒìŠ¤íŠ¸ ì•Œë¦¼
                            new Notification('ì•Œë¦¼ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤!', {
                                body: 'ìƒˆë¡œìš´ ë©”ì‹œì§€ë¥¼ ë°›ìœ¼ë©´ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.',
                                icon: '/favicon.ico'
                            });
                        }
                    });
                }, 1000);
            } else if (Notification.permission === 'granted') {
                notificationPermission = true;
                console.log('ì•Œë¦¼ ê¶Œí•œ ì´ë¯¸ í—ˆìš©ë¨');
            } else {
                console.log('ì•Œë¦¼ ê¶Œí•œ ê±°ë¶€ë¨ (HTTP í™˜ê²½ì—ì„œëŠ” ì •ìƒ)');
                // HTTP í™˜ê²½ ì•ˆë‚´ ë°°ë„ˆ í‘œì‹œ (ì„ íƒì )
                // document.getElementById('notificationBanner').classList.add('show');
            }
        } else {
            console.log('ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
        }

        function closeBanner() {
            document.getElementById('notificationBanner').classList.remove('show');
        }

        // í˜ì´ì§€ ê°€ì‹œì„± ê°ì§€
        document.addEventListener('visibilitychange', () => {
            isPageVisible = !document.hidden;

            // í˜ì´ì§€ê°€ ë³´ì´ë©´ ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ì¹´ìš´íŠ¸ ë¦¬ì…‹
            if (isPageVisible) {
                unreadCount = 0;
                stopTitleBlink();
                document.title = originalTitle;
            }
        });

        // íƒ­ì´ í¬ì»¤ìŠ¤ë˜ë©´ ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ì¹´ìš´íŠ¸ ë¦¬ì…‹
        window.addEventListener('focus', () => {
            unreadCount = 0;
            stopTitleBlink();
            document.title = originalTitle;
        });

        function startTitleBlink() {
            if (titleBlinkInterval) {
                console.log('ì´ë¯¸ ì œëª© ê¹œë¹¡ì„ ì¤‘');
                return; // ì´ë¯¸ ê¹œë¹¡ì´ëŠ” ì¤‘ì´ë©´ ë¬´ì‹œ
            }

            console.log('ì œëª© ê¹œë¹¡ì„ ì‹œì‘! ì½ì§€ ì•Šì€ ë©”ì‹œì§€:', unreadCount);
            let isOriginal = true;
            titleBlinkInterval = setInterval(() => {
                if (isOriginal) {
                    document.title = `ğŸ”´ (${unreadCount}) ìƒˆ ë©”ì‹œì§€`;
                } else {
                    document.title = originalTitle;
                }
                console.log('ì œëª© ë³€ê²½:', document.title);
                isOriginal = !isOriginal;
            }, 1000); // 1ì´ˆë§ˆë‹¤ ê¹œë¹¡ì„
        }

        function stopTitleBlink() {
            if (titleBlinkInterval) {
                console.log('ì œëª© ê¹œë¹¡ì„ ì¤‘ì§€');
                clearInterval(titleBlinkInterval);
                titleBlinkInterval = null;
            }
        }

        function showChatNotification(senderName, message) {
            if (!notificationPermission || isPageVisible) return;

            const notification = new Notification(`${senderName}ë‹˜ì˜ ë©”ì‹œì§€`, {
                body: message,
                icon: '/favicon.ico',
                badge: '/favicon.ico',
                tag: 'chat-' + chatId,
                requireInteraction: false
            });

            notification.onclick = function() {
                window.focus();
                notification.close();
            };
        }

        // ë°© ì…ì¥
        socket.emit('join', { chat_id: chatId, username: username });

        // ì—°ê²° ìƒíƒœ UI ê´€ë¦¬
        const connectionStatus = document.getElementById('connectionStatus');
        let lastMessageTimestamp = null;  // ë§ˆì§€ë§‰ ë©”ì‹œì§€ ì‹œê°„ (ì¬ì—°ê²° ì‹œ ë†“ì¹œ ë©”ì‹œì§€ ë¡œë“œìš©)

        function showConnectionStatus(message, isConnected = false) {
            connectionStatus.innerHTML = isConnected
                ? `âœ“ ${message}`
                : `<span class="spinner"></span>${message}`;
            connectionStatus.classList.toggle('connected', isConnected);
            connectionStatus.classList.add('show');

            if (isConnected) {
                setTimeout(() => {
                    connectionStatus.classList.remove('show');
                }, 2000);
            }
        }

        function hideConnectionStatus() {
            connectionStatus.classList.remove('show');
        }

        // Socket.IO ì¬ì—°ê²° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
        socket.on('disconnect', (reason) => {
            console.log('[Socket.IO] ì—°ê²° ëŠê¹€:', reason);
            showConnectionStatus('ì„œë²„ì— ì¬ì—°ê²° ì¤‘...');
        });

        socket.on('reconnect', async (attemptNumber) => {
            console.log('[Socket.IO] ì¬ì—°ê²° ì„±ê³µ (ì‹œë„ íšŸìˆ˜:', attemptNumber + ')');

            // ì¬ì—°ê²° ì„±ê³µ ì‹œ ì±„íŒ…ë°©ì— ë‹¤ì‹œ ì…ì¥
            socket.emit('join', { chat_id: chatId, username: username });
            // ì½ìŒ ìƒíƒœ ë‹¤ì‹œ ì „ì†¡
            socket.emit('mark_as_read', { chat_id: chatId, username: username });

            // ë†“ì¹œ ë©”ì‹œì§€ ë¡œë“œ
            try {
                showConnectionStatus('ë©”ì‹œì§€ ë™ê¸°í™” ì¤‘...');
                const res = await fetch(`/api/chats/${chatId}/messages?limit=20`);
                const data = await res.json();

                if (data.messages && data.messages.length > 0) {
                    // í˜„ì¬ í™”ë©´ì— ì—†ëŠ” ìƒˆ ë©”ì‹œì§€ë§Œ ì¶”ê°€
                    const existingMsgIds = new Set();
                    messagesDiv.querySelectorAll('.message').forEach(el => {
                        if (el.dataset.msgId) existingMsgIds.add(el.dataset.msgId);
                    });

                    let newMsgCount = 0;
                    data.messages.forEach(msg => {
                        if (!existingMsgIds.has(String(msg.id))) {
                            displayMessage(msg, chatParticipants);
                            newMsgCount++;
                        }
                    });

                    if (newMsgCount > 0) {
                        scrollToBottom();
                        console.log(`[ì¬ì—°ê²°] ${newMsgCount}ê°œ ìƒˆ ë©”ì‹œì§€ ë¡œë“œ`);
                    }
                }

                showConnectionStatus('ì—°ê²°ë¨', true);
            } catch (error) {
                console.error('[ì¬ì—°ê²°] ë©”ì‹œì§€ ë™ê¸°í™” ì‹¤íŒ¨:', error);
                showConnectionStatus('ì—°ê²°ë¨', true);
            }
        });

        socket.on('reconnect_attempt', (attemptNumber) => {
            console.log('[Socket.IO] ì¬ì—°ê²° ì‹œë„ ì¤‘... (' + attemptNumber + 'ë²ˆì§¸)');
            showConnectionStatus(`ì¬ì—°ê²° ì‹œë„ ì¤‘... (${attemptNumber}ë²ˆì§¸)`);
        });

        socket.on('reconnect_error', (error) => {
            console.log('[Socket.IO] ì¬ì—°ê²° ì‹¤íŒ¨:', error);
        });

        socket.on('reconnect_failed', () => {
            console.log('[Socket.IO] ì¬ì—°ê²° ìµœì¢… ì‹¤íŒ¨ (í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ê¶Œì¥)');
            showConnectionStatus('ì—°ê²° ì‹¤íŒ¨ - í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”');
        });

        let chatParticipants = [];
        let isLoadingMessages = false;  // ë©”ì‹œì§€ ë¡œë”© ì¤‘ í”Œë˜ê·¸
        let hasMoreMessages = true;      // ë” ë¡œë“œí•  ë©”ì‹œì§€ê°€ ìˆëŠ”ì§€
        let currentOffset = 0;            // í˜„ì¬ ì˜¤í”„ì…‹
        let contextMode = false;         // ê²€ìƒ‰/ë‚ ì§œ ì´ë™ìœ¼ë¡œ ì»¨í…ìŠ¤íŠ¸ í‘œì‹œ ì¤‘ì¸ì§€
        const messagesPerPage = 50;      // í•œ ë²ˆì— ë¡œë“œí•  ë©”ì‹œì§€ ê°œìˆ˜
        let lastDisplayedDate = null;    // ë§ˆì§€ë§‰ìœ¼ë¡œ í‘œì‹œëœ ë‚ ì§œ (ë‚ ì§œ êµ¬ë¶„ì„ ìš©)

        // ë‚ ì§œ í¬ë§· í•¨ìˆ˜ (ì¹´ì¹´ì˜¤í†¡ ìŠ¤íƒ€ì¼)
        function formatDateSeparator(dateStr) {
            if (!dateStr) return '';
            // "2025-12-08 18:17:06" í˜•ì‹ì„ Dateê°€ íŒŒì‹±í•  ìˆ˜ ìˆë„ë¡ Të¡œ ë³€í™˜
            const normalizedDateStr = dateStr.replace(' ', 'T');
            const msgDate = new Date(normalizedDateStr);

            // Invalid Date ì²´í¬
            if (isNaN(msgDate.getTime())) {
                return dateStr.substring(0, 10);  // íŒŒì‹± ì‹¤íŒ¨ì‹œ YYYY-MM-DDë§Œ ë°˜í™˜
            }

            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            // ë‚ ì§œë§Œ ë¹„êµ (ì‹œê°„ ì œì™¸)
            const msgDateOnly = new Date(msgDate.getFullYear(), msgDate.getMonth(), msgDate.getDate());
            const todayOnly = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const yesterdayOnly = new Date(yesterday.getFullYear(), yesterday.getMonth(), yesterday.getDate());

            if (msgDateOnly.getTime() === todayOnly.getTime()) {
                return 'ì˜¤ëŠ˜';
            } else if (msgDateOnly.getTime() === yesterdayOnly.getTime()) {
                return 'ì–´ì œ';
            } else {
                const year = msgDate.getFullYear();
                const month = msgDate.getMonth() + 1;
                const day = msgDate.getDate();
                const dayOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '][msgDate.getDay()];
                return `${year}ë…„ ${month}ì›” ${day}ì¼ ${dayOfWeek}ìš”ì¼`;
            }
        }

        // ë‚ ì§œë§Œ ì¶”ì¶œ (YYYY-MM-DD í˜•ì‹)
        function getDateKey(dateStr) {
            if (!dateStr) return '';
            // "2025-12-08 18:17:06" ë˜ëŠ” "2025-12-08T18:17:06" í˜•ì‹ ëª¨ë‘ ì§€ì›
            // ì• 10ìë¦¬ë§Œ ì¶”ì¶œ (YYYY-MM-DD)
            return dateStr.substring(0, 10);
        }

        // ë‚ ì§œ êµ¬ë¶„ì„  ìš”ì†Œ ìƒì„±
        function createDateSeparator(dateStr) {
            const separator = document.createElement('div');
            separator.className = 'date-separator';
            separator.dataset.date = getDateKey(dateStr);
            separator.innerHTML = `
                <div class="date-separator-line"></div>
                <span class="date-separator-text">${formatDateSeparator(dateStr)}</span>
                <div class="date-separator-line"></div>
            `;
            return separator;
        }

        // ì´ˆê¸° ë©”ì‹œì§€ ë¡œë“œ (ìµœì‹  50ê°œ)
        async function loadInitialMessages() {
            try {
                // ì°¸ì—¬ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const chatsRes = await fetch('/api/chats?limit=0');
                const chats = await chatsRes.json();
                const chat = chats[chatId];

                if (!chat) {
                    console.error('ì±„íŒ…ë°©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                chatParticipants = chat.participants || [];

                // ìµœì‹  ë©”ì‹œì§€ ë¡œë“œ
                const res = await fetch(`/api/chats/${chatId}/messages?limit=${messagesPerPage}`);
                const data = await res.json();

                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(msg => {
                        displayMessage(msg, chatParticipants);
                    });
                    scrollToBottom();

                    currentOffset = data.messages.length;
                    hasMoreMessages = data.has_more;

                    console.log(`ì´ˆê¸° ë¡œë“œ: ${data.messages.length}ê°œ ë©”ì‹œì§€, ë”ë³´ê¸°: ${hasMoreMessages}`);
                }

                // í˜ì´ì§€ ì§„ì…ì‹œ ëª¨ë“  ë©”ì‹œì§€ë¥¼ ì½ìŒ ì²˜ë¦¬
                socket.emit('mark_as_read', {
                    chat_id: chatId,
                    username: username
                });
            } catch (error) {
                console.error('ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ì´ì „ ë©”ì‹œì§€ ë¡œë“œ (ë¬´í•œ ìŠ¤í¬ë¡¤ìš©)
        async function loadMoreMessages() {
            // ì»¨í…ìŠ¤íŠ¸ ëª¨ë“œì—ì„œëŠ” ë¬´í•œìŠ¤í¬ë¡¤ ë¹„í™œì„±í™”
            if (isLoadingMessages || !hasMoreMessages || contextMode) {
                return;
            }

            isLoadingMessages = true;
            console.log(`ì´ì „ ë©”ì‹œì§€ ë¡œë“œ ì‹œì‘ (offset: ${currentOffset})`);

            try {
                const res = await fetch(`/api/chats/${chatId}/messages?limit=${messagesPerPage}&offset=${currentOffset}`);
                const data = await res.json();

                if (data.messages && data.messages.length > 0) {
                    // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì €ì¥ (ë©”ì‹œì§€ ì¶”ê°€ í›„ ìœ„ì¹˜ ìœ ì§€ë¥¼ ìœ„í•´)
                    const oldScrollHeight = messagesDiv.scrollHeight;
                    const oldScrollTop = messagesDiv.scrollTop;

                    // í˜„ì¬ ë§¨ ìœ„ì— ìˆëŠ” ì²« ë²ˆì§¸ ë‚ ì§œ êµ¬ë¶„ì„  ì œê±° (ë‹¤ì‹œ ê³„ì‚°í•  ê²ƒì´ë¯€ë¡œ)
                    const firstDateSeparator = messagesDiv.querySelector('.date-separator');
                    if (firstDateSeparator) {
                        firstDateSeparator.remove();
                    }

                    // ìš”ì†Œë“¤ì„ ëª¨ì„ fragment
                    const fragment = document.createDocumentFragment();
                    let prevDateKey = null;

                    // ë©”ì‹œì§€ë¥¼ ì‹œê°„ìˆœìœ¼ë¡œ ì²˜ë¦¬ (ì´ë¯¸ ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬ë˜ì–´ ìˆìŒ)
                    data.messages.forEach((msg, index) => {
                        const msgDateKey = getDateKey(msg.timestamp);

                        // ì²« ë©”ì‹œì§€ì´ê±°ë‚˜ ë‚ ì§œê°€ ë°”ë€Œë©´ ë‚ ì§œ êµ¬ë¶„ì„  ì¶”ê°€
                        if (prevDateKey === null || prevDateKey !== msgDateKey) {
                            const dateSeparator = createDateSeparator(msg.timestamp);
                            fragment.appendChild(dateSeparator);
                        }

                        const messageDiv = createMessageElementFromMsg(msg);
                        fragment.appendChild(messageDiv);
                        prevDateKey = msgDateKey;
                    });

                    // ìƒˆë¡œ ë¡œë“œëœ ë©”ì‹œì§€ì˜ ë§ˆì§€ë§‰ ë‚ ì§œì™€ ê¸°ì¡´ ë©”ì‹œì§€ì˜ ì²« ë‚ ì§œ ë¹„êµ
                    const firstExistingMessage = messagesDiv.querySelector('.message');
                    if (firstExistingMessage && prevDateKey) {
                        // ê¸°ì¡´ ì²« ë©”ì‹œì§€ì˜ timestampë¥¼ ì•Œ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, ê¸°ì¡´ ë‚ ì§œ êµ¬ë¶„ì„ ì„ ë‹¤ì‹œ ì¶”ê°€
                        // ë‹¨, ìƒˆë¡œ ë¡œë“œëœ ë§ˆì§€ë§‰ ë©”ì‹œì§€ì™€ ê°™ì€ ë‚ ì§œê°€ ì•„ë‹ ë•Œë§Œ
                        // ì´ë¥¼ ìœ„í•´ firstExistingMessage ì•ì— ë‚ ì§œ êµ¬ë¶„ì„ ì´ í•„ìš”í•œì§€ í™•ì¸
                    }

                    // ë©”ì‹œì§€ë¥¼ ë§¨ ìœ„ì— ì‚½ì…
                    messagesDiv.insertBefore(fragment, messagesDiv.firstChild);

                    // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ë³µì› (ì¶”ê°€ëœ ë©”ì‹œì§€ ë†’ì´ë§Œí¼ ì•„ë˜ë¡œ)
                    const newScrollHeight = messagesDiv.scrollHeight;
                    messagesDiv.scrollTop = oldScrollTop + (newScrollHeight - oldScrollHeight);

                    currentOffset += data.messages.length;
                    hasMoreMessages = data.has_more;

                    console.log(`${data.messages.length}ê°œ ë©”ì‹œì§€ ë¡œë“œ ì™„ë£Œ, ë”ë³´ê¸°: ${hasMoreMessages}`);
                } else {
                    hasMoreMessages = false;
                    console.log('ë” ì´ìƒ ë¡œë“œí•  ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì´ì „ ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
            } finally {
                isLoadingMessages = false;
            }
        }

        // ë©”ì‹œì§€ ìš”ì†Œ ìƒì„± í•¨ìˆ˜ (ê¸°ì¡´ displayMessage ë¡œì§ ì¬ì‚¬ìš©)
        function createMessageElementFromMsg(msg) {
            const messageDiv = document.createElement('div');
            const isOwn = msg.username === username;

            // ì´ëª¨ì§€ë§Œ ìˆëŠ”ì§€ ì²´í¬ (ê³µë°± ì œê±° í›„ ì²´í¬)
            const trimmedMsg = msg.message.trim();
            const emojiOnlyRegex = /^[\p{Emoji}\u200d]+$/u;
            const isEmojiOnly = emojiOnlyRegex.test(trimmedMsg) && !msg.file_info;

            messageDiv.className = `message ${isOwn ? 'own' : 'other'} ${isEmojiOnly ? 'emoji-only-message' : ''}`;
            messageDiv.dataset.sender = msg.username; // ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ sender ì •ë³´ ì €ì¥
            if (msg.id) messageDiv.dataset.msgId = msg.id; // ë©”ì‹œì§€ ID ì €ì¥

            const time = new Date(msg.timestamp).toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit'
            });

            // ì½ì§€ ì•Šì€ ì‚¬ëŒ ìˆ˜ ê³„ì‚°
            let unreadCount = 0;
            if (isOwn && chatParticipants) {
                const readBy = msg.read_by || [msg.username];
                const totalParticipants = chatParticipants.length;
                const readCount = readBy.length;
                unreadCount = totalParticipants - readCount;
            }

            const unreadBadge = (isOwn && unreadCount > 0)
                ? `<span class="read-count">${unreadCount}</span>`
                : '';

            // íŒŒì¼ ì²¨ë¶€ í‘œì‹œ
            let fileHtml = '';

            // file_info í˜•ì‹ (ì‹¤ì‹œê°„ ì „ì†¡ëœ íŒŒì¼)
            if (msg.file_info && msg.file_info.length > 0) {
                fileHtml = msg.file_info.map(file => {
                    const isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(file.filename);
                    if (isImage) {
                        return `
                            <div class="message-file" onclick="openImageModal('${file.url}', '${escapeHtml(file.filename)}')">
                                <img src="${file.url}" alt="${escapeHtml(file.filename)}">
                            </div>
                        `;
                    } else {
                        const fileSize = (file.size / 1024).toFixed(1) + ' KB';
                        return `
                            <div class="message-file document" onclick="window.open('${file.url}', '_blank')">
                                <span>ğŸ“„</span>
                                <div>
                                    <div>${escapeHtml(file.filename)}</div>
                                    <small style="opacity: 0.7;">${fileSize}</small>
                                </div>
                            </div>
                        `;
                    }
                }).join('');
            }
            // file_path í˜•ì‹ (DBì—ì„œ ë¡œë“œëœ íŒŒì¼)
            else if (msg.file_path && msg.file_name) {
                const isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(msg.file_name);
                if (isImage) {
                    fileHtml = `
                        <div class="message-file" onclick="openImageModal('${msg.file_path}', '${escapeHtml(msg.file_name)}')">
                            <img src="${msg.file_path}" alt="${escapeHtml(msg.file_name)}">
                        </div>
                    `;
                } else {
                    fileHtml = `
                        <div class="message-file document" onclick="window.open('${msg.file_path}', '_blank')">
                            <span>ğŸ“„</span>
                            <div>
                                <div>${escapeHtml(msg.file_name)}</div>
                            </div>
                        </div>
                    `;
                }
            }

            const copyBtn = msg.message ? `<span class="message-copy-btn" onclick="copyMessage(this, '${escapeHtml(msg.message).replace(/'/g, "\\'")}')">ë³µì‚¬</span>` : '';

            messageDiv.innerHTML = `
                ${!isOwn ? `<div class="message-header">${msg.username}</div>` : ''}
                <div class="message-text ${isEmojiOnly ? 'emoji-only' : ''}">${escapeHtml(msg.message)}</div>
                ${fileHtml}
                <div class="message-time">${copyBtn}${unreadBadge}${time}</div>
            `;

            return messageDiv;
        }

        // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ë¬´í•œ ìŠ¤í¬ë¡¤)
        messagesDiv.addEventListener('scroll', () => {
            // ìŠ¤í¬ë¡¤ì´ ë§¨ ìœ„ì— ê°€ê¹Œì›Œì§€ë©´ ì´ì „ ë©”ì‹œì§€ ë¡œë“œ
            if (messagesDiv.scrollTop < 100 && hasMoreMessages && !isLoadingMessages) {
                loadMoreMessages();
            }
        });

        // ì´ˆê¸° ë©”ì‹œì§€ ë¡œë“œ ì‹¤í–‰
        loadInitialMessages();

        // ë©”ì‹œì§€ ì „ì†¡ (ì„ì‹œ - ë‚˜ì¤‘ì— sendMessageWithFilesë¡œ ëŒ€ì²´ë¨)
        function sendMessage() {
            // íŒŒì¼ì´ ìˆìœ¼ë©´ sendMessageWithFiles í˜¸ì¶œ
            if (selectedFiles && selectedFiles.length > 0) {
                sendMessageWithFiles();
            } else {
                const message = messageInput.value.trim();
                if (message) {
                    socket.emit('send_message', {
                        chat_id: chatId,
                        username: username,
                        message: message,
                        file_info: null
                    });
                    messageInput.value = '';
                }
            }
        }

        sendBtn.addEventListener('click', () => {
            sendMessageWithFiles();
        });
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessageWithFiles();
            }
        });

        // textarea ìë™ ë†’ì´ ì¡°ì ˆ
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // íƒ€ì´í•‘ ê°ì§€
        messageInput.addEventListener('input', () => {
            if (!isTyping) {
                isTyping = true;
                socket.emit('typing_start', { chat_id: chatId, username: username });
            }

            // íƒ€ì´í•‘ íƒ€ì„ì•„ì›ƒ ë¦¬ì…‹
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                isTyping = false;
                socket.emit('typing_stop', { chat_id: chatId, username: username });
            }, 1000); // 1ì´ˆ ë™ì•ˆ ì…ë ¥ì´ ì—†ìœ¼ë©´ íƒ€ì´í•‘ ì¤‘ì§€
        });

        // ìƒˆ ë©”ì‹œì§€ ìˆ˜ì‹ 
        socket.on('new_message', (msg) => {
            console.log('ìƒˆ ë©”ì‹œì§€ ìˆ˜ì‹ :', msg);
            console.log('íŒŒì¼ ì •ë³´:', msg.file_info);
            displayMessage(msg, chatParticipants);

            // ìŠ¤í¬ë¡¤ì´ ë§¨ ì•„ë˜ê°€ ì•„ë‹ˆë©´ ìë™ ìŠ¤í¬ë¡¤í•˜ì§€ ì•Šê³  ë°°ì§€ë§Œ ì—…ë°ì´íŠ¸
            if (isNearBottom()) {
                scrollToBottom();
            } else if (msg.username !== username) {
                // ë‹¤ë¥¸ ì‚¬ëŒ ë©”ì‹œì§€ë©´ ìƒˆ ë©”ì‹œì§€ ë°°ì§€ ì¦ê°€
                newMessagesWhileScrolledUp++;
                updateScrollButton();
            }

            // í˜ì´ì§€ê°€ í¬ì»¤ìŠ¤ë˜ì–´ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ì½ìŒ ì²˜ë¦¬
            if (document.hasFocus()) {
                socket.emit('mark_as_read', {
                    chat_id: chatId,
                    username: username
                });
            }

            // ë‹¤ë¥¸ ì‚¬ëŒì˜ ë©”ì‹œì§€ë©´ ì•Œë¦¼ í‘œì‹œ
            if (msg.username !== username) {
                console.log('ìƒˆ ë©”ì‹œì§€ ìˆ˜ì‹ :', msg.username, 'í˜ì´ì§€ ê°€ì‹œì„±:', isPageVisible, 'í¬ì»¤ìŠ¤:', document.hasFocus());

                // íƒ­ì´ ë³´ì´ì§€ ì•Šê±°ë‚˜ í¬ì»¤ìŠ¤ê°€ ì—†ìœ¼ë©´ ì œëª© ê¹œë¹¡ì„
                if (!document.hasFocus()) {
                    unreadCount++;
                    console.log('ì½ì§€ ì•Šì€ ë©”ì‹œì§€:', unreadCount, 'ì œëª© ê¹œë¹¡ì„ ì‹œì‘');
                    startTitleBlink();
                } else {
                    console.log('í˜ì´ì§€ê°€ í¬ì»¤ìŠ¤ ìƒíƒœë¼ ì œëª© ê¹œë¹¡ì„ ì•ˆ í•¨');
                }

                // ë¸Œë¼ìš°ì € í‘¸ì‹œ ì•Œë¦¼ (HTTPSì¼ ë•Œë§Œ ì‘ë™)
                showChatNotification(msg.username, msg.message);
            }
        });

        // ì‚¬ìš©ì ì…ì¥
        socket.on('user_joined', (data) => {
            if (data.username !== username) {
                addSystemMessage(`${data.username}ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤.`);
            }
        });

        // ì‚¬ìš©ì í‡´ì¥
        socket.on('user_left', (data) => {
            if (data.username !== username) {
                addSystemMessage(`${data.username}ë‹˜ì´ í‡´ì¥í–ˆìŠµë‹ˆë‹¤.`);
            }
        });

        // íƒ€ì´í•‘ ì‹œì‘
        socket.on('user_typing_start', (data) => {
            if (data.username !== username) {
                typingUser.textContent = data.username;
                typingIndicator.classList.add('show');
                scrollToBottom();
            }
        });

        // íƒ€ì´í•‘ ì¤‘ì§€
        socket.on('user_typing_stop', (data) => {
            if (data.username !== username) {
                typingIndicator.classList.remove('show');
            }
        });

        function displayMessage(msg, chatParticipants) {
            // ë‚ ì§œ êµ¬ë¶„ì„  ì¶”ê°€ (ë‚ ì§œê°€ ë°”ë€Œë©´)
            const msgDateKey = getDateKey(msg.timestamp);
            if (lastDisplayedDate !== msgDateKey) {
                const dateSeparator = createDateSeparator(msg.timestamp);
                messagesDiv.appendChild(dateSeparator);
                lastDisplayedDate = msgDateKey;
            }

            const messageDiv = document.createElement('div');
            const isOwn = msg.username === username;

            // ì´ëª¨ì§€ë§Œ ìˆëŠ”ì§€ ì²´í¬ (ê³µë°± ì œê±° í›„ ì²´í¬)
            const trimmedMsg = msg.message.trim();
            const emojiOnlyRegex = /^[\p{Emoji}\u200d]+$/u;
            const isEmojiOnly = emojiOnlyRegex.test(trimmedMsg) && !msg.file_info;

            messageDiv.className = `message ${isOwn ? 'own' : 'other'} ${isEmojiOnly ? 'emoji-only-message' : ''}`;
            messageDiv.dataset.sender = msg.username; // ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ sender ì •ë³´ ì €ì¥
            if (msg.id) messageDiv.dataset.msgId = msg.id; // ë©”ì‹œì§€ ID ì €ì¥

            const time = new Date(msg.timestamp).toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit'
            });

            // ì½ì§€ ì•Šì€ ì‚¬ëŒ ìˆ˜ ê³„ì‚°
            let unreadCount = 0;
            if (isOwn && chatParticipants) {
                const readBy = msg.read_by || [msg.username];
                const totalParticipants = chatParticipants.length;
                const readCount = readBy.length;
                unreadCount = totalParticipants - readCount;
                //console.log('ì½ìŒ í‘œì‹œ ê³„ì‚°:', {
                    //message: msg.message,
                    //totalParticipants,
                    //readBy,
                    //readCount,
                    //unreadCount
                //});
            }

            const unreadBadge = (isOwn && unreadCount > 0)
                ? `<span class="read-count">${unreadCount}</span>`
                : '';

            // íŒŒì¼ ì²¨ë¶€ í‘œì‹œ
            let fileHtml = '';

            // file_info í˜•ì‹ (ì‹¤ì‹œê°„ ì „ì†¡ëœ íŒŒì¼)
            if (msg.file_info && msg.file_info.length > 0) {
                fileHtml = msg.file_info.map(file => {
                    const isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(file.filename);
                    if (isImage) {
                        return `
                            <div class="message-file" onclick="openImageModal('${file.url}', '${escapeHtml(file.filename)}')">
                                <img src="${file.url}" alt="${escapeHtml(file.filename)}">
                            </div>
                        `;
                    } else {
                        const fileSize = (file.size / 1024).toFixed(1) + ' KB';
                        return `
                            <div class="message-file document" onclick="window.open('${file.url}', '_blank')">
                                <span>ğŸ“„</span>
                                <div>
                                    <div>${escapeHtml(file.filename)}</div>
                                    <small style="opacity: 0.7;">${fileSize}</small>
                                </div>
                            </div>
                        `;
                    }
                }).join('');
            }
            // file_path í˜•ì‹ (DBì—ì„œ ë¡œë“œëœ íŒŒì¼)
            else if (msg.file_path && msg.file_name) {
                const isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(msg.file_name);
                if (isImage) {
                    fileHtml = `
                        <div class="message-file" onclick="openImageModal('${msg.file_path}', '${escapeHtml(msg.file_name)}')">
                            <img src="${msg.file_path}" alt="${escapeHtml(msg.file_name)}">
                        </div>
                    `;
                } else {
                    fileHtml = `
                        <div class="message-file document" onclick="window.open('${msg.file_path}', '_blank')">
                            <span>ğŸ“„</span>
                            <div>
                                <div>${escapeHtml(msg.file_name)}</div>
                            </div>
                        </div>
                    `;
                }
            }

            const copyBtn = msg.message ? `<span class="message-copy-btn" onclick="copyMessage(this, '${escapeHtml(msg.message).replace(/'/g, "\\'")}')">ë³µì‚¬</span>` : '';

            messageDiv.innerHTML = `
                ${!isOwn ? `<div class="message-header">${msg.username}</div>` : ''}
                <div class="message-text ${isEmojiOnly ? 'emoji-only' : ''}">${escapeHtml(msg.message)}</div>
                ${fileHtml}
                <div class="message-time">${copyBtn}${unreadBadge}${time}</div>
            `;

            messagesDiv.appendChild(messageDiv);
        }

        // ë©”ì‹œì§€ ë³µì‚¬ í•¨ìˆ˜
        function copyMessage(btn, text) {
            // HTML ì—”í‹°í‹° ë””ì½”ë”©
            const textarea = document.createElement('textarea');
            textarea.innerHTML = text;
            const decodedText = textarea.value;

            navigator.clipboard.writeText(decodedText).then(() => {
                const originalText = btn.textContent;
                btn.textContent = 'ë³µì‚¬ë¨!';
                btn.style.opacity = '1';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.opacity = '';
                }, 1500);
            }).catch(() => {
                // í´ë°±: execCommand ì‚¬ìš©
                const tempInput = document.createElement('textarea');
                tempInput.value = decodedText;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);

                btn.textContent = 'ë³µì‚¬ë¨!';
                setTimeout(() => {
                    btn.textContent = 'ë³µì‚¬';
                }, 1500);
            });
        }

        function addSystemMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system-message';
            messageDiv.textContent = text;
            messagesDiv.appendChild(messageDiv);
            scrollToBottom();
        }

        function scrollToBottom() {
            // requestAnimationFrameìœ¼ë¡œ DOM ë Œë”ë§ ì™„ë£Œ í›„ ìŠ¤í¬ë¡¤
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                    updateScrollButton();
                });
            });
        }

        // ë¶€ë“œëŸ½ê²Œ ë§¨ ì•„ë˜ë¡œ ìŠ¤í¬ë¡¤
        function scrollToBottomSmooth() {
            messagesDiv.scrollTo({
                top: messagesDiv.scrollHeight,
                behavior: 'smooth'
            });
            // ìƒˆ ë©”ì‹œì§€ ë°°ì§€ ì´ˆê¸°í™”
            newMessagesWhileScrolledUp = 0;
            updateScrollButton();
        }

        // ìŠ¤í¬ë¡¤ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ ê´€ë¦¬
        let newMessagesWhileScrolledUp = 0;

        function isNearBottom() {
            const threshold = 150; // ë§¨ ì•„ë˜ì—ì„œ 150px ì´ë‚´
            return messagesDiv.scrollHeight - messagesDiv.scrollTop - messagesDiv.clientHeight < threshold;
        }

        function updateScrollButton() {
            const btn = document.getElementById('scrollToBottomBtn');
            const badge = document.getElementById('newMsgBadge');

            if (isNearBottom()) {
                btn.classList.remove('show');
                newMessagesWhileScrolledUp = 0;
            } else {
                btn.classList.add('show');
            }

            // ìƒˆ ë©”ì‹œì§€ ë°°ì§€ ì—…ë°ì´íŠ¸
            if (newMessagesWhileScrolledUp > 0) {
                badge.textContent = newMessagesWhileScrolledUp;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }

        // ë©”ì‹œì§€ ì˜ì—­ ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸
        messagesDiv.addEventListener('scroll', updateScrollButton);

        function escapeHtml(text) {
            if (!text) return '';
            // HTML íŠ¹ìˆ˜ë¬¸ì ì´ìŠ¤ì¼€ì´í”„ (ì¤„ë°”ê¿ˆì€ CSS white-space: pre-wrapìœ¼ë¡œ ì²˜ë¦¬)
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        // ì´ë¯¸ì§€ ëª¨ë‹¬ ì—´ê¸°
        function openImageModal(imageSrc, filename) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('imageModalImg');
            const filenameDiv = document.getElementById('imageModalFilename');

            modal.style.display = 'block';
            modalImg.src = imageSrc;
            filenameDiv.textContent = filename;
        }

        // ì´ë¯¸ì§€ ëª¨ë‹¬ ë‹«ê¸°
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.style.display = 'none';
        }

        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeImageModal();
            }
        });

        // ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸ ìˆ˜ì‹  (ìµœì í™”: ê°„ë‹¨í•œ ì¹´ìš´íŠ¸ ê°ì†Œ ë°©ì‹)
        socket.on('read_receipt_update', (data) => {
            console.log('ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸:', data);

            if (data.chat_id !== chatId) return;

            // ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ë©”ì‹œì§€ë¥¼ ì½ì—ˆì„ ë•Œ, í˜„ì¬ ì‚¬ìš©ìê°€ ë³´ë‚¸ ëª¨ë“  ë©”ì‹œì§€ì˜ ì½ì§€ ì•ŠìŒ ì¹´ìš´íŠ¸ë¥¼ 1ì”© ê°ì†Œ
            // ì´ëŠ” read_by ë°°ì—´ì„ ë‹¤ì‹œ ê³„ì‚°í•˜ì§€ ì•Šê³ ë„ ì‹¤ì‹œê°„ìœ¼ë¡œ ì½ìŒ ìƒíƒœë¥¼ ë°˜ì˜
            const messageElements = messagesDiv.querySelectorAll('.message');
            messageElements.forEach(msgEl => {
                // í˜„ì¬ ì‚¬ìš©ìê°€ ë³´ë‚¸ ë©”ì‹œì§€ë§Œ ì—…ë°ì´íŠ¸
                if (msgEl.dataset.sender === username) {
                    const readCountEl = msgEl.querySelector('.read-count');
                    if (readCountEl && readCountEl.style.display !== 'none') {
                        const currentCount = parseInt(readCountEl.textContent) || 0;
                        const newCount = currentCount - 1;

                        if (newCount > 0) {
                            readCountEl.textContent = newCount;
                        } else {
                            readCountEl.style.display = 'none';
                        }
                    }
                }
            });
        });

        // í˜ì´ì§€ í¬ì»¤ìŠ¤ì‹œ ì½ìŒ ì²˜ë¦¬
        window.addEventListener('focus', () => {
            socket.emit('mark_as_read', {
                chat_id: chatId,
                username: username
            });
        });

        // í˜ì´ì§€ ë– ë‚  ë•Œ ë°© ë‚˜ê°€ê¸°
        window.addEventListener('beforeunload', () => {
            socket.emit('leave', { chat_id: chatId, username: username });
        });

        // ì´ëª¨ì§€ í”¼ì»¤ ê¸°ëŠ¥
        const emojiBtn = document.getElementById('emojiBtn');
        const emojiPicker = document.getElementById('emojiPicker');
        const emojiGrid = document.getElementById('emojiGrid');

        // ìì£¼ ì‚¬ìš©í•˜ëŠ” ì´ëª¨ì§€ ëª©ë¡
        const emojis = [
            'ğŸ˜€', 'ğŸ˜', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜…', 'ğŸ˜†', 'ğŸ˜‰', 'ğŸ˜Š',
            'ğŸ˜‹', 'ğŸ˜', 'ğŸ˜', 'ğŸ˜˜', 'ğŸ¥°', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ™‚', 'ğŸ¤—',
            'ğŸ¤©', 'ğŸ¤”', 'ğŸ¤¨', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¶', 'ğŸ™„', 'ğŸ˜', 'ğŸ˜£', 'ğŸ˜¥',
            'ğŸ˜®', 'ğŸ¤', 'ğŸ˜¯', 'ğŸ˜ª', 'ğŸ˜«', 'ğŸ˜´', 'ğŸ˜Œ', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ˜',
            'ğŸ¤¤', 'ğŸ˜’', 'ğŸ˜“', 'ğŸ˜”', 'ğŸ˜•', 'ğŸ™ƒ', 'ğŸ¤‘', 'ğŸ˜²', 'â˜¹ï¸', 'ğŸ™',
            'ğŸ˜–', 'ğŸ˜', 'ğŸ˜Ÿ', 'ğŸ˜¤', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜¨', 'ğŸ˜©',
            'ğŸ¤¯', 'ğŸ˜¬', 'ğŸ˜°', 'ğŸ˜±', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜³', 'ğŸ¤ª', 'ğŸ˜µ', 'ğŸ˜¡',
            'ğŸ˜ ', 'ğŸ¤¬', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ˜‡', 'ğŸ¤ ',
            'ğŸ¥³', 'ğŸ¥´', 'ğŸ¥º', 'ğŸ¤¥', 'ğŸ¤«', 'ğŸ¤­', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜ˆ', 'ğŸ‘¿',
            'ğŸ‘‹', 'ğŸ¤š', 'ğŸ–ï¸', 'âœ‹', 'ğŸ––', 'ğŸ‘Œ', 'ğŸ¤', 'âœŒï¸', 'ğŸ¤', 'ğŸ¤Ÿ',
            'ğŸ¤˜', 'ğŸ¤™', 'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ‘†', 'ğŸ–•', 'ğŸ‘‡', 'â˜ï¸', 'ğŸ‘', 'ğŸ‘',
            'âœŠ', 'ğŸ‘Š', 'ğŸ¤›', 'ğŸ¤œ', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ‘', 'ğŸ¤²', 'ğŸ¤', 'ğŸ™',
            'ğŸ’ª', 'ğŸ¦¾', 'ğŸ¦¿', 'ğŸ¦µ', 'ğŸ¦¶', 'ğŸ‘‚', 'ğŸ¦»', 'ğŸ‘ƒ', 'ğŸ§ ', 'ğŸ¦·',
            'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ¤', 'ğŸ’”',
            'â£ï¸', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–', 'ğŸ’˜', 'ğŸ’', 'ğŸ’Ÿ', 'â˜®ï¸',
            'âœ¨', 'â­', 'ğŸŒŸ', 'ğŸ’«', 'âœ”ï¸', 'âœ…', 'âŒ', 'â', 'âš ï¸', 'ğŸ”¥'
        ];

        // ì´ëª¨ì§€ ê·¸ë¦¬ë“œ ìƒì„±
        emojis.forEach(emoji => {
            const emojiItem = document.createElement('div');
            emojiItem.className = 'emoji-item';
            emojiItem.textContent = emoji;
            emojiItem.onclick = () => {
                messageInput.value += emoji;
                messageInput.focus();
                emojiPicker.classList.remove('show');
            };
            emojiGrid.appendChild(emojiItem);
        });

        // ì´ëª¨ì§€ ë²„íŠ¼ í´ë¦­
        emojiBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            emojiPicker.classList.toggle('show');
        });

        // ì´ëª¨ì§€ í”¼ì»¤ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        document.addEventListener('click', (e) => {
            if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
                emojiPicker.classList.remove('show');
            }
        });

        // íŒŒì¼ ì—…ë¡œë“œ ê¸°ëŠ¥
        const fileInput = document.getElementById('fileInput');
        const attachBtn = document.getElementById('attachBtn');
        const filePreview = document.getElementById('filePreview');
        let selectedFiles = [];

        // ì²¨ë¶€ ë²„íŠ¼ í´ë¦­ì‹œ íŒŒì¼ ì„ íƒì°½ ì—´ê¸°
        attachBtn.addEventListener('click', () => {
            fileInput.click();
        });

        // íŒŒì¼ ì„ íƒì‹œ
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                if (file.size > 50 * 1024 * 1024) {
                    showAlert(`${file.name}ì€(ëŠ”) 50MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`, 'warning');
                    return;
                }
                selectedFiles.push(file);
                displayFilePreview(file);
            });
            fileInput.value = ''; // ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡
        });

        // íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
        function displayFilePreview(file) {
            filePreview.classList.add('show');
            const previewItem = document.createElement('div');
            previewItem.className = 'file-preview-item';

            const isImage = file.type.startsWith('image/');
            if (isImage) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                previewItem.appendChild(img);
            }

            const fileName = document.createElement('span');
            fileName.textContent = file.name;
            previewItem.appendChild(fileName);

            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-file';
            removeBtn.textContent = 'Ã—';
            removeBtn.onclick = () => {
                selectedFiles = selectedFiles.filter(f => f !== file);
                previewItem.remove();
                if (selectedFiles.length === 0) {
                    filePreview.classList.remove('show');
                }
            };
            previewItem.appendChild(removeBtn);

            filePreview.appendChild(previewItem);
        }

        // í´ë¦½ë³´ë“œ ë¶™ì—¬ë„£ê¸° (Ctrl+V)
        document.addEventListener('paste', async (e) => {
            const items = e.clipboardData.items;

            for (let item of items) {
                // ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸°
                if (item.type.startsWith('image/')) {
                    e.preventDefault();
                    const file = item.getAsFile();
                    if (file) {
                        selectedFiles.push(file);
                        displayFilePreview(file);
                    }
                }
            }
        });

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­
        messagesDiv.addEventListener('dragover', (e) => {
            e.preventDefault();
            messagesDiv.style.background = '#f0f0f0';
        });

        messagesDiv.addEventListener('dragleave', () => {
            messagesDiv.style.background = '';
        });

        messagesDiv.addEventListener('drop', (e) => {
            e.preventDefault();
            messagesDiv.style.background = '';

            const files = Array.from(e.dataTransfer.files);
            files.forEach(file => {
                if (file.size > 50 * 1024 * 1024) {
                    showAlert(`${file.name}ì€(ëŠ”) 50MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`, 'warning');
                    return;
                }
                selectedFiles.push(file);
                displayFilePreview(file);
            });
        });

        // ë©”ì‹œì§€ ì „ì†¡ (íŒŒì¼ í¬í•¨)
        async function sendMessageWithFiles() {
            const message = messageInput.value.trim();

            if (!message && selectedFiles.length === 0) return;

            // íŒŒì¼ ì—…ë¡œë“œ
            const fileInfos = [];
            for (let file of selectedFiles) {
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const fileInfo = await response.json();
                        fileInfos.push(fileInfo);
                    } else {
                        showAlert(`${file.name} ì—…ë¡œë“œ ì‹¤íŒ¨`, 'error');
                    }
                } catch (error) {
                    console.error('íŒŒì¼ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                    showAlert(`${file.name} ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ`, 'error');
                }
            }

            // ë©”ì‹œì§€ ì „ì†¡
            console.log('ì „ì†¡í•  ë©”ì‹œì§€:', JSON.stringify(message)); // ë””ë²„ê·¸ìš©
            socket.emit('send_message', {
                chat_id: chatId,
                username: username,
                message: message || 'íŒŒì¼ ì „ì†¡',
                file_info: fileInfos.length > 0 ? fileInfos : null
            });

            // ì´ˆê¸°í™”
            messageInput.value = '';
            messageInput.style.height = 'auto'; // textarea ë†’ì´ ì´ˆê¸°í™”
            selectedFiles = [];
            filePreview.innerHTML = '';
            filePreview.classList.remove('show');
        }

        // ë„ì›€ë§ ëª¨ë‹¬ ì œì–´
        function openHelpModal() {
            document.getElementById('helpModal').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeHelpModal() {
            document.getElementById('helpModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        window.addEventListener('DOMContentLoaded', () => {
            const helpModal = document.getElementById('helpModal');
            if (helpModal) {
                helpModal.addEventListener('click', (e) => {
                    if (e.target === helpModal) {
                        closeHelpModal();
                    }
                });
            }
        });

        // ë„¤ë¹„ê²Œì´ì…˜ ë±ƒì§€ ì—…ë°ì´íŠ¸
        function updateNavBadges(counts) {
            const chatsBadge = document.getElementById('navChatsBadge');
            const remindersBadge = document.getElementById('navRemindersBadge');

            if (chatsBadge) {
                if (counts.unread_chats > 0) {
                    chatsBadge.textContent = counts.unread_chats;
                    chatsBadge.style.display = 'inline-block';
                } else {
                    chatsBadge.style.display = 'none';
                }
            }

            if (remindersBadge) {
                if (counts.today_reminders > 0) {
                    remindersBadge.textContent = counts.today_reminders;
                    remindersBadge.style.display = 'inline-block';
                } else {
                    remindersBadge.style.display = 'none';
                }
            }
        }

        function fetchNavCounts() {
            fetch('/api/nav-counts')
                .then(res => res.json())
                .then(counts => {
                    updateNavBadges(counts);
                })
                .catch(err => console.error('Failed to fetch nav counts:', err));
        }

        socket.on('nav_counts_update', (counts) => {
            updateNavBadges(counts);
        });

        document.addEventListener('DOMContentLoaded', () => {
            fetchNavCounts();
        });

        // ==================== ê²€ìƒ‰ ë° ë‚ ì§œ í•„í„° ê¸°ëŠ¥ ====================
        let searchResults = [];
        let currentSearchIndex = -1;
        let chatDates = [];  // ë©”ì‹œì§€ê°€ ìˆëŠ” ë‚ ì§œ ëª©ë¡
        let calendarDate = new Date();  // ìº˜ë¦°ë”ì— í‘œì‹œí•  ì›”

        // ê²€ìƒ‰ íŒ¨ë„ ì—´ê¸°/ë‹«ê¸°
        function toggleSearchPanel() {
            const panel = document.getElementById('searchPanel');
            panel.classList.toggle('show');
            if (panel.classList.contains('show')) {
                document.getElementById('searchInput').focus();
                loadChatDates();  // ë‚ ì§œ ëª©ë¡ ë¯¸ë¦¬ ë¡œë“œ
            }
        }

        function closeSearchPanel() {
            const panel = document.getElementById('searchPanel');
            panel.classList.remove('show');
            clearSearchHighlights();
            document.getElementById('searchResultsInfo').style.display = 'none';
        }

        // ê²€ìƒ‰ ìˆ˜í–‰
        async function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                showAlert('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'warning');
                return;
            }

            try {
                const res = await fetch(`/api/chats/${chatId}/search?q=${encodeURIComponent(query)}`);
                const data = await res.json();

                searchResults = data.results;
                currentSearchIndex = -1;

                const resultsInfo = document.getElementById('searchResultsInfo');
                const resultsText = document.getElementById('searchResultsText');

                if (searchResults.length > 0) {
                    resultsText.textContent = `ê²€ìƒ‰ ê²°ê³¼: ${searchResults.length}ê±´`;
                    resultsInfo.style.display = 'flex';
                    // ì²« ë²ˆì§¸ ê²°ê³¼ë¡œ ì´ë™
                    navigateSearchResult(1);
                } else {
                    resultsText.textContent = 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.';
                    resultsInfo.style.display = 'flex';
                }
            } catch (error) {
                console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                showAlert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ê²€ìƒ‰ ê²°ê³¼ ë„¤ë¹„ê²Œì´ì…˜
        async function navigateSearchResult(direction) {
            if (searchResults.length === 0) return;

            currentSearchIndex += direction;

            // ë²”ìœ„ ì œí•œ
            if (currentSearchIndex < 0) currentSearchIndex = searchResults.length - 1;
            if (currentSearchIndex >= searchResults.length) currentSearchIndex = 0;

            const result = searchResults[currentSearchIndex];

            // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ (ë¨¼ì € í‘œì‹œ)
            document.getElementById('searchResultsText').textContent =
                `ê²€ìƒ‰ ê²°ê³¼: ${currentSearchIndex + 1} / ${searchResults.length}`;

            // í•´ë‹¹ ë©”ì‹œì§€ë¡œ ìŠ¤í¬ë¡¤ ë° í•˜ì´ë¼ì´íŠ¸
            await scrollToMessageById(result.id, document.getElementById('searchInput').value.trim());
        }

        // íŠ¹ì • ë©”ì‹œì§€ IDë¡œ ìŠ¤í¬ë¡¤
        async function scrollToMessageById(msgId, highlightText = null) {
            const msgEl = messagesDiv.querySelector(`[data-msg-id="${msgId}"]`);

            if (msgEl) {
                clearSearchHighlights();
                msgEl.classList.add('search-highlight');
                msgEl.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // í…ìŠ¤íŠ¸ í•˜ì´ë¼ì´íŠ¸
                if (highlightText) {
                    highlightTextInMessage(msgEl, highlightText);
                }
            } else {
                // ë©”ì‹œì§€ê°€ í™”ë©´ì— ì—†ìœ¼ë©´ APIë¡œ ì»¨í…ìŠ¤íŠ¸ ë¡œë“œ í›„ í‘œì‹œ
                await loadMessageAndScroll(msgId, highlightText);
            }
        }

        // ë©”ì‹œì§€ ë‚´ í…ìŠ¤íŠ¸ í•˜ì´ë¼ì´íŠ¸
        function highlightTextInMessage(msgEl, text) {
            const msgTextEl = msgEl.querySelector('.message-text');
            if (!msgTextEl) return;

            const originalHtml = msgTextEl.innerHTML;
            const regex = new RegExp(`(${escapeRegex(text)})`, 'gi');
            msgTextEl.innerHTML = originalHtml.replace(regex, '<span class="search-match">$1</span>');
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // í™”ë©´ì— ì—†ëŠ” ë©”ì‹œì§€ ë¡œë“œ í›„ ìŠ¤í¬ë¡¤
        // ë©”ì‹œì§€ ì£¼ë³€ ì»¨í…ìŠ¤íŠ¸ë¥¼ APIë¡œ ê°€ì ¸ì™€ì„œ í™”ë©´ì„ ë‹¤ì‹œ ë Œë”ë§
        async function loadMessageAndScroll(msgId, highlightText) {
            try {
                // ë©”ì‹œì§€ ì£¼ë³€ ì»¨í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸° (ì•ë’¤ ê° 30ê°œì”©)
                const res = await fetch(`/api/chats/${chatId}/messages/context/${msgId}?before=30&after=30`);

                if (!res.ok) {
                    showAlert('í•´ë‹¹ ë©”ì‹œì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }

                const data = await res.json();

                // ê¸°ì¡´ ë©”ì‹œì§€ ë¹„ìš°ê³  ìƒˆë¡œ ë Œë”ë§
                messagesDiv.innerHTML = '';
                lastDisplayedDate = null;

                // ì´ì „ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ "ë” ë³´ê¸°" í‘œì‹œ
                if (data.has_more_before) {
                    const loadMoreDiv = document.createElement('div');
                    loadMoreDiv.className = 'load-more-indicator';
                    loadMoreDiv.innerHTML = `
                        <button onclick="returnToLatestMessages()" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                            ğŸ”„ ìµœì‹  ë©”ì‹œì§€ë¡œ ëŒì•„ê°€ê¸°
                        </button>
                    `;
                    loadMoreDiv.style.cssText = 'text-align: center; padding: 15px; color: #666;';
                    messagesDiv.appendChild(loadMoreDiv);
                }

                // ë©”ì‹œì§€ ë Œë”ë§
                data.messages.forEach(msg => {
                    displayMessage(msg, chatParticipants);
                });

                // ì´í›„ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ "ìµœì‹ ìœ¼ë¡œ" ë²„íŠ¼ í‘œì‹œ
                if (data.has_more_after) {
                    const goLatestDiv = document.createElement('div');
                    goLatestDiv.className = 'go-latest-indicator';
                    goLatestDiv.innerHTML = `
                        <button onclick="returnToLatestMessages()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">
                            â†“ ìµœì‹  ë©”ì‹œì§€ë¡œ ì´ë™
                        </button>
                    `;
                    goLatestDiv.style.cssText = 'text-align: center; padding: 15px; color: #666;';
                    messagesDiv.appendChild(goLatestDiv);
                }

                // ìƒíƒœ ì—…ë°ì´íŠ¸ (ë¬´í•œ ìŠ¤í¬ë¡¤ ì¼ì‹œ ì¤‘ë‹¨)
                contextMode = true;  // ì»¨í…ìŠ¤íŠ¸ ëª¨ë“œ í”Œë˜ê·¸

                // íƒ€ê²Ÿ ë©”ì‹œì§€ë¡œ ìŠ¤í¬ë¡¤ ë° í•˜ì´ë¼ì´íŠ¸
                setTimeout(() => {
                    const targetMsgEl = messagesDiv.querySelector(`[data-msg-id="${msgId}"]`);
                    if (targetMsgEl) {
                        clearSearchHighlights();
                        targetMsgEl.classList.add('search-highlight');
                        targetMsgEl.scrollIntoView({ behavior: 'smooth', block: 'center' });

                        if (highlightText) {
                            highlightTextInMessage(targetMsgEl, highlightText);
                        }
                    }
                }, 100);

            } catch (error) {
                console.error('ë©”ì‹œì§€ ì»¨í…ìŠ¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
                showAlert('ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        // ìµœì‹  ë©”ì‹œì§€ë¡œ ëŒì•„ê°€ê¸°
        async function returnToLatestMessages() {
            contextMode = false;
            messagesDiv.innerHTML = '';
            lastDisplayedDate = null;
            currentOffset = 0;
            hasMoreMessages = true;
            await loadInitialMessages();
        }

        // ê²€ìƒ‰ í•˜ì´ë¼ì´íŠ¸ ì œê±°
        function clearSearchHighlights() {
            messagesDiv.querySelectorAll('.search-highlight').forEach(el => {
                el.classList.remove('search-highlight');
            });
            messagesDiv.querySelectorAll('.search-match').forEach(el => {
                el.outerHTML = el.textContent;
            });
        }

        // ê²€ìƒ‰ì–´ ì§€ìš°ê¸°
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            searchResults = [];
            currentSearchIndex = -1;
            clearSearchHighlights();
            document.getElementById('searchResultsInfo').style.display = 'none';
        }

        // ê²€ìƒ‰ ì…ë ¥ì°½ ì—”í„° í‚¤ ì²˜ë¦¬
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // ==================== ë‚ ì§œ ì„ íƒ ê¸°ëŠ¥ ====================
        async function loadChatDates() {
            try {
                const res = await fetch(`/api/chats/${chatId}/dates`);
                const data = await res.json();
                chatDates = data.dates;
            } catch (error) {
                console.error('ë‚ ì§œ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        function openDatePicker() {
            document.getElementById('datePickerModal').classList.add('show');
            renderCalendar();
        }

        function closeDatePicker() {
            document.getElementById('datePickerModal').classList.remove('show');
        }

        function changeMonth(delta) {
            calendarDate.setMonth(calendarDate.getMonth() + delta);
            renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthLabel = document.getElementById('calendarMonth');

            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();

            monthLabel.textContent = `${year}ë…„ ${month + 1}ì›”`;

            // ìº˜ë¦°ë” ê·¸ë¦¬ë“œ ìƒì„±
            grid.innerHTML = '';

            // ìš”ì¼ í—¤ë”
            const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
            dayNames.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });

            // ì²« ë‚ ê³¼ ë§ˆì§€ë§‰ ë‚ 
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);

            // ì´ì „ ë‹¬ ë¹ˆ ì¹¸
            for (let i = 0; i < firstDay.getDay(); i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day other-month';
                grid.appendChild(emptyDay);
            }

            // ë‚ ì§œ ì±„ìš°ê¸°
            const today = new Date().toISOString().split('T')[0];

            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.textContent = day;

                // ì˜¤ëŠ˜ í‘œì‹œ
                if (dateStr === today) {
                    dayEl.classList.add('today');
                }

                // ë©”ì‹œì§€ê°€ ìˆëŠ” ë‚ ì§œ í‘œì‹œ
                if (chatDates.includes(dateStr)) {
                    dayEl.classList.add('has-messages');
                    dayEl.onclick = () => selectDate(dateStr);
                } else {
                    dayEl.classList.add('no-messages');
                }

                grid.appendChild(dayEl);
            }
        }

        // ë‚ ì§œ ì„ íƒ ì‹œ í•´ë‹¹ ë‚ ì§œë¡œ ì´ë™
        async function selectDate(dateStr) {
            closeDatePicker();
            await jumpToDate(dateStr);
        }

        // íŠ¹ì • ë‚ ì§œë¡œ ì í”„
        async function jumpToDate(dateStr) {
            try {
                // í•´ë‹¹ ë‚ ì§œì˜ ì²« ë²ˆì§¸ ë©”ì‹œì§€ ê²€ìƒ‰
                const res = await fetch(`/api/chats/${chatId}/search?date=${dateStr}`);
                const data = await res.json();

                if (data.results && data.results.length > 0) {
                    const firstMsgOfDate = data.results[0];

                    // í•´ë‹¹ ë‚ ì§œ êµ¬ë¶„ì„ ìœ¼ë¡œ ìŠ¤í¬ë¡¤
                    const dateSeparator = messagesDiv.querySelector(`[data-date="${dateStr}"]`);
                    if (dateSeparator) {
                        dateSeparator.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    } else {
                        // ë‚ ì§œ êµ¬ë¶„ì„ ì´ ì—†ìœ¼ë©´ ë©”ì‹œì§€ ì»¨í…ìŠ¤íŠ¸ ë¡œë“œ í›„ ìŠ¤í¬ë¡¤
                        await scrollToMessageById(firstMsgOfDate.id);
                    }
                } else {
                    showAlert('í•´ë‹¹ ë‚ ì§œì— ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.', 'info');
                }
            } catch (error) {
                console.error('ë‚ ì§œ ì´ë™ ì˜¤ë¥˜:', error);
            }
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.getElementById('datePickerModal').addEventListener('click', (e) => {
            if (e.target.id === 'datePickerModal') {
                closeDatePicker();
            }
        });

        // Ctrl+Fë¡œ ê²€ìƒ‰ íŒ¨ë„ ì—´ê¸°
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
                e.preventDefault();
                toggleSearchPanel();
            }
            // ESCë¡œ ê²€ìƒ‰ íŒ¨ë„ ë‹«ê¸°
            if (e.key === 'Escape') {
                closeSearchPanel();
                closeDatePicker();
            }
        });
</script>

<!-- ì´ë¯¸ì§€ ëª¨ë‹¬ íŒì—… -->
<div id="imageModal" class="image-modal" onclick="closeImageModal()">
    <span class="image-modal-close">&times;</span>
    <div class="image-modal-content" onclick="event.stopPropagation()">
        <img id="imageModalImg" src="" alt="">
    </div>
    <div class="image-modal-filename" id="imageModalFilename"></div>
</div>

<!-- ë„ì›€ë§ ë²„íŠ¼ -->
<button class="help-button" onclick="openHelpModal()" title="ì‚¬ìš©ë²• ë„ì›€ë§">
    â“
</button>

<!-- ë„ì›€ë§ ëª¨ë‹¬ -->
<div class="help-modal" id="helpModal">
    <div class="help-modal-content">
        <div class="help-modal-header">
            <div class="help-modal-title">
                ğŸ“– ì±„íŒ…ë°© ì‚¬ìš©ë²•
            </div>
            <button class="help-modal-close" onclick="closeHelpModal()">&times;</button>
        </div>

        <div class="help-modal-body">
        <div class="help-section">
            <div class="help-section-title">ğŸ’¬ ë©”ì‹œì§€ ë³´ë‚´ê¸°</div>
            <div class="help-content">
                <ul>
                    <li><strong>í…ìŠ¤íŠ¸ ì…ë ¥</strong>: í•˜ë‹¨ ì…ë ¥ì°½ì— ë©”ì‹œì§€ ì‘ì„±</li>
                    <li><strong>Enter</strong>: ë©”ì‹œì§€ ì „ì†¡</li>
                    <li><strong>Shift + Enter</strong>: ì¤„ë°”ê¿ˆ</li>
                    <li><strong>ì´ëª¨ì§€ ë²„íŠ¼ (ğŸ˜Š)</strong>: ì´ëª¨ì§€ ì„ íƒ ë° ì „ì†¡</li>
                    <li><strong>íŒŒì¼ ì²¨ë¶€ (ğŸ“)</strong>: ì´ë¯¸ì§€, ë¬¸ì„œ ë“± íŒŒì¼ ì²¨ë¶€</li>
                </ul>
            </div>
        </div>

        <div class="help-section">
            <div class="help-section-title">ğŸ“ íŒŒì¼ ê³µìœ </div>
            <div class="help-content">
                <ul>
                    <li><strong>íŒŒì¼ ì²¨ë¶€</strong>: ğŸ“ ë²„íŠ¼ í´ë¦­ ë˜ëŠ” ë“œë˜ê·¸ ì•¤ ë“œë¡­</li>
                    <li><strong>ì´ë¯¸ì§€</strong>: ì±„íŒ…ì°½ì—ì„œ ë°”ë¡œ ë¯¸ë¦¬ë³´ê¸°, í´ë¦­í•˜ë©´ í¬ê²Œ ë³´ê¸°</li>
                    <li><strong>ë¬¸ì„œ íŒŒì¼</strong>: í´ë¦­í•˜ì—¬ ë‹¤ìš´ë¡œë“œ</li>
                    <li><strong>ì—¬ëŸ¬ íŒŒì¼</strong>: í•œ ë²ˆì— ì—¬ëŸ¬ íŒŒì¼ ì²¨ë¶€ ê°€ëŠ¥</li>
                </ul>
            </div>
        </div>

        <div class="help-section">
            <div class="help-section-title">ğŸ‘ï¸ ì½ìŒ í‘œì‹œ</div>
            <div class="help-content">
                <ul>
                    <li><strong>ë¹¨ê°„ ìˆ«ì</strong>: ì•„ì§ ì½ì§€ ì•Šì€ ì‚¬ëŒ ìˆ˜ í‘œì‹œ</li>
                    <li><strong>0ëª…</strong>: ëª¨ë“  ì°¸ì—¬ìê°€ ì½ìŒ</li>
                    <li><strong>ìë™ ì—…ë°ì´íŠ¸</strong>: ìƒëŒ€ë°©ì´ ì½ìœ¼ë©´ ì‹¤ì‹œê°„ ë°˜ì˜</li>
                    <li><strong>ì±„íŒ…ë°© ì…ì¥</strong>: ìë™ìœ¼ë¡œ ì½ìŒ ì²˜ë¦¬ë¨</li>
                </ul>
            </div>
        </div>

        <div class="help-section">
            <div class="help-section-title">âŒ¨ï¸ ì…ë ¥ ì¤‘ í‘œì‹œ</div>
            <div class="help-content">
                <ul>
                    <li><strong>ìƒëŒ€ë°©ì´ ì…ë ¥ ì¤‘</strong>: "OOOë‹˜ì´ ì…ë ¥ ì¤‘..." í‘œì‹œ</li>
                    <li><strong>ì‹¤ì‹œê°„ ë°˜ì˜</strong>: ìƒëŒ€ë°©ì´ ì…ë ¥ì„ ì‹œì‘í•˜ë©´ ì¦‰ì‹œ í‘œì‹œ</li>
                    <li><strong>ì—¬ëŸ¬ ëª… ì…ë ¥</strong>: ì—¬ëŸ¬ ì‚¬ëŒì´ ë™ì‹œì— ì…ë ¥ ì¤‘ì¼ ë•Œ ëª¨ë‘ í‘œì‹œ</li>
                </ul>
            </div>
        </div>

        <div class="help-section">
            <div class="help-section-title">ğŸ”” ì•Œë¦¼ ê¸°ëŠ¥</div>
            <div class="help-content">
                <ul>
                    <li><strong>ë¸Œë¼ìš°ì € ì•Œë¦¼</strong>: ì±„íŒ…ë°© ë°–ì—ì„œë„ ìƒˆ ë©”ì‹œì§€ ì•Œë¦¼</li>
                    <li><strong>ì½ì§€ ì•Šì€ ë©”ì‹œì§€</strong>: ì±„íŒ… ëª©ë¡ì—ì„œ ë¹¨ê°„ ë°°ì§€ë¡œ í‘œì‹œ</li>
                    <li><strong>ë‹¹ì¼ ì˜ˆì•½ ë°°ë„ˆ</strong>: ì˜¤ëŠ˜ ì˜ˆì•½ì´ ìˆìœ¼ë©´ ìƒë‹¨ ë°°ë„ˆ í‘œì‹œ</li>
                    <li><strong>ì•Œë¦¼ ê¶Œí•œ</strong>: ë¸Œë¼ìš°ì €ì—ì„œ ì•Œë¦¼ ê¶Œí•œ í—ˆìš© í•„ìš”</li>
                </ul>
            </div>
        </div>

        <div class="help-section">
            <div class="help-section-title">ğŸ¨ í—¤ë” í™”ë©´ ì„¤ì •</div>
            <div class="help-content">
                <ul>
                    <li><strong>ë‹¤í¬ëª¨ë“œ í† ê¸€</strong>: í—¤ë” ìš°ì¸¡ì˜ â˜€ï¸/ğŸŒ™ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ë¼ì´íŠ¸/ë‹¤í¬ ëª¨ë“œ ì „í™˜</li>
                    <li><strong>ê¸€ì í¬ê¸° ì¡°ì ˆ</strong>: í—¤ë”ì˜ [ê°€][ê°€][ê°€] ë²„íŠ¼ìœ¼ë¡œ ì‘ê²Œ/ë³´í†µ/í¬ê²Œ ì¡°ì ˆ</li>
                    <li>ì„¤ì •ì€ ë¸Œë¼ìš°ì €ì— ìë™ ì €ì¥ë˜ì–´ ë‹¤ìŒ ì ‘ì† ì‹œì—ë„ ìœ ì§€ë©ë‹ˆë‹¤</li>
                </ul>
            </div>
        </div>

        <div class="help-tip">
            <strong>ğŸ’¡ íŒ:</strong> ì´ë¯¸ì§€ë¥¼ í´ë¦­í•˜ë©´ í¬ê²Œ ë³¼ ìˆ˜ ìˆìœ¼ë©°, íŒŒì¼ëª…ì„ í´ë¦­í•˜ë©´ ë‹¤ìš´ë¡œë“œë©ë‹ˆë‹¤. Shift + Enterë¡œ ì—¬ëŸ¬ ì¤„ ë©”ì‹œì§€ë¥¼ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
        </div><!-- help-modal-body ë -->
    </div>
</div>

    {% include 'includes/today_reminders.html' %}
    {% include 'includes/alert_modal.html' %}
</body>
</html>
