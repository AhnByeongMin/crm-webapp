<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ chat_title }}</title>
    <!-- PWA ë©”íƒ€ íƒœê·¸ -->
    <meta name="description" content="ê¸´ê¸‰ ìƒí™©ì„ ìœ„í•œ ì—…ë¬´ í• ë‹¹ ë° ì±„íŒ… ì‹œìŠ¤í…œ">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ì—…ë¬´ê´€ë¦¬">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icon-192.png">
    <link rel="apple-touch-icon" href="/static/icon-192.png">

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: #f5f5f5;
        }
        .header {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 18px; color: #333; }
        .back-btn {
            padding: 8px 16px;
            background: #6c757d;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
        }
        .back-btn:hover { background: #5a6268; }
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 1000px;
            width: 100%;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            max-height: calc(100vh - 60px); /* í—¤ë” ë†’ì´ ì œì™¸ */
            overflow: hidden; /* ì»¨í…Œì´ë„ˆ ìì²´ëŠ” ë„˜ì¹˜ì§€ ì•Šê²Œ */
            position: relative; /* ì´ëª¨ì§€ í”¼ì»¤ ìœ„ì¹˜ ê¸°ì¤€ */
        }
        #messages {
            flex: 1;
            overflow-y: auto; /* ìŠ¤í¬ë¡¤ ê°€ëŠ¥ */
            overflow-x: hidden;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 0; /* flex itemì—ì„œ ìŠ¤í¬ë¡¤ì´ ì‘ë™í•˜ë„ë¡ */
        }
        .message {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 18px;
            word-wrap: break-word;
        }
        .message.own {
            align-self: flex-end;
            background: #667eea;
            color: white;
        }
        .message.other {
            align-self: flex-start;
            background: #e9ecef;
            color: #333;
        }
        .message-header {
            font-size: 12px;
            margin-bottom: 4px;
            opacity: 0.8;
        }
        .message-text {
            font-size: 14px;
            line-height: 1.4;
        }
        .message-text.emoji-only {
            font-size: 48px;
            line-height: 1;
            background: none !important;
        }
        .message.emoji-only-message {
            background: none !important;
            padding: 5px;
        }
        .message-time {
            font-size: 11px;
            margin-top: 4px;
            opacity: 0.7;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .read-count {
            font-size: 12px;
            color: #ff0000;
            font-weight: bold;
            background: #ffebee;
            padding: 2px 6px;
            border-radius: 10px;
            margin-right: 5px;
        }
        .system-message {
            align-self: center;
            font-size: 12px;
            color: #999;
            background: none;
            padding: 5px;
        }
        .input-area {
            display: flex;
            padding: 15px;
            background: white;
            border-top: 1px solid #ddd;
            gap: 10px;
        }
        #messageInput {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 14px;
            outline: none;
        }
        #messageInput:focus {
            border-color: #667eea;
        }
        #sendBtn {
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        #sendBtn:hover {
            background: #5568d3;
        }
        .typing-indicator {
            padding: 10px 20px;
            font-size: 13px;
            color: #666;
            font-style: italic;
            background: #f8f9fa;
            border-radius: 15px;
            align-self: flex-start;
            display: none;
        }
        .typing-indicator.show {
            display: block;
        }
        .typing-dots {
            display: inline-block;
        }
        .typing-dots span {
            animation: blink 1.4s infinite;
            animation-fill-mode: both;
        }
        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes blink {
            0%, 80%, 100% { opacity: 0; }
            40% { opacity: 1; }
        }
        .notification-banner {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px 20px;
            display: none;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .notification-banner.show {
            display: flex;
        }
        .notification-banner-text {
            flex: 1;
            color: #856404;
        }
        .notification-banner-text strong {
            display: block;
            margin-bottom: 5px;
        }
        .notification-banner-text small {
            font-size: 12px;
        }
        .notification-banner button {
            background: #ffc107;
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .notification-banner button:hover {
            background: #e0a800;
        }
        .close-banner {
            background: transparent !important;
            color: #856404 !important;
            font-size: 20px;
            padding: 0 8px !important;
        }
        #attachBtn {
            padding: 10px 16px;
            background: #f0f0f0;
            color: #555;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #attachBtn:hover {
            background: #e0e0e0;
            border-color: #667eea;
            color: #667eea;
        }
        #emojiBtn {
            padding: 10px 16px;
            background: #f0f0f0;
            color: #555;
            border: 1px solid #ddd;
            border-radius: 20px;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #emojiBtn:hover {
            background: #e0e0e0;
            border-color: #667eea;
            color: #667eea;
        }
        .emoji-picker {
            position: absolute;
            bottom: 70px;
            left: 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 12px;
            padding: 15px;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-width: 320px;
            z-index: 1000;
        }
        .emoji-picker.show {
            display: block;
        }
        .emoji-picker-header {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }
        .emoji-item {
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            text-align: center;
            transition: all 0.2s;
        }
        .emoji-item:hover {
            background: #f0f0f0;
            transform: scale(1.2);
        }
        .file-preview {
            padding: 10px 15px;
            background: #f8f9fa;
            border-top: 1px solid #ddd;
            display: none;
            gap: 10px;
            flex-wrap: wrap;
        }
        .file-preview.show {
            display: flex;
        }
        .file-preview-item {
            position: relative;
            padding: 8px 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }
        .file-preview-item img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
        }
        .file-preview-item .remove-file {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
            line-height: 1;
        }
        .message-file {
            margin-top: 8px;
            padding: 10px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            cursor: pointer;
        }
        .message-file img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            display: block;
        }
        .message-file.document {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .message-file.document:hover {
            background: rgba(255,255,255,0.3);
        }

        /* ì´ë¯¸ì§€ ëª¨ë‹¬ íŒì—… */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            animation: fadeIn 0.2s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .image-modal-content {
            position: relative;
            margin: auto;
            padding: 0;
            width: 90%;
            max-width: 1200px;
            height: 90%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .image-modal-content img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
        }
        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 40px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10001;
            transition: 0.3s;
        }
        .image-modal-close:hover,
        .image-modal-close:focus {
            color: #bbb;
        }
        .image-modal-filename {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #fff;
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="notificationBanner" class="notification-banner">
        <div class="notification-banner-text">
            <strong>ğŸ’¡ ì•Œë¦¼ ì•ˆë‚´</strong>
            <small>HTTP í™˜ê²½ì—ì„œëŠ” ë¸Œë¼ìš°ì € í‘¸ì‹œ ì•Œë¦¼ì´ ì‘ë™í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ëŒ€ì‹  íƒ­ ì œëª© ê¹œë¹¡ì„ìœ¼ë¡œ ìƒˆ ë©”ì‹œì§€ë¥¼ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.</small>
        </div>
        <button class="close-banner" onclick="closeBanner()">Ã—</button>
    </div>

    <div class="header">
        <h1>{{ chat_title }}</h1>
        <div class="nav" style="display: flex; gap: 10px;">
            {% if is_admin %}
            <a href="/admin" style="padding: 8px 16px; background: #667eea; color: white; text-decoration: none; border-radius: 4px; font-size: 14px;">í• ì¼ê´€ë¦¬</a>
            {% endif %}
            <a href="/promotions" style="padding: 8px 16px; background: #667eea; color: white; text-decoration: none; border-radius: 4px; font-size: 14px;">í”„ë¡œëª¨ì…˜ê²Œì‹œíŒ</a>
            <a href="/chats" style="padding: 8px 16px; background: #667eea; color: white; text-decoration: none; border-radius: 4px; font-size: 14px;">ì±„íŒ…</a>
            <a href="/" style="padding: 8px 16px; background: #667eea; color: white; text-decoration: none; border-radius: 4px; font-size: 14px;">í™ˆìœ¼ë¡œ</a>
            <a href="/logout" style="padding: 8px 16px; background: #6c757d; color: white; text-decoration: none; border-radius: 4px; font-size: 14px;">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
    </div>

    <div class="chat-container">
        <div id="messages"></div>
        <div id="typingIndicator" class="typing-indicator">
            <span id="typingUser"></span>ë‹˜ì´ ì…ë ¥ ì¤‘<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>
        </div>
        <div class="input-area">
            <input type="file" id="fileInput" style="display: none;" multiple>
            <button id="attachBtn" title="íŒŒì¼ ì²¨ë¶€">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                </svg>
            </button>
            <button id="emojiBtn" title="ì´ëª¨ì§€">ğŸ˜Š</button>
            <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off">
            <button id="sendBtn">ì „ì†¡</button>
        </div>
        <div id="emojiPicker" class="emoji-picker">
            <div class="emoji-picker-header">ì´ëª¨ì§€ ì„ íƒ</div>
            <div class="emoji-grid" id="emojiGrid"></div>
        </div>
        <div id="filePreview" class="file-preview"></div>
    </div>

    <script>
        const socket = io();
        const chatId = '{{ chat_id }}';
        const username = '{{ username }}';
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const typingIndicator = document.getElementById('typingIndicator');
        const typingUser = document.getElementById('typingUser');
        let notificationPermission = false;
        let isPageVisible = true;
        let typingTimeout = null;
        let isTyping = false;
        let unreadCount = 0;
        let originalTitle = '{{ chat_title }}';
        let titleBlinkInterval = null;

        // ì•Œë¦¼ ê¶Œí•œ ìš”ì²­ (ëª…í™•í•œ ìš”ì²­)
        if ('Notification' in window) {
            console.log('í˜„ì¬ ì•Œë¦¼ ê¶Œí•œ ìƒíƒœ:', Notification.permission);

            if (Notification.permission === 'default') {
                // í˜ì´ì§€ ë¡œë“œ ì§í›„ ê¶Œí•œ ìš”ì²­
                setTimeout(() => {
                    Notification.requestPermission().then(permission => {
                        console.log('ì•Œë¦¼ ê¶Œí•œ ì‘ë‹µ:', permission);
                        notificationPermission = permission === 'granted';

                        if (notificationPermission) {
                            // í…ŒìŠ¤íŠ¸ ì•Œë¦¼
                            new Notification('ì•Œë¦¼ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤!', {
                                body: 'ìƒˆë¡œìš´ ë©”ì‹œì§€ë¥¼ ë°›ìœ¼ë©´ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.',
                                icon: '/favicon.ico'
                            });
                        }
                    });
                }, 1000);
            } else if (Notification.permission === 'granted') {
                notificationPermission = true;
                console.log('ì•Œë¦¼ ê¶Œí•œ ì´ë¯¸ í—ˆìš©ë¨');
            } else {
                console.log('ì•Œë¦¼ ê¶Œí•œ ê±°ë¶€ë¨ (HTTP í™˜ê²½ì—ì„œëŠ” ì •ìƒ)');
                // HTTP í™˜ê²½ ì•ˆë‚´ ë°°ë„ˆ í‘œì‹œ (ì„ íƒì )
                // document.getElementById('notificationBanner').classList.add('show');
            }
        } else {
            console.log('ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤');
        }

        function closeBanner() {
            document.getElementById('notificationBanner').classList.remove('show');
        }

        // í˜ì´ì§€ ê°€ì‹œì„± ê°ì§€
        document.addEventListener('visibilitychange', () => {
            isPageVisible = !document.hidden;

            // í˜ì´ì§€ê°€ ë³´ì´ë©´ ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ì¹´ìš´íŠ¸ ë¦¬ì…‹
            if (isPageVisible) {
                unreadCount = 0;
                stopTitleBlink();
                document.title = originalTitle;
            }
        });

        // íƒ­ì´ í¬ì»¤ìŠ¤ë˜ë©´ ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ì¹´ìš´íŠ¸ ë¦¬ì…‹
        window.addEventListener('focus', () => {
            unreadCount = 0;
            stopTitleBlink();
            document.title = originalTitle;
        });

        function startTitleBlink() {
            if (titleBlinkInterval) {
                console.log('ì´ë¯¸ ì œëª© ê¹œë¹¡ì„ ì¤‘');
                return; // ì´ë¯¸ ê¹œë¹¡ì´ëŠ” ì¤‘ì´ë©´ ë¬´ì‹œ
            }

            console.log('ì œëª© ê¹œë¹¡ì„ ì‹œì‘! ì½ì§€ ì•Šì€ ë©”ì‹œì§€:', unreadCount);
            let isOriginal = true;
            titleBlinkInterval = setInterval(() => {
                if (isOriginal) {
                    document.title = `ğŸ”´ (${unreadCount}) ìƒˆ ë©”ì‹œì§€`;
                } else {
                    document.title = originalTitle;
                }
                console.log('ì œëª© ë³€ê²½:', document.title);
                isOriginal = !isOriginal;
            }, 1000); // 1ì´ˆë§ˆë‹¤ ê¹œë¹¡ì„
        }

        function stopTitleBlink() {
            if (titleBlinkInterval) {
                console.log('ì œëª© ê¹œë¹¡ì„ ì¤‘ì§€');
                clearInterval(titleBlinkInterval);
                titleBlinkInterval = null;
            }
        }

        function showChatNotification(senderName, message) {
            if (!notificationPermission || isPageVisible) return;

            const notification = new Notification(`${senderName}ë‹˜ì˜ ë©”ì‹œì§€`, {
                body: message,
                icon: '/favicon.ico',
                badge: '/favicon.ico',
                tag: 'chat-' + chatId,
                requireInteraction: false
            });

            notification.onclick = function() {
                window.focus();
                notification.close();
            };
        }

        // ë°© ì…ì¥
        socket.emit('join', { chat_id: chatId, username: username });

        let chatParticipants = [];

        // ê¸°ì¡´ ë©”ì‹œì§€ ë¡œë“œ
        fetch('/api/chats')
            .then(res => res.json())
            .then(chats => {
                const chat = chats[chatId];
                if (chat && chat.messages) {
                    chatParticipants = chat.participants || [];
                    chat.messages.forEach(msg => {
                        displayMessage(msg, chatParticipants);
                    });
                    scrollToBottom();

                    // í˜ì´ì§€ ì§„ì…ì‹œ ëª¨ë“  ë©”ì‹œì§€ë¥¼ ì½ìŒ ì²˜ë¦¬
                    socket.emit('mark_as_read', {
                        chat_id: chatId,
                        username: username
                    });
                }
            });

        // ë©”ì‹œì§€ ì „ì†¡ (ì„ì‹œ - ë‚˜ì¤‘ì— sendMessageWithFilesë¡œ ëŒ€ì²´ë¨)
        function sendMessage() {
            // íŒŒì¼ì´ ìˆìœ¼ë©´ sendMessageWithFiles í˜¸ì¶œ
            if (selectedFiles && selectedFiles.length > 0) {
                sendMessageWithFiles();
            } else {
                const message = messageInput.value.trim();
                if (message) {
                    socket.emit('send_message', {
                        chat_id: chatId,
                        username: username,
                        message: message,
                        file_info: null
                    });
                    messageInput.value = '';
                }
            }
        }

        sendBtn.addEventListener('click', () => {
            sendMessageWithFiles();
        });
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessageWithFiles();
            }
        });

        // íƒ€ì´í•‘ ê°ì§€
        messageInput.addEventListener('input', () => {
            if (!isTyping) {
                isTyping = true;
                socket.emit('typing_start', { chat_id: chatId, username: username });
            }

            // íƒ€ì´í•‘ íƒ€ì„ì•„ì›ƒ ë¦¬ì…‹
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                isTyping = false;
                socket.emit('typing_stop', { chat_id: chatId, username: username });
            }, 1000); // 1ì´ˆ ë™ì•ˆ ì…ë ¥ì´ ì—†ìœ¼ë©´ íƒ€ì´í•‘ ì¤‘ì§€
        });

        // ìƒˆ ë©”ì‹œì§€ ìˆ˜ì‹ 
        socket.on('new_message', (msg) => {
            console.log('ìƒˆ ë©”ì‹œì§€ ìˆ˜ì‹ :', msg);
            console.log('íŒŒì¼ ì •ë³´:', msg.file_info);
            displayMessage(msg, chatParticipants);
            scrollToBottom();

            // í˜ì´ì§€ê°€ í¬ì»¤ìŠ¤ë˜ì–´ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ì½ìŒ ì²˜ë¦¬
            if (document.hasFocus()) {
                socket.emit('mark_as_read', {
                    chat_id: chatId,
                    username: username
                });
            }

            // ë‹¤ë¥¸ ì‚¬ëŒì˜ ë©”ì‹œì§€ë©´ ì•Œë¦¼ í‘œì‹œ
            if (msg.username !== username) {
                console.log('ìƒˆ ë©”ì‹œì§€ ìˆ˜ì‹ :', msg.username, 'í˜ì´ì§€ ê°€ì‹œì„±:', isPageVisible, 'í¬ì»¤ìŠ¤:', document.hasFocus());

                // íƒ­ì´ ë³´ì´ì§€ ì•Šê±°ë‚˜ í¬ì»¤ìŠ¤ê°€ ì—†ìœ¼ë©´ ì œëª© ê¹œë¹¡ì„
                if (!document.hasFocus()) {
                    unreadCount++;
                    console.log('ì½ì§€ ì•Šì€ ë©”ì‹œì§€:', unreadCount, 'ì œëª© ê¹œë¹¡ì„ ì‹œì‘');
                    startTitleBlink();
                } else {
                    console.log('í˜ì´ì§€ê°€ í¬ì»¤ìŠ¤ ìƒíƒœë¼ ì œëª© ê¹œë¹¡ì„ ì•ˆ í•¨');
                }

                // ë¸Œë¼ìš°ì € í‘¸ì‹œ ì•Œë¦¼ (HTTPSì¼ ë•Œë§Œ ì‘ë™)
                showChatNotification(msg.username, msg.message);
            }
        });

        // ì‚¬ìš©ì ì…ì¥
        socket.on('user_joined', (data) => {
            if (data.username !== username) {
                addSystemMessage(`${data.username}ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤.`);
            }
        });

        // ì‚¬ìš©ì í‡´ì¥
        socket.on('user_left', (data) => {
            if (data.username !== username) {
                addSystemMessage(`${data.username}ë‹˜ì´ í‡´ì¥í–ˆìŠµë‹ˆë‹¤.`);
            }
        });

        // íƒ€ì´í•‘ ì‹œì‘
        socket.on('user_typing_start', (data) => {
            if (data.username !== username) {
                typingUser.textContent = data.username;
                typingIndicator.classList.add('show');
                scrollToBottom();
            }
        });

        // íƒ€ì´í•‘ ì¤‘ì§€
        socket.on('user_typing_stop', (data) => {
            if (data.username !== username) {
                typingIndicator.classList.remove('show');
            }
        });

        function displayMessage(msg, chatParticipants) {
            const messageDiv = document.createElement('div');
            const isOwn = msg.username === username;

            // ì´ëª¨ì§€ë§Œ ìˆëŠ”ì§€ ì²´í¬ (ê³µë°± ì œê±° í›„ ì²´í¬)
            const trimmedMsg = msg.message.trim();
            const emojiOnlyRegex = /^[\p{Emoji}\u200d]+$/u;
            const isEmojiOnly = emojiOnlyRegex.test(trimmedMsg) && !msg.file_info;

            messageDiv.className = `message ${isOwn ? 'own' : 'other'} ${isEmojiOnly ? 'emoji-only-message' : ''}`;

            const time = new Date(msg.timestamp).toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit'
            });

            // ì½ì§€ ì•Šì€ ì‚¬ëŒ ìˆ˜ ê³„ì‚°
            let unreadCount = 0;
            if (isOwn && chatParticipants) {
                const readBy = msg.read_by || [msg.username];
                const totalParticipants = chatParticipants.length;
                const readCount = readBy.length;
                unreadCount = totalParticipants - readCount;
                console.log('ì½ìŒ í‘œì‹œ ê³„ì‚°:', {
                    message: msg.message,
                    totalParticipants,
                    readBy,
                    readCount,
                    unreadCount
                });
            }

            const unreadBadge = (isOwn && unreadCount > 0)
                ? `<span class="read-count">${unreadCount}</span>`
                : '';

            // íŒŒì¼ ì²¨ë¶€ í‘œì‹œ
            let fileHtml = '';

            // file_info í˜•ì‹ (ì‹¤ì‹œê°„ ì „ì†¡ëœ íŒŒì¼)
            if (msg.file_info && msg.file_info.length > 0) {
                fileHtml = msg.file_info.map(file => {
                    const isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(file.filename);
                    if (isImage) {
                        return `
                            <div class="message-file" onclick="openImageModal('${file.url}', '${escapeHtml(file.filename)}')">
                                <img src="${file.url}" alt="${escapeHtml(file.filename)}">
                            </div>
                        `;
                    } else {
                        const fileSize = (file.size / 1024).toFixed(1) + ' KB';
                        return `
                            <div class="message-file document" onclick="window.open('${file.url}', '_blank')">
                                <span>ğŸ“„</span>
                                <div>
                                    <div>${escapeHtml(file.filename)}</div>
                                    <small style="opacity: 0.7;">${fileSize}</small>
                                </div>
                            </div>
                        `;
                    }
                }).join('');
            }
            // file_path í˜•ì‹ (DBì—ì„œ ë¡œë“œëœ íŒŒì¼)
            else if (msg.file_path && msg.file_name) {
                const isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(msg.file_name);
                if (isImage) {
                    fileHtml = `
                        <div class="message-file" onclick="openImageModal('${msg.file_path}', '${escapeHtml(msg.file_name)}')">
                            <img src="${msg.file_path}" alt="${escapeHtml(msg.file_name)}">
                        </div>
                    `;
                } else {
                    fileHtml = `
                        <div class="message-file document" onclick="window.open('${msg.file_path}', '_blank')">
                            <span>ğŸ“„</span>
                            <div>
                                <div>${escapeHtml(msg.file_name)}</div>
                            </div>
                        </div>
                    `;
                }
            }

            messageDiv.innerHTML = `
                ${!isOwn ? `<div class="message-header">${msg.username}</div>` : ''}
                <div class="message-text ${isEmojiOnly ? 'emoji-only' : ''}">${escapeHtml(msg.message)}</div>
                ${fileHtml}
                <div class="message-time">${unreadBadge}${time}</div>
            `;

            messagesDiv.appendChild(messageDiv);
        }

        function addSystemMessage(text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system-message';
            messageDiv.textContent = text;
            messagesDiv.appendChild(messageDiv);
            scrollToBottom();
        }

        function scrollToBottom() {
            // requestAnimationFrameìœ¼ë¡œ DOM ë Œë”ë§ ì™„ë£Œ í›„ ìŠ¤í¬ë¡¤
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                });
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ì´ë¯¸ì§€ ëª¨ë‹¬ ì—´ê¸°
        function openImageModal(imageSrc, filename) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('imageModalImg');
            const filenameDiv = document.getElementById('imageModalFilename');

            modal.style.display = 'block';
            modalImg.src = imageSrc;
            filenameDiv.textContent = filename;
        }

        // ì´ë¯¸ì§€ ëª¨ë‹¬ ë‹«ê¸°
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.style.display = 'none';
        }

        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeImageModal();
            }
        });

        // ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸ ìˆ˜ì‹ 
        socket.on('read_receipt_update', (data) => {
            console.log('ì½ìŒ ìƒíƒœ ì—…ë°ì´íŠ¸:', data);
            // ë©”ì‹œì§€ ëª©ë¡ì„ ë‹¤ì‹œ ë¡œë“œí•˜ì—¬ ì½ìŒ í‘œì‹œ ì—…ë°ì´íŠ¸
            fetch('/api/chats')
                .then(res => res.json())
                .then(chats => {
                    const chat = chats[chatId];
                    if (chat && chat.messages) {
                        messagesDiv.innerHTML = '';
                        chat.messages.forEach(msg => {
                            displayMessage(msg, chatParticipants);
                        });
                        scrollToBottom();
                    }
                });
        });

        // í˜ì´ì§€ í¬ì»¤ìŠ¤ì‹œ ì½ìŒ ì²˜ë¦¬
        window.addEventListener('focus', () => {
            socket.emit('mark_as_read', {
                chat_id: chatId,
                username: username
            });
        });

        // í˜ì´ì§€ ë– ë‚  ë•Œ ë°© ë‚˜ê°€ê¸°
        window.addEventListener('beforeunload', () => {
            socket.emit('leave', { chat_id: chatId, username: username });
        });

        // ì´ëª¨ì§€ í”¼ì»¤ ê¸°ëŠ¥
        const emojiBtn = document.getElementById('emojiBtn');
        const emojiPicker = document.getElementById('emojiPicker');
        const emojiGrid = document.getElementById('emojiGrid');

        // ìì£¼ ì‚¬ìš©í•˜ëŠ” ì´ëª¨ì§€ ëª©ë¡
        const emojis = [
            'ğŸ˜€', 'ğŸ˜', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜…', 'ğŸ˜†', 'ğŸ˜‰', 'ğŸ˜Š',
            'ğŸ˜‹', 'ğŸ˜', 'ğŸ˜', 'ğŸ˜˜', 'ğŸ¥°', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ™‚', 'ğŸ¤—',
            'ğŸ¤©', 'ğŸ¤”', 'ğŸ¤¨', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¶', 'ğŸ™„', 'ğŸ˜', 'ğŸ˜£', 'ğŸ˜¥',
            'ğŸ˜®', 'ğŸ¤', 'ğŸ˜¯', 'ğŸ˜ª', 'ğŸ˜«', 'ğŸ˜´', 'ğŸ˜Œ', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ˜',
            'ğŸ¤¤', 'ğŸ˜’', 'ğŸ˜“', 'ğŸ˜”', 'ğŸ˜•', 'ğŸ™ƒ', 'ğŸ¤‘', 'ğŸ˜²', 'â˜¹ï¸', 'ğŸ™',
            'ğŸ˜–', 'ğŸ˜', 'ğŸ˜Ÿ', 'ğŸ˜¤', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜¨', 'ğŸ˜©',
            'ğŸ¤¯', 'ğŸ˜¬', 'ğŸ˜°', 'ğŸ˜±', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜³', 'ğŸ¤ª', 'ğŸ˜µ', 'ğŸ˜¡',
            'ğŸ˜ ', 'ğŸ¤¬', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ˜‡', 'ğŸ¤ ',
            'ğŸ¥³', 'ğŸ¥´', 'ğŸ¥º', 'ğŸ¤¥', 'ğŸ¤«', 'ğŸ¤­', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜ˆ', 'ğŸ‘¿',
            'ğŸ‘‹', 'ğŸ¤š', 'ğŸ–ï¸', 'âœ‹', 'ğŸ––', 'ğŸ‘Œ', 'ğŸ¤', 'âœŒï¸', 'ğŸ¤', 'ğŸ¤Ÿ',
            'ğŸ¤˜', 'ğŸ¤™', 'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ‘†', 'ğŸ–•', 'ğŸ‘‡', 'â˜ï¸', 'ğŸ‘', 'ğŸ‘',
            'âœŠ', 'ğŸ‘Š', 'ğŸ¤›', 'ğŸ¤œ', 'ğŸ‘', 'ğŸ™Œ', 'ğŸ‘', 'ğŸ¤²', 'ğŸ¤', 'ğŸ™',
            'ğŸ’ª', 'ğŸ¦¾', 'ğŸ¦¿', 'ğŸ¦µ', 'ğŸ¦¶', 'ğŸ‘‚', 'ğŸ¦»', 'ğŸ‘ƒ', 'ğŸ§ ', 'ğŸ¦·',
            'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ¤', 'ğŸ’”',
            'â£ï¸', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–', 'ğŸ’˜', 'ğŸ’', 'ğŸ’Ÿ', 'â˜®ï¸',
            'âœ¨', 'â­', 'ğŸŒŸ', 'ğŸ’«', 'âœ”ï¸', 'âœ…', 'âŒ', 'â', 'âš ï¸', 'ğŸ”¥'
        ];

        // ì´ëª¨ì§€ ê·¸ë¦¬ë“œ ìƒì„±
        emojis.forEach(emoji => {
            const emojiItem = document.createElement('div');
            emojiItem.className = 'emoji-item';
            emojiItem.textContent = emoji;
            emojiItem.onclick = () => {
                messageInput.value += emoji;
                messageInput.focus();
                emojiPicker.classList.remove('show');
            };
            emojiGrid.appendChild(emojiItem);
        });

        // ì´ëª¨ì§€ ë²„íŠ¼ í´ë¦­
        emojiBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            emojiPicker.classList.toggle('show');
        });

        // ì´ëª¨ì§€ í”¼ì»¤ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        document.addEventListener('click', (e) => {
            if (!emojiPicker.contains(e.target) && e.target !== emojiBtn) {
                emojiPicker.classList.remove('show');
            }
        });

        // íŒŒì¼ ì—…ë¡œë“œ ê¸°ëŠ¥
        const fileInput = document.getElementById('fileInput');
        const attachBtn = document.getElementById('attachBtn');
        const filePreview = document.getElementById('filePreview');
        let selectedFiles = [];

        // ì²¨ë¶€ ë²„íŠ¼ í´ë¦­ì‹œ íŒŒì¼ ì„ íƒì°½ ì—´ê¸°
        attachBtn.addEventListener('click', () => {
            fileInput.click();
        });

        // íŒŒì¼ ì„ íƒì‹œ
        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                if (file.size > 50 * 1024 * 1024) {
                    alert(`${file.name}ì€(ëŠ”) 50MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`);
                    return;
                }
                selectedFiles.push(file);
                displayFilePreview(file);
            });
            fileInput.value = ''; // ê°™ì€ íŒŒì¼ ë‹¤ì‹œ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡
        });

        // íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
        function displayFilePreview(file) {
            filePreview.classList.add('show');
            const previewItem = document.createElement('div');
            previewItem.className = 'file-preview-item';

            const isImage = file.type.startsWith('image/');
            if (isImage) {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                previewItem.appendChild(img);
            }

            const fileName = document.createElement('span');
            fileName.textContent = file.name;
            previewItem.appendChild(fileName);

            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-file';
            removeBtn.textContent = 'Ã—';
            removeBtn.onclick = () => {
                selectedFiles = selectedFiles.filter(f => f !== file);
                previewItem.remove();
                if (selectedFiles.length === 0) {
                    filePreview.classList.remove('show');
                }
            };
            previewItem.appendChild(removeBtn);

            filePreview.appendChild(previewItem);
        }

        // í´ë¦½ë³´ë“œ ë¶™ì—¬ë„£ê¸° (Ctrl+V)
        document.addEventListener('paste', async (e) => {
            const items = e.clipboardData.items;

            for (let item of items) {
                // ì´ë¯¸ì§€ ë¶™ì—¬ë„£ê¸°
                if (item.type.startsWith('image/')) {
                    e.preventDefault();
                    const file = item.getAsFile();
                    if (file) {
                        selectedFiles.push(file);
                        displayFilePreview(file);
                    }
                }
            }
        });

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­
        messagesDiv.addEventListener('dragover', (e) => {
            e.preventDefault();
            messagesDiv.style.background = '#f0f0f0';
        });

        messagesDiv.addEventListener('dragleave', () => {
            messagesDiv.style.background = '';
        });

        messagesDiv.addEventListener('drop', (e) => {
            e.preventDefault();
            messagesDiv.style.background = '';

            const files = Array.from(e.dataTransfer.files);
            files.forEach(file => {
                if (file.size > 50 * 1024 * 1024) {
                    alert(`${file.name}ì€(ëŠ”) 50MBë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤.`);
                    return;
                }
                selectedFiles.push(file);
                displayFilePreview(file);
            });
        });

        // ë©”ì‹œì§€ ì „ì†¡ (íŒŒì¼ í¬í•¨)
        async function sendMessageWithFiles() {
            const message = messageInput.value.trim();

            if (!message && selectedFiles.length === 0) return;

            // íŒŒì¼ ì—…ë¡œë“œ
            const fileInfos = [];
            for (let file of selectedFiles) {
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const fileInfo = await response.json();
                        fileInfos.push(fileInfo);
                    } else {
                        alert(`${file.name} ì—…ë¡œë“œ ì‹¤íŒ¨`);
                    }
                } catch (error) {
                    console.error('íŒŒì¼ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                    alert(`${file.name} ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ`);
                }
            }

            // ë©”ì‹œì§€ ì „ì†¡
            socket.emit('send_message', {
                chat_id: chatId,
                username: username,
                message: message || 'íŒŒì¼ ì „ì†¡',
                file_info: fileInfos.length > 0 ? fileInfos : null
            });

            // ì´ˆê¸°í™”
            messageInput.value = '';
            selectedFiles = [];
            filePreview.innerHTML = '';
            filePreview.classList.remove('show');
        }

        // PWA ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/static/service-worker.js')
                .then(registration => {
                    console.log('Service Worker ë“±ë¡ ì„±ê³µ:', registration.scope);
                })
                .catch(error => {
                    console.log('Service Worker ë“±ë¡ ì‹¤íŒ¨:', error);
                });
        }
</script>

<!-- ì´ë¯¸ì§€ ëª¨ë‹¬ íŒì—… -->
<div id="imageModal" class="image-modal" onclick="closeImageModal()">
    <span class="image-modal-close">&times;</span>
    <div class="image-modal-content" onclick="event.stopPropagation()">
        <img id="imageModalImg" src="" alt="">
    </div>
    <div class="image-modal-filename" id="imageModalFilename"></div>
</div>

</body>
</html>
