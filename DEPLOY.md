# CRM ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ê°€ì´ë“œ

**ë²„ì „**: 1.5.0
**ìµœì¢… ìˆ˜ì •**: 2025-12-13

---

## ì•„í‚¤í…ì²˜ ê°œìš”

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Nginx (:5000)  â”‚
                    â”‚   ip_hash LB    â”‚
                    â”‚   SSL ì¢…ë£Œ      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                             â”‚
              â–¼                             â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ Gunicorn (:5001) â”‚          â”‚ Gunicorn (:5002) â”‚
   â”‚  eventlet, 1 wkr â”‚          â”‚  eventlet, 1 wkr â”‚
   â”‚  1000 conn/wkr   â”‚          â”‚  1000 conn/wkr   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                             â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â–¼
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚    Redis    â”‚
                     â”‚   Pub/Sub   â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**íŠ¹ì§•:**
- ì´ì¤‘ ì¸ìŠ¤í„´ìŠ¤ë¡œ ë¬´ì¤‘ë‹¨ ì„œë¹„ìŠ¤ ê°€ëŠ¥
- Redis Pub/Subë¡œ WebSocket ë©”ì‹œì§€ ë™ê¸°í™”
- ip_hashë¡œ ë™ì¼ ì‚¬ìš©ìëŠ” ë™ì¼ ì„œë²„ ìœ ì§€ (sticky session)
- 40-70ëª… ë™ì‹œ ì ‘ì† ì²˜ë¦¬ ê°€ëŠ¥

---

## ğŸš€ ë¹ ë¥¸ ì‹œì‘

### ì„œë¹„ìŠ¤ ê´€ë¦¬ ëª…ë ¹ì–´

```bash
cd /svc/was/crm/crm-webapp

# ìƒíƒœ í™•ì¸
./scripts/status.sh

# ì‹œì‘ (ì¤‘ì§€ëœ ê²½ìš°)
./scripts/start.sh

# ë¬´ì¤‘ë‹¨ ì¬ì‹œì‘ (ì½”ë“œ ë°°í¬ í›„)
./scripts/restart.sh

# ì™„ì „ ì¤‘ì§€
./scripts/stop.sh
```

### ë¡œê·¸ í™•ì¸

```bash
# ì‹¤ì‹œê°„ ë¡œê·¸
tail -f logs/access_5001.log
tail -f logs/error_5001.log

# ë‘ ì¸ìŠ¤í„´ìŠ¤ ì—ëŸ¬ ë¡œê·¸ ë™ì‹œ í™•ì¸
tail -f logs/error_*.log
```

---

## ğŸ“¦ ì„¤ì¹˜ ë° ì´ˆê¸° ì„¤ì •

### 1ë‹¨ê³„: íŒ¨í‚¤ì§€ ì„¤ì¹˜

```bash
cd /svc/was/crm/crm-webapp
pip install -r requirements.txt
```

### 2ë‹¨ê³„: ë””ë ‰í† ë¦¬ ì¤€ë¹„

```bash
mkdir -p logs uploads
chmod 755 logs uploads
```

### 3ë‹¨ê³„: Redis í™•ì¸

```bash
redis-cli ping
# PONG ì‘ë‹µ í™•ì¸
```

### 4ë‹¨ê³„: ì„œë¹„ìŠ¤ ì‹œì‘

```bash
./scripts/start.sh
```

### 5ë‹¨ê³„: ìƒíƒœ í™•ì¸

```bash
./scripts/status.sh
```

---

## âš™ï¸ ì„¤ì • íŒŒì¼

### Gunicorn ì„¤ì • (gunicorn_config_500X.py)

| ì„¤ì • | ê°’ | ì„¤ëª… |
|------|-----|------|
| worker_class | eventlet | Socket.IO ì§€ì› |
| workers | 1 | eventletì€ ë‹¨ì¼ ì›Œì»¤ ê¶Œì¥ |
| worker_connections | 1000 | ì¸ìŠ¤í„´ìŠ¤ë‹¹ ìµœëŒ€ ì—°ê²° |
| max_requests | 50000 | ì›Œì»¤ ì¬ì‹œì‘ ì£¼ê¸° |
| graceful_timeout | 30 | ì •ìƒ ì¢…ë£Œ ëŒ€ê¸° ì‹œê°„ |
| timeout | 120 | ìš”ì²­ íƒ€ì„ì•„ì›ƒ |

### Nginx upstream ì„¤ì •

```nginx
upstream crm_backend {
    ip_hash;  # sticky session
    server 127.0.0.1:5001 max_fails=3 fail_timeout=30s;
    server 127.0.0.1:5002 max_fails=3 fail_timeout=30s;
    keepalive 32;
}
```

---

## ğŸ”„ ë°°í¬ ì ˆì°¨

### ì½”ë“œ ì—…ë°ì´íŠ¸ í›„ ë¬´ì¤‘ë‹¨ ì¬ë°°í¬

```bash
cd /svc/was/crm/crm-webapp

# 1. ì½”ë“œ ì—…ë°ì´íŠ¸
git pull origin main

# 2. ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ (í•„ìš”ì‹œ)
pip install -r requirements.txt --upgrade

# 3. ë¬´ì¤‘ë‹¨ ë¡¤ë§ ì¬ì‹œì‘
./scripts/restart.sh
```

**ì¬ì‹œì‘ í”„ë¡œì„¸ìŠ¤:**
1. 5002 ì¸ìŠ¤í„´ìŠ¤ ì¢…ë£Œ â†’ ì‹œì‘ â†’ í—¬ìŠ¤ì²´í¬
2. 5001 ì¸ìŠ¤í„´ìŠ¤ ì¢…ë£Œ â†’ ì‹œì‘ â†’ í—¬ìŠ¤ì²´í¬
3. ì„œë¹„ìŠ¤ ì¤‘ë‹¨ ì—†ìŒ

---

## ğŸ› ë¬¸ì œ í•´ê²°

### ì¸ìŠ¤í„´ìŠ¤ê°€ í•˜ë‚˜ë§Œ ì‹¤í–‰ ì¤‘

```bash
# ìƒíƒœ í™•ì¸
./scripts/status.sh

# ìˆ˜ë™ìœ¼ë¡œ ëˆ„ë½ëœ ì¸ìŠ¤í„´ìŠ¤ í™•ì¸
ss -tlnp | grep -E "500[12]"

# ì¬ì‹œì‘ìœ¼ë¡œ ë³µêµ¬
./scripts/restart.sh
```

### íŠ¹ì • ì¸ìŠ¤í„´ìŠ¤ë§Œ ì¬ì‹œì‘

```bash
# 5002ë§Œ ì¬ì‹œì‘ (5001ì€ ìœ ì§€)
cd /svc/was/crm/crm-webapp

# 5002 ì¢…ë£Œ
kill $(lsof -ti :5002)

# 5002 ì‹œì‘
/home/haruhome/miniconda3/bin/gunicorn -c gunicorn_config_5002.py app:app --daemon
```

### Redis ì—°ê²° ì‹¤íŒ¨

```bash
# Redis ìƒíƒœ í™•ì¸
redis-cli ping

# Redis ì¬ì‹œì‘ (í•„ìš”ì‹œ)
systemctl restart redis
```

### WebSocket ì—°ê²° ë¬¸ì œ

1. Nginx ì„¤ì • í™•ì¸ (proxy_set_header Upgrade)
2. Redis Pub/Sub ì—°ê²° í™•ì¸
3. ë¸Œë¼ìš°ì € ì½˜ì†”ì—ì„œ Socket.IO ì—ëŸ¬ í™•ì¸

---

## ğŸ“Š ëª¨ë‹ˆí„°ë§

### ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰

```bash
# í”„ë¡œì„¸ìŠ¤ë³„ CPU/ë©”ëª¨ë¦¬
ps aux | grep gunicorn

# ì—°ê²° ìˆ˜ í™•ì¸
ss -tn | grep -c ":5001"
ss -tn | grep -c ":5002"
```

### ë¡œê·¸ ë¶„ì„

```bash
# ì‹œê°„ëŒ€ë³„ ì ‘ì† í†µê³„
cat logs/access_5001.log | cut -d' ' -f4 | cut -d':' -f2 | sort | uniq -c

# ì—ëŸ¬ ê±´ìˆ˜ í™•ì¸
grep -c ERROR logs/error_5001.log
```

---

## âœ… ë°°í¬ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] requirements.txt íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ
- [ ] Redis ì„œë²„ ì‹¤í–‰ ì¤‘
- [ ] ë‘ ì¸ìŠ¤í„´ìŠ¤ ëª¨ë‘ ì‹¤í–‰ ì¤‘ (status.shë¡œ í™•ì¸)
- [ ] Nginx ë¡œë“œë°¸ëŸ°ì„œ ì„¤ì • ì™„ë£Œ
- [ ] ì›¹ ë¸Œë¼ìš°ì € ì ‘ì† í…ŒìŠ¤íŠ¸ ì™„ë£Œ
- [ ] ì±„íŒ… ì‹¤ì‹œê°„ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ì™„ë£Œ
- [ ] ë¬´ì¤‘ë‹¨ ì¬ì‹œì‘ í…ŒìŠ¤íŠ¸ ì™„ë£Œ

---

## ì ‘ì† URL

- **ì§ì ‘ ì ‘ì†**: https://haruittl.asuscomm.com:5000/
- **ì„œë¸Œ ê²½ë¡œ**: https://haruittl.asuscomm.com/crm-webapp/
- **API ë¬¸ì„œ**: https://haruittl.asuscomm.com:5000/api/docs/
